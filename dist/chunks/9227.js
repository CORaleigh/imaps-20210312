(self.webpackChunkimaps=self.webpackChunkimaps||[]).push([[9227],{12587:(e,t,i)=>{"use strict";i.d(t,{S:()=>d,b:()=>c});var r=i(85461),a=i(62213),s=i(51219),n=i(63230),o=i(61514),l=i(34658),h=i(20147);function c(e){const t=new s.kG;return t.include(a.w,{linearDepth:!1}),t.include(h.A.builder,{}),t.include(o.p,e),t.fragment.include(n.Y),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.fragment.uniforms.add("color","vec4"),t.attributes.add("position","vec3"),t.varyings.add("vWorldPosition","vec3"),e.screenSizeEnabled&&t.attributes.add("offset","vec3"),e.shadingEnabled&&(t.vertex.uniforms.add("viewNormal","mat4"),t.fragment.uniforms.add("shadedColor","vec4").add("shadingDirection","vec3"),t.attributes.add("normal","vec3"),t.varyings.add("vViewNormal","vec3")),t.vertex.code.add(r.H`
    void main(void) {
      vWorldPosition = ${e.screenSizeEnabled?"screenSizeScaling(offset, position)":"position"};
  `),e.shadingEnabled&&t.vertex.code.add(r.H`
      vec3 worldNormal = normal;
      vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;
    `),t.vertex.code.add(r.H`
    gl_Position = transformPosition(proj, view, vWorldPosition);
  }
  `),t.fragment.code.add(r.H`
    void main() {
      discardBySlice(vWorldPosition);
    `),e.shadingEnabled?t.fragment.code.add(r.H`
      vec3 viewNormalNorm = normalize(vViewNormal);
      float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
      vec4 finalColor = mix(color, shadedColor, shadingFactor);
    `):t.fragment.code.add(r.H`
      vec4 finalColor = color;
    `),t.fragment.code.add(r.H`
      if (finalColor.a < ${r.H.float(l.bf)}) {
        discard;
      }
      ${7===e.output?r.H`gl_FragColor = vec4(finalColor.a);`:""}

      ${0===e.output?r.H`gl_FragColor = highlightSlice(finalColor, vWorldPosition); ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    }
    `),t}var d=Object.freeze({__proto__:null,build:c})},54452:(e,t,i)=>{"use strict";i.d(t,{T:()=>o,b:()=>n});var r=i(85461),a=i(51219),s=i(84444);function n(){const e=new a.kG;return e.include(s.k),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("color","vec4"),e.fragment.code.add(r.H`
    void main() {
      vec4 texColor = texture2D(tex, uv);
      gl_FragColor = texColor * color;
    }
  `),e}var o=Object.freeze({__proto__:null,build:n})},74332:(e,t,i)=>{"use strict";i.d(t,{W:()=>f,b:()=>m});var r=i(85461),a=i(62213),s=i(51219),n=i(63230),o=i(61514),l=i(72023),h=i(34658),c=i(71613),d=i(91123),u=i(31777),p=i(83917),g=i(53584);function m(e){const t=new s.kG;return t.include(a.w,{linearDepth:!1}),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),0!==e.output&&7!==e.output||(t.include(p.n,e),t.include(u.q,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),t.vertex.code.add(r.H`
      void main(void) {
        if (waterColor.a < ${r.H.float(h.bf)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        gl_Position = transformPosition(proj, view, vpos);
        ${0===e.output?"forwardLinearDepth();":""}
      }
    `)),7===e.output&&(t.include(o.p,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(r.H`
        void main() {
          discardBySlice(vpos);

          gl_FragColor = vec4(waterColor.a);
        }
      `)),0===e.output&&(t.include(d.M,e),t.include(o.p,e),e.receiveShadows&&t.include(c.h,e),t.include(g.B,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(n.Y),t.fragment.code.add(r.H`
      void main() {
        discardBySlice(vpos);
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - camPos);
        vec3 l = normalize(-lightingMainDirection);
        float shadow = ${e.receiveShadows?r.H`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, l, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),2===e.output&&(t.include(p.n,e),t.include(d.M,e),t.include(o.p,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(r.H`
        void main(void) {
          if (waterColor.a < ${r.H.float(h.bf)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(r.H`
        void main() {
          discardBySlice(vpos);

          // the created normal is in tangent space and foam
          vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
          tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);

          gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
        }
    `)),5===e.output&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(r.H`
        void main(void) {
          if (waterColor.a < ${r.H.float(h.bf)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(r.H`
        void main() {
          gl_FragColor = waterColor;
        }
    `)),4===e.output&&(t.include(l.b),t.varyings.add("vpos","vec3"),t.vertex.code.add(r.H`
      void main(void) {
        if (waterColor.a < ${r.H.float(h.bf)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(o.p,e),t.fragment.code.add(r.H`
      void main() {
        discardBySlice(vpos);
        outputHighlight();
      }
    `)),t}var f=Object.freeze({__proto__:null,build:m})},82204:(e,t,i)=>{"use strict";i.d(t,{d:()=>a});var r=i(33655);function a(e,t,i){const a=e.byteLength/(4*t),h=new Uint32Array(e,0,a*t);let c=new Uint32Array(a);const d=i&&i.minReduction||0,u=i&&i.originalIndices||null,p=i&&i.componentOffsets||null;let g=0;if(p)for(let e=0;e<p.length-1;e++){const t=p[e+1]-p[e];t>g&&(g=t)}else g=a;const m=Math.floor(1.1*g)+1;(null==l||l.length<2*m)&&(l=new Uint32Array((0,r.Sf)(2*m)));for(let e=0;e<2*m;e++)l[e]=0;let f=0;const _=!!p&&!!u,v=_?u.length:a,y=_?new Uint32Array(u.length):null,w=1.96;let b=0!==d?Math.ceil(4*w*w/(d*d)*d*(1-d)):v,M=1,x=p?p[1]:v;for(let e=0;e<v;e++){if(e===b){const t=1-f/e;if(t+w*Math.sqrt(t*(1-t)/e)<d)return null;b*=2}if(e===x){for(let e=0;e<2*m;e++)l[e]=0;if(u)for(let e=p[M-1];e<p[M];e++)y[e]=c[u[e]];x=p[++M]}const i=_?u[e]:e,r=i*t,a=o(h,r,t);let n=a%m,g=f;for(;0!==l[2*n+1];){if(l[2*n]===a){const e=l[2*n+1]-1;if(s(h,r,e*t,t)){g=c[e];break}}n++,n>=m&&(n-=m)}g===f&&(l[2*n]=a,l[2*n+1]=i+1,f++),c[i]=g}if(0!==d&&1-f/a<d)return null;if(_){for(let e=p[M-1];e<y.length;e++)y[e]=c[u[e]];c=y}const S=new Uint32Array(t*f);f=0;for(let e=0;e<v;e++)c[e]===f&&(n(h,(_?u[e]:e)*t,S,f*t,t),f++);if(u&&!_){const e=new Uint32Array(u.length);for(let t=0;t<e.length;t++)e[t]=c[u[t]];c=e}return{buffer:S.buffer,indices:c,uniqueCount:f}}function s(e,t,i,r){for(let a=0;a<r;a++)if(e[t+a]!==e[i+a])return!1;return!0}function n(e,t,i,r,a){for(let s=0;s<a;s++)i[r+s]=e[t+s]}function o(e,t,i){let r=0;for(let a=0;a<i;a++)r=e[t+a]+r|0,r=r+(r<<11)+(r>>>2)|0;return r>>>0}let l=null},83873:(e,t,i)=>{"use strict";function r(e,t){return t?"xoffset"in t&&t.xoffset?Math.max(e,Math.abs(t.xoffset)):"yoffset"in t&&t.yoffset?Math.max(e,Math.abs(t.yoffset||0)):e:e}function a(e,t){return"number"==typeof e?e:e&&e.stops&&e.stops.length?function(e){let t=0,i=0;for(let r=0;r<e.length;r++){const a=e[r].size;"number"==typeof a&&(t+=a,i++)}return t/i}(e.stops):t}function s(e){const t=e&&e.renderer,i="touch"===(e&&e.event&&e.event.pointerType)?9:6;if(!t)return i;const s="visualVariables"in t?function(e,t){if(!t)return e;const i=t.filter((e=>"size"===e.type)).map((t=>{const{maxSize:i,minSize:r}=t;return(a(i,e)+a(r,e))/2}));let r=0;const s=i.length;if(0===s)return e;for(let e=0;e<s;e++)r+=i[e];const n=Math.floor(r/s);return Math.max(n,e)}(i,t.visualVariables):i;if("simple"===t.type)return r(s,t.symbol);if("unique-value"===t.type){let e=s;return t.uniqueValueInfos.forEach((t=>{e=r(e,t.symbol)})),e}if("class-breaks"===t.type){let e=s;return t.classBreakInfos.forEach((t=>{e=r(e,t.symbol)})),e}return t.type,s}i.d(t,{k:()=>s})},69227:(e,t,i)=>{"use strict";i.r(t),i.d(t,{DrawGraphicTool:()=>ir,DrawOperation:()=>r.w,GraphicMoveTool:()=>Fa,GraphicReshapeTool:()=>es,GraphicTransformTool:()=>ls});var r=i(88958),a=i(56140),s=i(95830),n=i(59472),o=i(36544),l=(i(68055),i(79881)),h=i(87566),c=(i(10923),i(57002),i(86035),i(35470)),d=i(15988),u=i(94394),p=i(46970),g=i(84678),m=i(56279),f=i(9434),_=i(48016),v=i(78745),y=i(43019),w=i(38256),b=(i(5627),i(8634)),M=i(84570);i(89930);class x{constructor(){this.cache=new Map}dispose(){this.cache.forEach((e=>{(0,n.pC)(e.texture)&&(e.texture.dispose(),e.texture=null)})),this.cache.clear()}acquire(e){if((0,n.Wi)(e))return null;const t=this.patternId(e),i=this.cache.get(t);if(i)return i.refCount++,i.bind;const r=this.patternToTextureData(e,2),a=r.length/2,s={refCount:1,texture:null,bind:(e,t)=>((0,n.Wi)(s.texture)&&(s.texture=new b.Z(e,{width:r.length,height:1,internalFormat:6406,pixelFormat:6406,dataType:5121,wrapMode:33071},r)),e.bindTexture(s.texture,t),a)};return this.cache.set(t,s),s.bind}release(e){if((0,n.Wi)(e))return;const t=this.patternId(e),i=this.cache.get(t);i&&(i.refCount--,0===i.refCount&&((0,n.pC)(i.texture)&&i.texture.dispose(),this.cache.delete(t)))}swap(e,t){const i=this.acquire(t);return this.release(e),i}patternId(e){return e.join(",")}patternToTextureData(e,t){const i=e.reduce(((e,t)=>e+t))*t,r=new Uint8Array(i);let a=!0,s=0;for(const i of e){for(let e=0;e<i*t;e++)r[s++]=a?255:0;a=!a}return r}}function S(e){return(0,n.Wi)(e)?e:e.slice()}const C={main:new v.default([255,127,0]),selected:new v.default([255,255,255]),staged:new v.default([12,207,255]),outline:new v.default([0,0,0,.5]),selectedOutline:new v.default([255,255,255])};function R(e,t){const i=e.clone();return i.a*=t,i}function E(e,t){const i=e.clone(),r=(0,y._Y)(i);r.s*=t;const a=(0,y.xr)(r);return i.r=a.r,i.g=a.g,i.b=a.b,i}function D(e,t){if(t)for(const i in t)e[i]=t[i]}class O{constructor(e){this.color=C.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=16,D(this,e)}}class T{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=C.main,this.outlineColor=C.outline,this.renderOccluded=16,this.hoverOutlineColor=C.selectedOutline,D(this,e)}apply(e,t){const i=this[e];t.setParameterValues({color:W(i),transparent:"color"!==e||i.a<1,renderOccluded:this.renderOccluded})}}class P{constructor(e){this.vertex=new T({color:C.main,outlineColor:C.outline}),this.edge=new T({color:E(R(C.main,2/3),.5),outlineColor:R(C.outline,.5),size:8,collisionPadding:8}),this.selected=new T({color:C.selected,outlineColor:C.outline}),D(this,e)}}class A{constructor(e){this.color=C.selected,this.width=1.5,this.stipplePattern=S([5,5]),this.stippleOffColor=C.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=C.selected,this.renderOccluded=4,D(this,e)}apply(e){e.color=W(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=W(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=W(this.innerColor),e.renderOccluded=this.renderOccluded}}class I{constructor(e){this.color=C.selected,this.size=4,this.outlineSize=1,this.outlineColor=C.outline,this.shape="square",D(this,e)}apply(e){e.color=W(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=W(this.outlineColor),e.primitive=this.shape}}class L{constructor(e){this.innerColor=C.selected,this.innerWidth=1,this.glowColor=C.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.3,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=C.main,D(this,e)}apply(e,t=1){const i={glowColor:v.default.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:v.default.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*t,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=i:e.laserlineStyle=i}}class G{constructor(e){this.outline=new A({color:C.outline,renderOccluded:8,stippleOffColor:C.selected,stipplePattern:S([5,5]),width:1.5,innerWidth:0}),this.staged=new A({color:C.selected,renderOccluded:8,innerColor:C.staged,stippleOffColor:C.outline,stipplePattern:S([5,5]),width:1.5}),this.shadowStyle=new L({globalAlpha:.3,glowColor:C.main,glowFalloff:8,glowWidth:8,innerColor:C.selected,innerWidth:1}),D(this,e)}}class V{constructor(e){this.outline=new I({color:C.selected,outlineColor:C.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new L({globalAlpha:.3,glowColor:C.main,glowFalloff:1.5,glowWidth:6,innerColor:C.selected,innerWidth:1,radius:2}),D(this,e)}}class z extends A{constructor(e){super(),this.extensionType=2,D(this,e)}}class H{constructor(e){this.lineGraphics=new G,this.pointGraphics=new V,this.heightPlane=new L({globalAlpha:.3,glowColor:C.main,glowFalloff:8,glowWidth:8,innerColor:C.selected,innerWidth:1}),this.heightBox=new L({globalAlpha:.3,glowColor:C.main,glowFalloff:8,glowWidth:8,innerColor:C.selected,innerWidth:0,heightFillColor:C.main}),this.zVerticalLine=new z({color:R(C.main,.5),falloff:2,innerColor:R(C.selected,0),renderOccluded:4,stipplePattern:null,width:5,extensionType:2}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,D(this,e)}}function W(e){return(0,w.f)(v.default.toUnitRGBA(e))}const F=new class{constructor(e){this.visualElements=new H,this.reshapeManipulators=new P,this.zManipulator=new O,D(this,e)}colorToVec4(e){return W(e)}};var j=i(77625),U=i(17387),k=i(28449),N=i(34353),Z=i(69996),B=i(1586),q=i(27898),Y=i(55197),X=i(68500),$=i(43965),K=i(57511),Q=i(17154),J=i(67128),ee=i(12811),te=i(56469),ie=i(8830),re=i(49366);const ae=class{constructor(e,t,i,r,a,s,n){this.uniqueName=null,this.shaderTransformationDirty=!0,this.data=e.toRenderData(),this.boundingInfo=t,this.material=i,this.origin=null,this.center=(0,j.c)(),this.bsRadius=0,this.transformation=null,this.calculateShaderTransformation=a,r&&this.updateTransformation(r,s),this.castShadow=n,this.instanceParameters={highlights:null,occludees:null,visible:!0}}updateTransformation(e,t){this.transformation=e,this.shaderTransformationDirty=!0,this.bsRadius=this.getBoundingSphere(e,t,this.center)}shaderTransformationChanged(){this.shaderTransformationDirty=!0}getBoundingSphere(e,t,i){return t=t||(0,Q.u1)(e),(0,U.i)(i,this.boundingInfo.getCenter(),e),this.boundingInfo.getBSRadius()*t}get hasShaderTransformation(){return!!this.calculateShaderTransformation}getShaderTransformation(){return this.calculateShaderTransformation?(this.shaderTransformationDirty&&(this.shaderTransformation||(this.shaderTransformation=(0,ee.a)()),(0,J.c)(this.shaderTransformation,this.calculateShaderTransformation((0,n.Pt)(this.transformation,ee.I))),this.shaderTransformationDirty=!1),this.shaderTransformation):(0,n.Pt)(this.transformation,ee.I)}computeAttachmentOrigin(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&((0,n.pC)(this.transformation)&&(0,U.i)(e,e,this.transformation),!0);const t=this.getIndices(te.Xt.POSITION),i=this.getAttribute(te.Xt.POSITION);return!!(0,q.cM)(i,t,e)&&((0,n.pC)(this.transformation)&&(0,U.i)(e,e,this.transformation),!0)}getIndices(e){return"indices"in this.data?this.data.indices[e]:null}getAttribute(e){return"vertexAttr"in this.data?this.data.vertexAttr[e]:null}addHighlight(){const e=(0,ie.K)(0),t=this.instanceParameters;return t.highlights=(0,re.lr)(t.highlights,e),e}removeHighlight(e){const t=this.instanceParameters;t.highlights=(0,re.U_)(t.highlights,e)}};var se=i(6962),ne=i(33655),oe=i(92232);i(82204);function le(e,t,i){const r=e.length,a=new Array(r),s=new Array(r),n=new Array(r);let o=0,l=0,h=0,c=0;for(let t=0;t<r;++t)c+=e[t].length;const d=new Float64Array(3*c);let u=0;for(let c=r-1;c>=0;c--){const p=e[c],g=1===i&&!(0,oe.bu)(p,!1,!1);if(g&&1!==r)a[o++]=p;else{let e=p.length;for(let t=0;t<o;++t)e+=a[t].length;const i={index:u,pathLengths:new Array(o+1),count:e,holeIndices:new Array(o)};i.pathLengths[0]=p.length,p.length>0&&(n[h++]={index:u,count:p.length}),u=g?he(p,p.length-1,-1,d,u,p.length,t):he(p,0,1,d,u,p.length,t);for(let e=0;e<o;++e){const r=a[e];i.holeIndices[e]=u,i.pathLengths[e+1]=r.length,r.length>0&&(n[h++]={index:u,count:r.length}),u=he(r,0,1,d,u,r.length,t)}o=0,i.count>0&&(s[l++]=i)}}for(let e=0;e<o;++e){const i=a[e];i.length>0&&(n[h++]={index:u,count:i.length}),u=he(i,0,1,d,u,i.length,t)}return l<r&&(s.length=l),h<r&&(n.length=h),{position:d,polygons:s,outlines:n}}function he(e,t,i,r,a,s,n){a*=3;for(let o=0;o<s;++o){const s=e[t];r[a++]=s[0],r[a++]=s[1],r[a++]=n?s[2]:0,t+=i}return a/3}var ce=i(69534),de=i(81718),ue=i(62698),pe=i(79152),ge=i(59691),me=i(80621),fe=i(77293),_e=i(55735),ve=i(57319),ye=i(10346);class we{constructor(e=(0,j.c)(),t=(0,j.f)(.57735,.57735,.57735),i=!0){this.intensity=e,this.direction=t,this.castShadows=i}}class be{constructor(e=(0,j.c)(),t=(0,j.f)(.57735,.57735,.57735)){this.intensity=(0,j.c)(),this.direction=(0,j.c)(),this.intensity=e,this.direction=t}}class Me{constructor(e=(0,j.c)()){this.intensity=e}}class xe{constructor(){this.sh={r:[0],g:[0],b:[0]}}}var Se=i(81495),Ce=i(96071),Re=i(14286),Ee=i(69987),De=i(88);class Oe{constructor(e=null,t=null,i=null){this._viewUp=(0,j.c)(),this._viewForward=(0,j.c)(),this._viewRight=(0,j.c)(),this._ray=De.kx.createWrapper(),this._viewport=(0,w.b)(0,0,1,1),this._padding=(0,w.b)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,_e.f)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,ee.a)(),this._projectionDirty=!0,this._projectionMatrix=(0,ee.a)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,ee.a)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,ee.a)(),this._frustumDirty=!0,this._frustum=De.oy.create(),this._fullViewport=(0,w.a)(),this._contextNavigation=!0,this.pixelRatio=1,this.relativeElevation=0,this._eye=(0,n.pC)(e)?(0,j.b)(e):(0,j.c)(),this._center=(0,n.pC)(t)?(0,j.b)(t):(0,j.c)(),this._up=(0,n.pC)(i)?(0,j.b)(i):(0,j.f)(0,0,1)}get eye(){return this._eye}set eye(e){this._compareAndSetView(e,this._eye)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center)}get ray(){return this._ray.origin=this.eye,this._ray.direction||(this._ray.direction=(0,j.c)()),(0,U.f)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){(0,J.c)(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get x(){return this._viewport[0]}set x(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(e){this.width=e-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(e){this.height=e-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){this._padding[0]===e[0]&&this._padding[1]===e[1]&&this._padding[2]===e[2]&&this._padding[3]===e[3]||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),(0,N.c)(this._padding,e),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&((0,J.m)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const e=this.width,t=this.height,i=this.near*Math.tan(this.fovY/2),r=i*this.aspect;(0,J.h)(this._projectionMatrix,-r*(1+2*this._padding[3]/e),r*(1+2*this._padding[1]/e),-i*(1+2*this._padding[2]/t),i*(1+2*this._padding[0]/t),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}set projectionMatrix(e){(0,J.c)(this._projectionMatrix,e),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(e){this._fov=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return(0,te.tM)(this._fov,this.width,this.height)}set fovX(e){this._fov=(0,te.Kj)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return(0,te.RQ)(this._fov,this.width,this.height)}set fovY(e){this._fov=(0,te.zF)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return(0,U.k)(this._center,this._eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,J.a)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,J.b)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){const t=e;return(0,U.g)(this._eye,t._eye),(0,U.g)(this._center,t._center),(0,U.g)(this._up,t._up),(0,N.c)(this._viewport,t._viewport),(0,N.c)(this._padding,t._padding),(0,Re.c)(this._nearFar,t._nearFar),this._fov=t._fov,this.relativeElevation=e.relativeElevation,this._viewDirty=t._viewDirty,this._viewDirty||((0,J.c)(this._viewMatrix,t._viewMatrix),(0,U.g)(this._viewRight,t._viewRight),(0,U.g)(this._viewUp,t._viewUp),(0,U.g)(this._viewForward,t._viewForward)),t._projectionDirty?this._projectionDirty=!0:((0,J.c)(this._projectionMatrix,t._projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(De.oy.copy(t._frustum,this._frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,J.c)(this._viewInverseTransposeMatrix,t._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,N.c)(this._fullViewport,t._fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return(new Oe).copyFrom(this)}equals(e){return(0,U.m)(this._eye,e._eye)&&(0,U.m)(this._center,e._center)&&(0,U.m)(this._up,e._up)&&(0,N.g)(this._viewport,e._viewport)&&(0,N.g)(this._padding,e._padding)&&(0,Re.k)(this._nearFar,e._nearFar)&&this._fov===e._fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}almostEquals(e){if(this.pixelRatio!==e.pixelRatio||Math.abs(e._fov-this._fov)>=.001)return!1;const t=5e-4;(0,U.r)(Ae,e._eye,e._center),(0,U.r)(Ie,this._eye,this._center);const i=(0,U.d)(Ae,Ie),r=(0,U.u)(Ae),a=(0,U.u)(Ie);return i*i>=(1-1e-10)*r*a&&(0,U.v)(e._eye,this._eye)<Math.max(r,a)*t*t&&(0,N.i)(e._padding,this._padding)<.5&&(0,N.i)(e._viewport,this._viewport)<.5}markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this.viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this.viewDirectionDistance(e))}viewDirectionDistance(e){return Math.abs((0,Ee.p)(this.viewForward,(0,U.f)(Ae,e,this._eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=(0,Ce.s1)()){return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,i=.5){return e||(e=(0,Ce.J$)()),e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*i,e.length>2&&(e[2]=.5),e}setGLViewport(e){const t=this.viewport,i=this.padding;e.setViewport(t[0]-i[3],t[1]-i[2],t[2]+i[1]+i[3],t[3]+i[0]+i[2])}applyProjection(e,t,i=!1){e!==Te&&(0,U.g)(Te,e),Te[3]=1,i&&(t[2]=-Te[2]),(0,N.t)(Te,Te,this.projectionMatrix),(0,U.a)(Te,Te,1/Math.abs(Te[3]));const r=this.fullViewport;return t[0]=(0,ne.t7)(0,r[0]+r[2],.5+.5*Te[0]),t[1]=(0,ne.t7)(0,r[1]+r[3],.5+.5*Te[1]),i||(t[2]=.5*(Te[2]+1)),t}projectToScreen(e,t){return this.projectToRenderScreen(e,Le),this.renderToScreen(Le,t)}projectToRenderScreen(e,t){if(Te[0]=e[0],Te[1]=e[1],Te[2]=e[2],Te[3]=1,(0,N.t)(Te,Te,this.viewProjectionMatrix),0===Te[3])return null;(0,U.a)(Te,Te,1/Math.abs(Te[3]));const i=this.fullViewport;return"x"in t?(t.x=(0,ne.t7)(0,i[0]+i[2],.5+.5*Te[0]),t.y=(0,ne.t7)(0,i[1]+i[3],.5+.5*Te[1])):(t[0]=(0,ne.t7)(0,i[0]+i[2],.5+.5*Te[0]),t[1]=(0,ne.t7)(0,i[1]+i[3],.5+.5*Te[1]),t.length>2&&(t[2]=.5*(Te[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,Le),t)}unprojectFromRenderScreen(e,t){if((0,J.m)(Pe,this.projectionMatrix,this.viewMatrix),!(0,J.a)(Pe,Pe))return null;const i=this.fullViewport;return Te[0]=2*(e[0]-i[0])/i[2]-1,Te[1]=2*(e[1]-i[1])/i[3]-1,Te[2]=2*e[2]-1,Te[3]=1,(0,N.t)(Te,Te,Pe),0===Te[3]?null:(t[0]=Te[0]/Te[3],t[1]=Te[1]/Te[3],t[2]=Te[2]/Te[3],t)}constrainWindowSize(e,t,i,r=1){const a=e*this.pixelRatio,s=t*this.pixelRatio,n=Math.max(a-i*r/2,0),o=Math.max(this.fullHeight-s-i/2,0),l=-Math.min(a-i*r/2,0),h=-Math.min(this.fullHeight-s-i/2,0);return[n,o,i*r-l- -Math.min(this.fullWidth-a-i*r/2,0),i-h- -Math.min(s-i/2,0)]}computeUp(e){1===e?this.computeUpGlobal():this.computeUpLocal()}screenToRender(e,t){const i=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=i,t[1]=r,t}renderToScreen(e,t){const i=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;return t[0]=i,t[1]=r,t}computeUpGlobal(){(0,U.f)(Ae,this.center,this.eye);const e=(0,U.l)(this.center);e<1?((0,U.s)(this.up,0,0,1),this.markViewDirty()):Math.abs((0,U.d)(Ae,this.center))>.9999*(0,U.l)(Ae)*e||((0,U.c)(this.up,Ae,this.center),(0,U.c)(this.up,this.up,Ae),(0,U.n)(this.up,this.up),this.markViewDirty())}computeUpLocal(){(0,Q.tB)(Ae,this.eye,this.center),Math.abs(Ae[2])<=.9999&&((0,U.a)(Ae,Ae,Ae[2]),(0,U.s)(this.up,-Ae[0],-Ae[1],1-Ae[2]),(0,U.n)(this.up,this.up),this.markViewDirty())}_compareAndSetView(e,t){(0,U.m)(e,t)||((0,U.g)(t,e),this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0)}_recomputeFrustum(){this._frustumDirty&&(De.oy.fromMatrix(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&((0,J.l)(this._viewMatrix,this._eye,this._center,this._up),(0,U.s)(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),(0,U.s)(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),(0,U.s)(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const Te=(0,w.a)(),Pe=(0,ee.a)(),Ae=(0,j.c)(),Ie=(0,j.c)(),Le=(0,Ce.J$)(),Ge=Oe;let Ve=class extends pe.default{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED=!1,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TERRAIN_DEBUG_POPUP=!1,this.TESTS_DISABLE_UPDATE_THRESHOLDS=!1,this.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET=!1,this.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.ENABLE_PROFILE_DEPTH_RANGE=!1,this.DISABLE_FAST_UPDATES=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1}};(0,a._)([(0,l.Cb)()],Ve.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"SCENEVIEW_LOCKING_LOG",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"DECONFLICTOR_SHOW_GRID",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"LABELS_SHOW_BORDER",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"OVERLAY_SHOW_CENTER",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"SHOW_POI",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"TERRAIN_DEBUG_POPUP",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"TESTS_DISABLE_UPDATE_THRESHOLDS",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"DISABLE_DECONFLICTOR_VISIBILITY_OFFSET",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"I3S_TREE_SHOW_TILES",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"I3S_SHOW_MODIFICATIONS",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"ENABLE_PROFILE_DEPTH_RANGE",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"DISABLE_FAST_UPDATES",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),(0,a._)([(0,l.Cb)()],Ve.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),Ve=(0,a._)([(0,h.j)("esri.views.3d.support.DebugFlags")],Ve);const ze=new Ve;var He=i(91852);class We{constructor(e,t,i,r){this._renderTarget=null,this.id=`${t}_${++i}`,this._renderTarget=new M.Z(e,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:r,maxAnisotropy:8,width:0,height:0})}dispose(){this._renderTarget.dispose(),this._renderTarget=null}getTexture(){return this._renderTarget?this._renderTarget.colorTexture:null}isValid(){return null!==this._renderTarget}resize(e,t){this._renderTarget.resize(e,t)}bind(e){e.bindFramebuffer(this._renderTarget)}generateMipMap(){this._renderTarget.colorTexture.descriptor.hasMipmap&&this._renderTarget.colorTexture.generateMipmap()}disposeRenderTargetMemory(){this._renderTarget&&this._renderTarget.resize(0,0)}getGpuMemoryUsage(){let e=0;return this._renderTarget&&(e+=(0,ve.un)(this._renderTarget)),e}}var Fe=i(50897);class je{constructor(e,t){this.vec3=e,this.id=t}}function Ue(e,t,i,r){return new je((0,j.f)(e,t,i),r)}class ke{constructor(e,t){this.extent=(0,Fe.Ue)(),this.resolution=0,this.renderLocalOrigin=Ue(0,0,0,"O"),this.pixelRatio=1,this.renderTargets={color:{fbo:new We(e,"overlay",t,!0),valid:!1,lastUsed:1/0},colorWithoutRasterImage:{fbo:new We(e,"overlayWithoutRasterImage",t,!0),valid:!1,lastUsed:1/0},highlight:{fbo:new We(e,"overlayHighlight",t,!1),valid:!1,lastUsed:1/0},water:{fbo:new We(e,"overlayWaterMask",t,!0),valid:!1,lastUsed:1/0},occluded:{fbo:new We(e,"overlayOccluded",t,!0),valid:!1,lastUsed:1/0}}}dispose(){this.renderTargets.color.fbo.dispose(),this.renderTargets.colorWithoutRasterImage.fbo.dispose(),this.renderTargets.highlight.fbo.dispose(),this.renderTargets.water.fbo.dispose(),this.renderTargets.occluded.fbo.dispose()}drawRenderTargets(e,t,i){const r=this.renderTargets;r.color.valid=e.drawPass(0,r.color.fbo,t),r.highlight.valid=e.drawPass(5,r.highlight.fbo,t),r.water.valid=e.drawPass(3,r.water.fbo,t),r.occluded.valid=e.drawPass(0,r.occluded.fbo,t,1),r.colorWithoutRasterImage.valid=i&&e.drawPass(0,r.colorWithoutRasterImage.fbo,t,2)}computeRenderTargetValidityBitfield(){const e=this.renderTargets;return+e.color.valid|+e.colorWithoutRasterImage.valid<<1|+e.highlight.valid<<2|+e.water.valid<<3|+e.occluded.valid<<4}validateUsage(e,t){if(e.valid)e.lastUsed=t;else if(t-e.lastUsed>Ne)e.fbo.disposeRenderTargetMemory(),e.lastUsed=1/0;else if(e.lastUsed<1/0)return!0;return!1}collectUnusedMemory(e){let t=!1;return t=this.validateUsage(this.renderTargets.color,e)||t,t=this.validateUsage(this.renderTargets.colorWithoutRasterImage,e)||t,t=this.validateUsage(this.renderTargets.highlight,e)||t,t=this.validateUsage(this.renderTargets.occluded,e)||t,t=this.validateUsage(this.renderTargets.water,e)||t,t}getGpuMemoryUsage(){return this.renderTargets.color.fbo.getGpuMemoryUsage()+this.renderTargets.colorWithoutRasterImage.fbo.getGpuMemoryUsage()+this.renderTargets.highlight.fbo.getGpuMemoryUsage()+this.renderTargets.water.fbo.getGpuMemoryUsage()+this.renderTargets.occluded.fbo.getGpuMemoryUsage()}}const Ne=1e3;var Ze=i(19677);class Be{constructor(){this._uniforms={proj:[],shadowMapDistance:[],viewportPixelSz:[],lightingMainDirection:[]}}dispose(){this._uniforms=null}getPrograms(e){return this._uniforms[e]||[]}subscribeProgram(e){for(const t in this._uniforms)e.hasUniform(t)&&this._uniforms[t].push(e)}unsubscribeProgram(e){for(const t in this._uniforms)(0,Ze.e$)(this._uniforms[t],e)}}var qe=i(39105);class Ye{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}class Xe{constructor(e){this._context=e,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.dispose())))),this._perConstructorInstances.clear()}acquire(e,t){const i=t.key;let r=this._perConstructorInstances.get(e);r||(r=new Map,this._perConstructorInstances.set(e,r));let a=r.get(i);return void 0===a&&(a=new Ye(new e(this._context,t)),r.set(i,a)),++a.refCount,a.technique}acquireAndReleaseExisting(e,t,i){return(0,n.Wi)(i)?this.acquire(e,t):t.key===i.key&&i instanceof e?i:(this.release(i),this.acquire(e,t))}release(e){const t=this._perConstructorInstances.get(e.constructor).get(e.key);t.refCount-=1,0===t.refCount&&(t.refZeroFrame=this._frameCounter)}frameUpdate(){this._frameCounter++,this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((t,i)=>{0===t.refCount&&t.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(t.technique.dispose(),e.delete(i))})),0===e.size&&this._perConstructorInstances.delete(t)}))}getProgramsUsingUniform(e){return this._context.commonUniformStore.getPrograms(e)}async hotReload(){const e=new Array;this._perConstructorInstances.forEach(((t,i)=>{e.push((async(e,t)=>{const i=t.shader;i&&(await i.reload(),e.forEach((e=>{e.technique.reload(this._context)})))})(t,i))})),await(0,qe.$6)(e)}}const $e=[{output:0,name:"color"},{output:1,name:"depth"},{output:2,name:"normal"},{output:3,name:"depthShadowMap"},{output:4,name:"highlight"},{output:5,name:"draped"},{output:6,name:"occlusion"},{output:7,name:"alpha"}];function Ke(e,t){return e+"_"+$e.find((e=>e.output===t)).name}const Qe=o.Z.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRep");class Je{constructor(e){this.refCnt=0,this.glMaterial=e}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,(0,te.hu)(this.refCnt>=0)}getRefCnt(){return this.refCnt}getGLMaterial(){return this.glMaterial}}var et=i(73032),tt=i(88909),it=i(89852);let rt=0;class at{constructor(){this.ROOT_ORIGIN_ID="rg_root_"+rt++,this._origins=new Map,this._gridSize=42e5}getOrigin(e){const t=this._origins.get(this.ROOT_ORIGIN_ID);if(null==t){if((0,n.pC)(at.testOrigin)){const t=at.testOrigin;return this._origins.set(this.ROOT_ORIGIN_ID,Ue(t[0],t[1],t[2],this.ROOT_ORIGIN_ID)),this.getOrigin(e)}const t=Ue(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,t),t}(0,U.f)(st,e,t.vec3),st[0]=Math.abs(st[0]),st[1]=Math.abs(st[1]),st[2]=Math.abs(st[2]);const i=this._gridSize;if(st[0]<i&&st[1]<i&&st[2]<i)return t;const r=Math.round(e[0]/i),a=Math.round(e[1]/i),s=Math.round(e[2]/i),o=`rg_${r}/${a}/${s}`;let l=this._origins.get(o);return l||(l=Ue(r*i,a*i,s*i,o),this._origins.set(o,l)),l}_drawOriginBox(e){const t=window.view,i=t._stage;if(null==this._object){this._material=new K.U({width:2,color:[0,1,0,1]},"GridLocalOriginMaterial"),i.add(3,this._material);const e=new it.Z("GridLocalOrigin",{isPickable:!1});i.add(0,e),this._object=new tt.Z({idHint:"GridLocalOrigin",castShadow:!1}),i.add(1,this._object),e.addObject(this._object),i.addToViewContent([e.id])}const r=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],a=r.length,s=new Float32Array(3*a),n=new Uint32Array(2*(a-1)),o=.5*this._gridSize;for(let t=0;t<a;t++)s[3*t+0]=e[0]+(1&r[t]?o:-o),s[3*t+1]=e[1]+(2&r[t]?o:-o),s[3*t+2]=e[2]+(4&r[t]?o:-o),t>0&&(n[2*t+0]=t-1,n[2*t+1]=t);(0,k.CM)(s,et.Z.WebMercator,0,s,t.spatialReference,0,a);const l={};l[te.Xt.POSITION]={size:3,data:s};const h={};h[te.Xt.POSITION]=n;const c=new ce.b(l,h,"line"),d=new X.Z(c,"GridLocalOriginBox");i.add(2,d),this._object.addGeometry(d,this._material,ee.I),console.log(this._origins.size,e)}}const st=(0,j.c)();!function(e){e.testOrigin=null}(at||(at={}));const nt=at;var ot=i(10762);function lt(e){return t=e.data,(0,te.kV)(t.indices).length>=1;var t}var ht=i(1227),ct=i(69595),dt=i(74038);class ut{constructor(e){null==e?e=16:e<65536&&(e=(0,ne.Sf)(e)),this._array=new Float32Array(e),this._size=0}resize(e,t){if(this._size=e,this._size>this._array.length){let e=this._array.length||1;for(;e<this._size;)e*=2;const i=new Float32Array(e);return t&&i.set(this._array),this._array=i,!0}const i=2*this._size;if(i<=this._array.length){let e=this._array.length;for(;e>=i;)e=Math.floor(e/2);const r=new Float32Array(e);return t&&r.set(this._array.subarray(0,e)),this._array=r,!0}return!1}append(e){const t=this._size;this.resize(this._size+e.length,!0),this._array.set(e,t)}erase(e,t){for(let i=e;i<t;++i)this._array[i]=0}get array(){return this._array}get size(){return this._size}}var pt=i(26701),gt=i(23240),mt=i(97853),ft=i(44801),_t=i(11379),vt=i(51007),yt=i(36904),wt=i(89553),bt=i(68397),Mt=i(61514),xt=i(72023),St=i(66704),Ct=i(71613),Rt=i(75619),Et=i(91123),Dt=i(74332);class Ot extends mt.A{constructor(e,t){super(e,t),this.waterTextureRepository=e.waterTextureRepository}initializeProgram(e){const t=Ot.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:i.useSSR,highStepCount:!0});return new vt.Z(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),_t.i)}ensureResource(e){return this.waterTextureRepository.ready||this.waterTextureRepository.updating||this.waterTextureRepository.loadTextures(e),this.waterTextureRepository.ready?2:1}bindPass(e,t,i){wt.G.bindProjectionMatrix(this.program,i.camera.projectionMatrix),0===this.configuration.output&&(i.lighting.setUniforms(this.program,!1),Rt.P.bindUniforms(this.program,e,i)),0!==this.configuration.output&&2!==this.configuration.output||(Et.M.bindUniforms(this.program,t),this.waterTextureRepository.bindRepo(e)),this.program.setUniform4fv("waterColor",t.color),4===this.configuration.output&&xt.b.bindOutputHighlight(e,this.program,i)}bindDraw(e){wt.G.bindView(this.program,e),0!==this.configuration.output&&7!==this.configuration.output||wt.G.bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&Ct.h.bindUniforms(this.program,e,bt.G.SHADOW_MAP),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||Mt.p.bindUniformsWithOrigin(this.program,this.configuration,e)}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e;return(0,yt.sm)({blending:2!==t.output&&4!==t.output&&t.transparent?i?St.wu:(0,St.$L)(e):null,depthTest:{func:(0,St.$x)(e)},depthWrite:i?t.writeDepth&&yt.LZ:(0,St.Vc)(e),colorWrite:yt.BK,polygonOffset:i||r?null:(0,St.je)(t.enableOffset)})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}Ot.shader=new gt.J(Dt.W,(()=>i.e(6815).then(i.bind(i,16815))));class Tt extends ft.m{constructor(){super(...arguments),this.output=0,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=3}}(0,a._)([(0,ft.o)({count:8})],Tt.prototype,"output",void 0),(0,a._)([(0,ft.o)()],Tt.prototype,"receiveShadows",void 0),(0,a._)([(0,ft.o)()],Tt.prototype,"slicePlaneEnabled",void 0),(0,a._)([(0,ft.o)()],Tt.prototype,"transparent",void 0),(0,a._)([(0,ft.o)()],Tt.prototype,"enableOffset",void 0),(0,a._)([(0,ft.o)()],Tt.prototype,"writeDepth",void 0),(0,a._)([(0,ft.o)()],Tt.prototype,"useSSR",void 0),(0,a._)([(0,ft.o)()],Tt.prototype,"isDraped",void 0),(0,a._)([(0,ft.o)({count:4})],Tt.prototype,"transparencyPassType",void 0);class Pt extends pt.Z{constructor(e){super(e),this.updateParameters()}updateParameters(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(Ot,this.material.getTechniqueConfig(this.output,e),this.technique)}beginSlot(e){if(2===this.output)return 22===e;if(5===this.output)return null==e;if(4===this.output)return 3===e;let t=3;return this.material.params.transparent&&(t=this.material.params.writeDepth?5:8),e===t}setElapsedTimeUniform(e){const t=.001*this.material.animation.time;e.setUniform1f("timeElapsed",t*this.material.params.animationSpeed)}_updateShadowState(e){e.shadowMappingEnabled!==this.material.params.receiveShadows&&this.material.setParameterValues({receiveShadows:e.shadowMappingEnabled})}_updateSSRState(e){e.ssrEnabled!==this.material.params.ssrEnabled&&this.material.setParameterValues({ssrEnabled:e.ssrEnabled})}ensureResources(e){return this.technique.ensureResource(e)}ensureParameters(e){0===this.output&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.params,t),2!==this.output&&0!==this.output||this.setElapsedTimeUniform(this.technique.program)}}class At{constructor(e,t,i,r,a,s){this.from=e,this.to=t,this.isVisible=i,this.hasHighlights=r,this.hasOccludees=a,this.transformation=s,null!=s&&(this.transformationNormal=(0,ee.b)(s),(0,J.a)(this.transformationNormal,this.transformationNormal),(0,J.b)(this.transformationNormal,this.transformationNormal))}}function It(e,t){const i=e=>({first:e.from,count:e.to-e.from});if(0===e.length)return void e.push(i(t));const r=e[e.length-1];if(s=t,(a=r).first+a.count>=s.from){const e=t.from-r.first+t.to-t.from;r.count=e}else e.push(i(t));var a,s}function Lt(e,t,i){(0,n.pC)(i)&&(i.drawCalls+=e,i.triangles+=t)}const Gt={begin:0,end:0},Vt=(0,ee.a)(),zt=(0,ee.a)(),Ht=(0,ee.a)();class Wt{}let Ft=class extends pe.default{constructor(){super(...arguments),this._pendingAddsRemoves=new Map,this._adds=new ue.Z,this._removes=new ue.Z,this._updates=new ue.Z({allocator:e=>e||new Wt,deallocator:e=>(e.renderGeometry=null,e)}),this._materialRenderers=new Map,this._sortedMaterialRenderers=new ue.Z,this._hasHighlights=!1,this._hasWater=!1}dispose(){this._adds.prune(),this._removes.prune(),this._updates.prune(),this._materialRenderers&&(this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear())}get updating(){return this._pendingAddsRemoves.size>0||this._updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return(0,fe.o)(this._materialRenderers,(e=>e.rendersOccluded))}stopAnimationsAtTime(e){this._sortedMaterialRenderers.forAll((t=>(0,n.yw)(t.material.animation,(t=>t.stopAtTime(e)))))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size}commitChanges(){let e=!1;if(!this.updating)return!1;this.updateAddsRemoves();const t=function(e){const t=new Map;let i=null,r=null;const a=e=>{if(e===i)return r;let a=t.get(e);return a||(a={toAdd:[],numToAdd:-1,toRemove:[],numToRemove:-1,toUpdate:[],numToUpdate:-1},t.set(e,a)),i=e,r=a,a};for(let t=0;t<e.numToAdd;t++){const i=e.toAdd[t];lt(i)&&a(i.material).toAdd.push(i)}for(let t=0;t<e.numToRemove;t++){const i=e.toRemove[t];lt(i)&&a(i.material).toRemove.push(i)}for(let t=0;t<e.numToUpdate;t++){const i=e.toUpdate[t];lt(i.renderGeometry)&&a(i.renderGeometry.material).toUpdate.push(i)}return t}({numToAdd:this._adds.length,toAdd:this._adds.data,numToRemove:this._removes.length,toRemove:this._removes.data,numToUpdate:this._updates.length,toUpdate:this._updates.data});let i=!1,r=!1;return t.forEach(((t,a)=>{let s=this._materialRenderers.get(a);if(!s&&t.toAdd.length>0&&(s=new class{constructor(e,t,i){this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=e,this._material=i,this._materialRep=t,this._glMaterials=(0,re.a9)(this._material,this._materialRep),this._bufferWriter=i.createBufferWriter()}dispose(){(0,re.BX)(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((e=>{e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((e=>{e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&(0,fe.o)(this._glMaterials,(e=>e instanceof Pt))}get rendersOccluded(){return!this.isEmpty&&1!==this._material.renderOccluded}modify(e){this.updateGeometries(e.toUpdate),this.addAndRemoveGeometries(e.toAdd,e.toRemove),this.updateRenderCommands()}addAndRemoveGeometries(e,t){const i=this._bufferWriter,r=i.vertexBufferLayout,a=r.stride/4,s=this._dataByOrigin,n=function(e,t,i,r){const a=new Map,s=t.vertexBufferLayout.stride/4,n=(i,r)=>{const n=i.origin,o=e.get(n.id);let l=a.get(n.id);null==l&&(l={optimalCount:null==o?0:o.optimalCount,sparseCount:null==o?0:o.buffer.size,toAdd:[],toRemove:[],origin:n.vec3},a.set(n.id,l));const h=t.elementCount(i.data)*s;r?(l.optimalCount+=h,l.sparseCount+=h,l.toAdd.push(i)):(l.optimalCount-=h,l.toRemove.push(i))};for(const e of i)n(e,!0);for(const e of r)n(e,!1);return a}(s,i,e,t);n.forEach(((e,t)=>{n.delete(t);const i=e.optimalCount,o=e.sparseCount;let l=s.get(t);if(null==l)(0,te.hu)(i>0),l=this.createData(r,i,e.origin),s.set(t,l);else if(0===i)return l.vao.dispose(!0),l.vao=null,void s.delete(t);const h=i<e.sparseCount/2,c=h?i:o,d=Gt,u=l.buffer.size,p=l.buffer.array,g=l.buffer.resize(c,!1);h||g?this.removeAndRebuild(l,e.toRemove,a,p,d):e.toRemove.length>0?(this.removeByErasing(l,e.toRemove,a,d),e.toAdd.length>0&&(d.end=u)):(d.begin=u,d.end=u);const m=Vt;(0,te.u_)(m,-e.origin[0],-e.origin[1],-e.origin[2]),this.append(l,e.toAdd,a,m,d);const f=l.vao.vertexBuffers.geometry;if(f.byteSize!==l.buffer.array.buffer.byteLength)f.setData(l.buffer.array);else{const{begin:e,end:t}=d;if(e<t){const i=l.buffer.array,r=4,a=e*r,s=t*r;f.setSubData(i,a,a,s)}}l.drawCommandsDirty=!0}))}updateGeometries(e){const t=this._bufferWriter,i=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.updateType,a=r.renderGeometry,s=this._dataByOrigin.get(a.origin.id),n=s&&s.instances.get(a.uniqueName);if(!n)return;if(1&e&&(n.isVisible=a.instanceParameters.visible),9&e){const e=a.instanceParameters.visible;n.hasHighlights=!!a.instanceParameters.highlights&&e}if(16&e&&(n.hasOccludees=!!a.instanceParameters.occludees),6&e){const e=s.buffer.array,r=s.vao;(0,re.Wr)(a,zt,Ht),t.write({transformation:zt,invTranspTransformation:Ht},a.data,t.vertexBufferLayout.createView(e.buffer),n.from),(0,te.hu)(n.from+t.elementCount(a.data)===n.to,"material VBO layout has changed"),r.vertexBuffers.geometry.setSubData(e,n.from*i*4,n.from*i*4,n.to*i*4)}s.drawCommandsDirty=!0}}updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,(0,fe.o)(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))})),this._dataByOrigin.forEach((e=>{e.drawCommandsDirty&&((e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.stats={default:0,highlight:0,occludees:0},0===e.instances.size)return;if(!(e.hasOccludees||e.hasHighlights||e.hasHiddenInstances)){const t=4*e.buffer.size/(0,ve.m)(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0})}const t=function(e){return e.sort(((e,t)=>e.from===t.from?e.to>t.to?1:e.to<t.to?-1:0:e.from>t.from?1:e.from<t.from?-1:0))}([...e.instances.values()]);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[];for(const i of t)i.isVisible&&(i.hasOccludees?It(e.drawCommandsOccludees,i):It(e.drawCommandsDefault,i),i.hasHighlights&&It(e.drawCommandsHighlight,i));const i=e=>{let t=0;for(const i of e)t+=i.count;return t/3};e.stats={default:i(e.drawCommandsDefault),highlight:i(e.drawCommandsHighlight),occludees:i(e.drawCommandsOccludees)}})(e),e.drawCommandsDirty=!1)}))}updateLogic(e){return this._material.update(e)}render(e,t,i,r){const a=this._rctx,s=this._glMaterials.get(t.pass),o=5===t.pass;let l=e;if(3===t.pass&&null===l&&(l=22),!s||2!==s.ensureResources(a)||null!=l&&!s.beginSlot(l)||o&&!this._hasHighlights)return!1;s.ensureParameters(i);const h=s.getTechnique(),c=s.getPipelineState(l,!1);a.setPipelineState(c),s.bind(a,i);let d=!1;return this._dataByOrigin.forEach((e=>{if((0,n.Wi)(e.drawCommandsDefault)&&(0,n.Wi)(e.drawCommandsHighlight)&&(0,n.Wi)(e.drawCommandsOccludees))return;if(o&&!e.hasHighlights)return;i.origin=e.origin,h.bindDraw(i),h.ensureAttributeLocations(e.vao),a.bindVAO(e.vao);const t=h.primitiveType;let u=o?e.drawCommandsHighlight:e.drawCommandsDefault;const p=o?e.stats.highlight:e.stats.default;if((0,n.pC)(u)&&(this.renderCommands(a,t,u),Lt(u.length,p,r),d=!0),!o&&(u=e.drawCommandsOccludees,(0,n.pC)(u))){const i=s.getPipelineState(l,!0);a.setPipelineState(i),this.renderCommands(a,t,u),a.setPipelineState(c),Lt(u.length,e.stats.occludees,r),d=!0}})),d}renderCommands(e,t,i){for(let r=0;r<i.length;r++)e.drawArrays(t,i[r].first,i[r].count)}createData(e,t,i){return{instances:new Map,vao:new dt.Z(this._rctx,this._material.vertexAttributeLocations,{geometry:(0,ht.K)(e)},{geometry:ct.Z.createVertex(this._rctx,35044)}),buffer:new ut(t),optimalCount:0,origin:i,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,stats:{default:0,highlight:0,occludees:0}}}removeAndRebuild(e,t,i,r,a){for(const r of t){const t=r.uniqueName,a=e.instances.get(t);e.optimalCount-=(a.to-a.from)*i,e.instances.delete(t)}let s=0;const n=e.buffer.array;a.begin=0,a.end=0;let o=-1,l=-1,h=0;e.instances.forEach((e=>{const t=e.from*i,a=e.to*i,c=a-t;o!==l&&l!==t?(n.set(r.subarray(o,l),h),h+=l-o,o=t):-1===o&&(o=t),l=a,e.from=s/i,s+=c,e.to=s/i})),o!==l&&n.set(r.subarray(o,l),h),a.end=s}removeByErasing(e,t,i,r){r.begin=1/0,r.end=-1/0;let a=-1,s=-1;for(const n of t){const t=n.uniqueName,o=e.instances.get(t),l=o.from*i,h=o.to*i;a!==s&&s!==l?(e.buffer.erase(a,s),a=l):-1===a&&(a=l),s=h,e.instances.delete(t),e.optimalCount-=h-l,l<r.begin&&(r.begin=l),h>r.end&&(r.end=h)}a!==s&&e.buffer.erase(a,s)}append(e,t,i,r,a){const s=this._bufferWriter;for(const o of t){const t=(0,n.pC)(o.transformation)?(0,J.m)(zt,r,o.transformation):r;(0,J.a)(Ht,t),(0,J.b)(Ht,Ht);const l=a.end;s.write({transformation:t,invTranspTransformation:Ht},o.data,s.vertexBufferLayout.createView(e.buffer.array.buffer),a.end/i);const h=s.elementCount(o.data)*i,c=l+h;(0,te.hu)(null==e.instances.get(o.uniqueName));const d=o.instanceParameters.visible,u=!!o.instanceParameters.highlights&&d,p=!!o.instanceParameters.occludees,g=new At(l/i,c/i,d,u,p);e.instances.set(o.uniqueName,g),e.optimalCount+=h,a.end+=h}}get test(){return{material:this._material,glMaterials:this._glMaterials}}}(this.rctx,this.materialRepository,a),this._materialRenderers.set(a,s),e=!0,i=!0,r=!0),!s)return;const o=i||s.hasHighlights,l=r||s.hasWater;s.modify(t),i=i||o!==s.hasHighlights,r=r||l!==s.hasWater,s.isEmpty&&(this._materialRenderers.delete(a),s.dispose(),e=!0)})),this._adds.clear(),this._removes.clear(),this._updates.clear(),this._pendingAddsRemoves.clear(),e&&this.updateSortedMaterialRenderers(),i&&(this._hasHighlights=(0,fe.o)(this._materialRenderers,(e=>e.hasHighlights))),r&&(this._hasWater=(0,fe.o)(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0}add(e){if(0===e.length)return;const t=0===this._pendingAddsRemoves.size;for(const t of e)this._pendingAddsRemoves.set(t,0);t&&this.notifyChange("updating")}remove(e){const t=0===this._pendingAddsRemoves.size;for(const t of e){const e=this._pendingAddsRemoves.get(t);0===e?this._pendingAddsRemoves.set(t,2):2!==e&&this._pendingAddsRemoves.set(t,1)}t&&this._pendingAddsRemoves.size>0&&this.notifyChange("updating")}modify(e,t){const i=0===this._updates.length;for(const i of e){const e=this._updates.pushNew();e.renderGeometry=i,e.updateType=t}i&&this._updates.length>0&&this.notifyChange("updating")}updateLogic(e){let t=!1;return this._sortedMaterialRenderers.forAll((({materialRenderer:i})=>{i.updateLogic&&i.updateLogic(e)&&(t=!0)})),t}draw(e,t){for(let i=0;i<this._sortedMaterialRenderers.length;i++){const r=this._sortedMaterialRenderers.data[i];(0,ot.Pb)(r.material,e)&&r.materialRenderer.render(null,e,t,null)}}updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((t,i)=>{i.insertOrder=e++,this._sortedMaterialRenderers.push({material:i,materialRenderer:t})})),this._sortedMaterialRenderers.sort(((e,t)=>{const i=t.material.renderPriority-e.material.renderPriority;return 0!==i?i:e.material.insertOrder-t.material.insertOrder}))}updateAddsRemoves(){this._adds.clear(),this._removes.clear(),this._pendingAddsRemoves.forEach(((e,t)=>{switch(e){case 0:this._adds.push(t);break;case 1:this._removes.push(t)}}));let e=0;for(;e<this._updates.length;){const t=this._updates.data[e].renderGeometry;this._pendingAddsRemoves.has(t)?this._updates.removeUnorderedIndex(e):e++}}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};(0,a._)([(0,l.Cb)()],Ft.prototype,"rctx",void 0),(0,a._)([(0,l.Cb)()],Ft.prototype,"materialRepository",void 0),(0,a._)([(0,l.Cb)()],Ft.prototype,"updating",null),Ft=(0,a._)([(0,h.j)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Ft);var jt=i(54452);class Ut extends mt.A{initializeProgram(e){const t=Ut.shader.get().build();return new vt.Z(e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),_t.i)}initializePipeline(){return this.configuration.hasAlpha?(0,yt.sm)({blending:(0,yt.wK)(770,1,771,771),colorWrite:yt.BK}):(0,yt.sm)({colorWrite:yt.BK})}}Ut.shader=new gt.J(jt.T,(()=>i.e(1225).then(i.bind(i,61225))));class kt extends ft.m{constructor(){super(...arguments),this.hasAlpha=!1}}function Nt(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t[r];return i}function Zt(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t;return i}function Bt(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]+t[r];return i}function qt(e){return(e+1)*(e+1)}function Yt(e,t,i){const r=e[0],a=e[1],s=e[2],n=i||[];return n.length=qt(t),t>=0&&(n[0]=.28209479177),t>=1&&(n[1]=.4886025119*r,n[2]=.4886025119*s,n[3]=.4886025119*a),t>=2&&(n[4]=1.09254843059*r*a,n[5]=1.09254843059*a*s,n[6]=.31539156525*(3*s*s-1),n[7]=1.09254843059*r*s,n[8]=.54627421529*(r*r-a*a)),n}function Xt(e,t){const i=function(e){return(0,ne.uZ)(Math.floor(Math.sqrt(e)-1),0,2)}(t.r.length);for(const r of e)(0,U.p)(ii,r.direction),Yt(ii,i,ei),Nt(ei,ri),Zt(ei,r.intensity[0],ti),Bt(t.r,ti),Zt(ei,r.intensity[1],ti),Bt(t.g,ti),Zt(ei,r.intensity[2],ti),Bt(t.b,ti);return t}function $t(e,t,i){(function(e,t){const i=qt(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let e=0;e<i;e++)r.r[e]=r.g[e]=r.b[e]=0})(t,i.sphericalHarmonics.sh),(0,U.s)(i.main.intensity,0,0,0);let r=!1;const a=Kt,s=Qt,n=Jt;a.length=0,s.length=0,n.length=0;for(const t of e)t instanceof we&&!r?((0,U.g)(i.main.direction,t.direction),i.main.intensity[0]=t.intensity[0],i.main.intensity[1]=t.intensity[1],i.main.intensity[2]=t.intensity[2],i.main.castShadows=t.castShadows,r=!0):t instanceof we||t instanceof be?a.push(t):t instanceof Me?s.push(t):t instanceof xe&&n.push(t);Xt(a,i.sphericalHarmonics.sh),function(e,t){Yt(ii,0,ei);for(const i of e)t.r[0]+=ei[0]*ri[0]*i.intensity[0]*4*Math.PI,t.g[0]+=ei[0]*ri[0]*i.intensity[1]*4*Math.PI,t.b[0]+=ei[0]*ri[0]*i.intensity[2]*4*Math.PI}(s,i.sphericalHarmonics.sh);for(const e of n)Bt(i.sphericalHarmonics.sh.r,e.sh.r),Bt(i.sphericalHarmonics.sh.g,e.sh.g),Bt(i.sphericalHarmonics.sh.b,e.sh.b)}(0,a._)([(0,ft.o)()],kt.prototype,"hasAlpha",void 0);const Kt=[],Qt=[],Jt=[],ei=[0],ti=[0],ii=(0,j.c)(),ri=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398],ai=(0,j.c)();class si{constructor(){this._renderLighting={main:{intensity:(0,j.c)(),direction:(0,j.f)(1,0,0),castShadows:!1},sphericalHarmonics:{sh:{r:[0],g:[0],b:[0]}}},this._shOrder=2,this._oldSunlight={direction:(0,j.c)(),ambient:{color:(0,j.c)(),intensity:0},diffuse:{color:(0,j.c)(),intensity:0}}}setLightDirectionUniform(e){e.setUniform3fv("lightingMainDirection",this._renderLighting.main.direction)}setUniforms(e,t=!1){if(t){const t=(1-this._info.groundLightingFactor)*(1-this._info.globalFactor);e.setUniform1f("lightingFixedFactor",t)}else e.setUniform1f("lightingFixedFactor",0);e.setUniform1f("lightingGlobalFactor",this._info.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._renderLighting.main.intensity),e.setUniform1f("ambientBoostFactor",.4);const i=this._renderLighting.sphericalHarmonics.sh;0===this._shOrder?e.setUniform3f("lightingAmbientSH0",i.r[0],i.g[0],i.b[0]):1===this._shOrder?(e.setUniform4f("lightingAmbientSH_R",i.r[0],i.r[1],i.r[2],i.r[3]),e.setUniform4f("lightingAmbientSH_G",i.g[0],i.g[1],i.g[2],i.g[3]),e.setUniform4f("lightingAmbientSH_B",i.b[0],i.b[1],i.b[2],i.b[3])):2===this._shOrder&&(e.setUniform3f("lightingAmbientSH0",i.r[0],i.g[0],i.b[0]),e.setUniform4f("lightingAmbientSH_R1",i.r[1],i.r[2],i.r[3],i.r[4]),e.setUniform4f("lightingAmbientSH_G1",i.g[1],i.g[2],i.g[3],i.g[4]),e.setUniform4f("lightingAmbientSH_B1",i.b[1],i.b[2],i.b[3],i.b[4]),e.setUniform4f("lightingAmbientSH_R2",i.r[5],i.r[6],i.r[7],i.r[8]),e.setUniform4f("lightingAmbientSH_G2",i.g[5],i.g[6],i.g[7],i.g[8]),e.setUniform4f("lightingAmbientSH_B2",i.b[5],i.b[6],i.b[7],i.b[8]))}set(e){this._info=e,$t(e.lights,this._shOrder,this._renderLighting),(0,U.p)(this._oldSunlight.direction,this._renderLighting.main.direction);const t=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._renderLighting.sphericalHarmonics.sh.r[0]*t,this._oldSunlight.ambient.color[1]=.282095*this._renderLighting.sphericalHarmonics.sh.g[0]*t,this._oldSunlight.ambient.color[2]=.282095*this._renderLighting.sphericalHarmonics.sh.b[0]*t,this._oldSunlight.ambient.intensity=1,this._oldSunlight.diffuse.color[0]=this._renderLighting.main.intensity[0]*t,this._oldSunlight.diffuse.color[1]=this._renderLighting.main.intensity[1]*t,this._oldSunlight.diffuse.color[2]=this._renderLighting.main.intensity[2]*t,this._oldSunlight.diffuse.intensity=1;const i=(0,U.g)(ai,this._oldSunlight.diffuse.color);(0,U.a)(i,i,.4*this._info.globalFactor),(0,U.b)(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,i)}get globalFactor(){return this._info.globalFactor}get old(){return this._oldSunlight}}const ni=o.Z.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let oi=class extends((0,He.TF)(pe.default)){constructor(e){super(e),this._overlays=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new si,this._localOrigins=new nt,this._handles=new ge.Z,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new ue.Z,this._geometries=new Map,this._uniqueIdx=0,this.globalUnitScale=1,this.longitudeCyclical=null}initialize(){this._rctx=this.renderView.renderingContext,this._renderContext=new class{constructor(e,t,i,r,a,s){this.camera=null,this.lastFrameCamera=new Ge,this.pass=0,this.slot=0,this.highlightDepthTexture=null,this.renderOccludedMask=13,this.hasOccludees=!1,this.rctx=e,this.offscreenRenderingHelper=t,this.scenelightingData=i,this.shadowMap=r,this.ssaoHelper=a,this.sliceHelper=s}resetRenderOccludedMask(){this.renderOccludedMask=13}get isHighlightPass(){return 5===this.pass}}(this._rctx,null,null,null,null,null),this._stippleTextureRepository=new x,this.waterTextureRepository=this.renderView.waterTextureRepository,this._shaderTechniqueRepository=new Xe({rctx:this._rctx,viewingMode:2,commonUniformStore:new Be,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),(0,me.init)(this.waterTextureRepository,"loadingState",(()=>this.emitContentChanged())),this._materialRepository=new class{constructor(e,t,i){this._textureRep=e,this._techniqueRep=t,this.onMaterialChanged=i,this._id2glMaterialRef=new Map}dispose(){this._textureRep.dispose()}acquire(e,t){this.ownMaterial(e);const i=Ke(e.id,t);let r=this._id2glMaterialRef.get(i);if(null==r){const a=e.getGLMaterial({material:e,techniqueRep:this._techniqueRep,textureRep:this._textureRep,output:t});return r=new Je(a),r.incRefCnt(),this._id2glMaterialRef.set(i,r),a}return r.incRefCnt(),r.getGLMaterial()}release(e,t){const i=Ke(e.id,t),r=this._id2glMaterialRef.get(i);if(r.decRefCnt(),0===r.getRefCnt()){const e=r.getGLMaterial();e&&e.dispose(),this._id2glMaterialRef.delete(i)}}materialChanged(e){for(const t of $e)if(5!==t.output&&6!==t.output){const i=this._id2glMaterialRef.get(Ke(e.id,t.output));if(i&&i.getGLMaterial()){const e=i.getGLMaterial();e.updateParameters&&e.updateParameters()}}this.onMaterialChanged&&this.onMaterialChanged(e)}ownMaterial(e){(0,n.pC)(e.materialRepository)&&e.materialRepository!==this&&Qe.error("Material is already owned by a different material repository"),e.materialRepository=this}}(this.renderView.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=e=>{(e.renderOccluded&pi)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.emitContentChanged(),this.notifyChange("updating")},this._compositingHelper=this.renderView.compositingHelper,this._lighting.set({lights:[new Me((0,j.f)(1,1,1))],groundLightingFactor:1,globalFactor:0}),this._bindParameters={slot:null,highlightDepthTexture:(0,ye.hf)(this._rctx),camera:ci,inverseViewport:(0,_e.a)(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3}}dispose(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.dispose())),this._layerRenderers.clear(),this._bindParameters.highlightDepthTexture.dispose(),this._bindParameters.highlightDepthTexture=null,this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null}get updating(){return this._sortedLayerRenderersDirty||(0,fe.o)(this._layerRenderers,(e=>e.updating))||this.waterTextureRepository.updating}get hasOverlays(){return(0,n.pC)(this._overlays)}get gpuMemoryUsage(){return(0,n.pC)(this._overlays)?this._overlays[0].getGpuMemoryUsage()+this._overlays[1].getGpuMemoryUsage():0}get overlays(){return this._overlays}forEachOverlay(e){(0,n.pC)(this._overlays)&&(e(this._overlays[0],0),e(this._overlays[1],1))}ensureOverlays(){if((0,n.Wi)(this._overlays)){const e=this.renderView.renderingContext;this._overlays=[new ke(e,0),new ke(e,1)]}}disposeOverlays(){(0,n.pC)(this._overlays)&&(this._overlays.forEach((e=>e.dispose())),this._overlays=null)}commitChanges(){let e=!1;this._layerRenderers.forEach(((t,i)=>{t.commitChanges()&&(e=!0),t.isEmpty&&(this._layerRenderers.delete(i),this._sortedLayerRenderersDirty=!0,this._handles.remove(i))})),this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),e=!0),e&&(this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}addGeometries(e,t,i){for(const t of e)null==t.origin&&(t.origin=this._localOrigins.getOrigin(t.center)),t.uniqueName||(t.uniqueName="ov:"+this._uniqueIdx++),this._geometries.set(t.uniqueName,t);this.ensureLayerRenderer(t).add(e),2===i&&this.notifyGraphicUpdate(e,t,2)}removeGeometries(e,t,i){for(const t of e)this._geometries.delete(t.uniqueName);const r=this._layerRenderers.get(t);r&&(r.remove(e),2===i&&this.notifyGraphicUpdate(e,t,2))}updateGeometries(e,t,i){const r=this._layerRenderers.get(t);r?(r.modify(e,i),this.notifyUpdateGeometries(e,t,i)):ni.warn("Attempted to update geometry for nonexistent layer")}notifyUpdateGeometries(e,t,i){const r=4===i||2===i?2:1===i?1:0;this.notifyGraphicUpdate(e,t,r)}notifyGraphicUpdate(e,t,i){if(0===i||(0,n.Wi)(t.notifyGraphicUpdate))return;let r=-1;for(const a of e){const e=a.data.graphicUid;e!==r&&(t.notifyGraphicUpdate(e,i),r=e)}}updateHighlights(e,t){const i=this._layerRenderers.get(t);i?i.modify(e,8):ni.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return 0===this._geometries.size&&!ze.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateLogic(e){let t=!1;return this._layerRenderers.forEach((i=>{i.updateLogic(e)&&(t=!0)})),t}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawPass(e,t,i,r=0){if(0===i.numViews)return!1;if(this._screenToWorldRatio=i.pixelRatio*Math.abs(i.views[0].extent[2]-i.views[0].extent[0])/Math.abs(i.views[0].viewport[2]-i.views[0].viewport[0]),this.isEmpty()||5===e&&!this.hasHighlights||3===e&&!this.hasWater)return!1;if(!this.hasNonZeroSizedView(i))return!1;const a=i.width,s=i.height;if(!t.isValid())return!1;t.resize(a,s);const o=this._rctx;if(ci.pixelRatio=i.pixelRatio||1,this._renderContext.pass=e,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,t.bind(o),o.setClearColor(0,0,0,0),o.clearSafe(16384),1===r&&(this._renderContext.renderOccludedMask=pi),ze.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==r)for(let e=0;e<i.numViews;e++)this.setViewParameters(i.views[e],ci),this.drawDebugTexture(a,s,hi[i.index%hi.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({layerView:l,renderer:h})=>{if(2===r&&(0,n.pC)(l)&&0===l.drapeSourceType)return;const c=(0,n.pC)(l)&&(0,n.pC)(l.fullOpacity)&&l.fullOpacity<1&&0===e;c&&(this.bindTemporaryFramebuffer(this._rctx,a,s),o.clearSafe(16384));for(let e=0;e<i.numViews;e++)this.setViewParameters(i.views[e],ci),h.draw(this._renderContext,this._bindParameters);c&&(0,n.pC)(this._temporaryRenderTarget)&&(t.bind(o),this._compositingHelper.composite(this._temporaryRenderTarget.getTexture(),2,(0,n.Wg)((0,n.Wg)(l).fullOpacity)))})),o.bindFramebuffer(null),t.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,i){(0,n.Wi)(this._temporaryRenderTarget)&&(this._temporaryRenderTarget=new We(e,"temp",0,!1)),this._temporaryRenderTarget.resize(t,i),this._temporaryRenderTarget.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.hotReload()}intersect(e,t,i){let r=0;this._geometries.forEach((a=>{if(i&&!i(a))return;this.intersectRenderGeometry(a,t,0,e,r);const s=this.longitudeCyclical;s&&(a.center[0]-a.bsRadius<s.min&&this.intersectRenderGeometry(a,t,s.range,e,r),a.center[0]+a.bsRadius>s.max&&this.intersectRenderGeometry(a,t,-s.range,e,r)),r++}))}intersectRenderGeometry(e,t,i,r,a){let s=0;(0,n.pC)(e.transformation)&&(i+=e.transformation[12],s=e.transformation[13]),di[0]=t[0]-i,di[1]=t[1]-s,di[2]=1,ui[0]=t[0]-i,ui[1]=t[1]-s,ui[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),r,di,ui,((t,i,s)=>{this.addIntersectionResult(s,e.material.renderPriority,a,r,e.data.layerUid,e.data.graphicUid)}),e.calculateShaderTransformation,!0)}addIntersectionResult(e,t,i,r,a,s){const n={type:"external",metadata:{layerUid:a,graphicUid:s}},o=a=>{a.set(n,null,r.results.ground.dist,r.results.ground.normal,r.results.ground.transformation,t,null,null,e,i),a.intersector="OverlayRenderer"};if((null==r.results.min.drapedLayerOrder||t>=r.results.min.drapedLayerOrder)&&(null==r.results.min.dist||r.results.ground.dist<=r.results.min.dist)&&o(r.results.min),0!==r.options.store&&(null==r.results.max.drapedLayerOrder||t<r.results.max.drapedLayerOrder)&&(null==r.results.max.dist||r.results.ground.dist>r.results.max.dist)&&o(r.results.max),2===r.options.store){const e=new Se.xM(r.ray);o(e),r.results.all.push(e)}}stopAnimationsAtTime(e){this._sortedLayerRenderers.forAll((t=>t.renderer.stopAnimationsAtTime(e)))}ensureLayerRenderer(e){let t=this._layerRenderers.get(e);return t||(t=new Ft({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,t),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.emitContentChanged())),e),this._handles.add((0,me.init)(t,"updating",(()=>this.notifyChange("updating"))),e)),t}updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const[{view:{allLayerViews:e}}]=this._layerRenderers.keys(),t=new Set(this._layerRenderers.values());e.forEach((e=>{const i=e,r=this._layerRenderers.get(i);r&&(this._sortedLayerRenderers.push(new li(i,r)),t.delete(r))})),t.forEach((e=>{this._sortedLayerRenderers.push(new li(null,e))}))}setViewParameters(e,t){t.viewport=e.viewport;const i=e.extent;(0,J.o)(t.projectionMatrix,0,i[2]-i[0],0,i[3]-i[1],t.near,t.far),(0,J.i)(t.viewMatrix),(0,J.t)(t.viewMatrix,t.viewMatrix,[-e.extent[0],-e.extent[1],0]),t.setGLViewport(this._rctx),this._renderContext.camera=t,this._bindParameters.camera=t,this._bindParameters.inverseViewport[0]=1/t.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.fullViewport[3]}hasNonZeroSizedView(e){for(let t=0;t<e.numViews;t++){const i=e.views[t];if(i.extent[0]!==i.extent[2]&&i.extent[1]!==i.extent[3])return!0}return!1}emitContentChanged(){this.onContentChanged&&this.onContentChanged()}updateHasWater(){const e=(0,fe.o)(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e)}updateHasHighlights(){const e=(0,fe.o)(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))}updateRendersOccluded(){const e=(0,fe.o)(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))}drawDebugTexture(e,t,i){const r=this._rctx;this.ensureDebugPatternResources(e,t);const a=this._debugTextureTechnique.program;r.bindProgram(a),r.setPipelineState(this._debugTextureTechnique.pipeline),a.setUniform4f("color",i[0],i[1],i[2],1),a.setUniform1i("tex",0),r.bindTexture(this._debugPatternTexture,0),r.bindVAO(this._quadVAO),r.drawArrays(5,0,(0,ve._V)(this._quadVAO,"geometry"))}ensureDebugPatternResources(e,t){if(this._debugPatternTexture)return;const i=new Uint8Array(e*t*4);let r=0;for(let a=0;a<t;a++)for(let s=0;s<e;s++){const n=Math.floor(s/10),o=Math.floor(a/10);n<2||o<2||10*n>e-20||10*o>t-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&n&&1&o?1&s^1&a?0:255:1&n^1&o?0:128)}this._debugPatternTexture=new b.Z(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},i);const a=new kt;a.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(Ut,a,this._debugTextureTechnique),this._quadVAO=(0,ye.ow)(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};(0,a._)([(0,He.gT)()],oi.prototype,"_shaderTechniqueRepository",void 0),(0,a._)([(0,He.gT)()],oi.prototype,"_stippleTextureRepository",void 0),(0,a._)([(0,l.Cb)(),(0,He.gT)()],oi.prototype,"waterTextureRepository",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],oi.prototype,"renderView",void 0),(0,a._)([(0,l.Cb)()],oi.prototype,"globalUnitScale",void 0),(0,a._)([(0,l.Cb)({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating"]})],oi.prototype,"updating",null),oi=(0,a._)([(0,h.j)("esri.views.3d.terrain.OverlayRenderer")],oi);class li{constructor(e,t){this.layerView=e,this.renderer=t}}const hi=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],ci=new Ge;ci.near=1,ci.far=1e4,ci.relativeElevation=null;const di=(0,j.c)(),ui=(0,j.c)(),pi=4,gi=w.O;function mi(e){const t={},i={};!function(e,t,i){const{attributeData:{position:r},removeDuplicateStartEnd:a}=e,s=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(r)&&1===a,n=r.length/3-(s?1:0),o=new Uint32Array(2*(n-1)),l=s?(0,se.tP)(r,0,r.length-3):r;let h=0;for(let e=0;e<n-1;e++)o[h++]=e,o[h++]=e+1;t[$._A.POSITION]={size:3,data:l,offsetIdx:0,strideIdx:3},i[$._A.POSITION]=o}(e,i,t);const r=new Uint32Array(t[$._A.POSITION].length);return function(e,t,i){const r=e.attributeData.mapPosition;(0,n.Wi)(r)||(i.mapPos=i[$._A.POSITION],t.mapPos={size:3,data:r,offsetIdx:0,strideIdx:3})}(e,i,t),function(e,t,i,r){if((0,n.pC)(e.attributeData.colorFeature))return;const a=e.attributeData.color;t[$._A.COLOR]={size:4,data:(0,n.Pt)(a,gi),offsetIdx:0,strideIdx:4},i[$._A.COLOR]=r}(e,i,t,r),function(e,t,i,r){if((0,n.pC)(e.attributeData.sizeFeature))return;const a=e.attributeData.size;t[$._A.SIZE]={size:1,data:new Float32Array([(0,n.Pt)(a,1)]),offsetIdx:0,strideIdx:1},i[$._A.SIZE]=r}(e,i,t,r),function(e,t,i,r){const a=e.attributeData.colorFeature;(0,n.Wi)(a)||(t[$._A.COLORFEATUREATTRIBUTE]={size:1,data:new Float32Array([a]),offsetIdx:0,strideIdx:1},i[$._A.COLOR]=r)}(e,i,t,r),function(e,t,i,r){const a=e.attributeData.sizeFeature;(0,n.Wi)(a)||(t[$._A.SIZEFEATUREATTRIBUTE]={size:1,data:new Float32Array([a]),offsetIdx:0,strideIdx:1},i[$._A.SIZEFEATUREATTRIBUTE]=r)}(e,i,t,r),function(e,t,i,r){const a=e.attributeData.opacityFeature;(0,n.Wi)(a)||(t[$._A.OPACITYFEATUREATTRIBUTE]={size:1,data:new Float32Array([a]),offsetIdx:0,strideIdx:1},i[$._A.OPACITYFEATUREATTRIBUTE]=r)}(e,i,t,r),function(e,t,i){if("round"!==e.join)return;const r=t[$._A.POSITION].data,a=r.length/3,s=new Float32Array(a),o=vi,l=yi;(0,U.s)(o,0,0,0);const h=(0,n.Pt)(e.uniformSize,1);for(let e=-1;e<a;++e){const t=e<0?a+e:e,i=(e+1)%a;if((0,U.s)(l,r[3*i+0]-r[3*t+0],r[3*i+1]-r[3*t+1],r[3*i+2]-r[3*t+2]),(0,U.n)(l,l),e>=0){const t=(Math.PI-(0,ne.ZF)((0,U.d)(o,l)))*wi*1*_i(h);s[e]=Math.max(Math.floor(t),0)}(0,U.a)(o,l,-1)}t[$._A.SUBDIVISIONS]={size:1,data:s,offsetIdx:0,strideIdx:1},i[$._A.SUBDIVISIONS]=i[$._A.POSITION]}(e,i,t),new ce.b(i,t,"line")}function fi(e,t,i){const r=new Array;for(const{index:a,count:s}of e){if(s<=1)continue;const e=3*a,n=e+3*s;r.push({position:t.subarray(e,n),mapPosition:i?i.subarray(e,n):void 0})}return r}function _i(e){return 1.863798+-2.0062872/Math.pow(1+e/18.2313,.8856294)}const vi=(0,j.c)(),yi=(0,j.c)(),wi=4/Math.PI;var bi=i(70189),Mi=i(51635),xi=i(82942),Si=i(35326);class Ci{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return(0,n.pC)(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this.resourceFactory.recreateGeometry?(0,n.Wi)(this._resources)||(this.ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?(0,n.Wi)(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var e;this._destroyResources();const t=this.resourceFactory.createResources();this._resources={layerView:new Ri({view:this.resourceFactory.view}),external:t,geometriesAdded:!1},this._syncGeometriesToRenderer();const i=null==(e=this.resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;i&&i.registerDrapeSource(this._resources.layerView)}_destroyResources(){var e;if((0,n.Wi)(this._resources))return;this.ensureRenderGeometriesRemoved();const t=null==(e=this.resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;t&&t.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this.ensureRenderGeometriesAdded():this.ensureRenderGeometriesRemoved()}ensureRenderGeometriesRemoved(){var e;!(0,n.Wi)(this._resources)&&null!=(e=this.resourceFactory.view)&&e.basemapTerrain&&this._resources.geometriesAdded&&(this.resourceFactory.view.basemapTerrain.overlayManager.renderer.removeGeometries(this._resources.external.geometries,this._resources.layerView,2),this._resources.geometriesAdded=!1)}ensureRenderGeometriesAdded(){(0,n.Wi)(this._resources)||this._resources.geometriesAdded||(this.resourceFactory.view.basemapTerrain.overlayManager.renderer.addGeometries(this._resources.external.geometries,this._resources.layerView,2),this._resources.geometriesAdded=!0)}}let Ri=class extends((0,Si.I)(pe.default)){constructor(e){super(e),this.drapeSourceType=1}};(0,a._)([(0,l.Cb)({constructOnly:!0})],Ri.prototype,"view",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],Ri.prototype,"drapeSourceType",void 0),Ri=(0,a._)([(0,h.j)("DrapedVisualElementLayerView")],Ri);class Ei{constructor(e){this.view=null,this._attachmentOrigin=(0,B.Tx)(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new c.Z,this._isDraped=!1,this._geometry=null,this._width=1,this._color=(0,bi.f)(1,0,1,1),this._innerWidth=0,this._innerColor=(0,bi.f)(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=8,this.resources=new xi.O({view:e.view,createResources:e=>this.createResources(e),recreateGeometry:(e,t)=>(e.geometries.length=0,this.recreateGeometry(t,e.material,e.geometries),e.geometries)}),this._attachmentOrigin.spatialReference=e.view.spatialReference,this.drapedResources=new Ci({view:e.view,createResources:()=>this.createDrapedResources(),recreateGeometry:e=>{e.geometries=this.createRenderGeometriesDraped(e.material),this.attachmentOriginChanged()}});let t=!0;this._laserline=new Mi.W({view:e.view});for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this.updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}get laserlineAttached(){return this.attached&&this.visible&&(0,n.pC)(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e,this.drapedResources.visible=e,this._laserline.attached=this.laserlineAttached}get attached(){return this.resources.attached||this.drapedResources.attached}set attached(e){this.updateAttached(e)}updateAttached(e){this.resources.attached=!this.isDraped&&e,this.drapedResources.attached=this.isDraped&&e,this._laserline.attached=this.laserlineAttached,this.attached&&this.attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this.updateMaterial())}get color(){return this._color}set color(e){(0,N.g)(e,this._color)||((0,N.c)(this._color,e),this.updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this.updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){(0,N.g)(e,this._innerColor)||((0,N.c)(this._innerColor,e),this.updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=(0,n.pC)(e)!==(0,n.pC)(this._stipplePattern);this._stipplePattern=e,t?this.resources.recreate():this.updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&(0,N.g)(e,this._stippleOffColor)||(this._stippleOffColor=e?(0,bi.a)(e):null,this.updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this.updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,(0,n.pC)(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=(0,n.pC)(this.resources.resources)?this.resources.resources.geometries:null;if(!e||0===e.length)return null;(0,U.s)(Ti,0,0,0);const t=$._A.POSITION;let i=0;for(const r of e){const e=r.getAttribute(t),a=r.getIndices(t),s=(0,n.Wg)(this.resources.resources).material.isClosed(e.data,a);(0,q.qZ)(e,a,s,Oi)&&((0,U.b)(Ti,Ti,Oi),i++)}return 0===i?null:((0,U.a)(Ti,Ti,1/i),this.view.renderCoordsHelper.fromRenderCoords(Ti,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}updateMaterial(){(0,n.pC)(this.resources.resources)&&this.resources.resources.material.setParameterValues(this.materialParameters),(0,n.pC)(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameterValues(this.materialParameters)}get isClosed(){return(0,n.pC)(this.geometry)&&"polygon"===this.geometry.type}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",stippleIntegerRepeats:!0,polygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}get normalizedRenderOccluded(){return this.isDraped&&8===this._renderOccluded?4:this._renderOccluded}recreateGeometry(e,t,i){const r=this.createRenderGeometries();for(const a of r)e.addGeometry(a,t),i.push(a);this.attachmentOriginChanged()}attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}createResources(e){const t=new K.U(this.materialParameters,"lineVisualElement"),i=[];return this.recreateGeometry(e,t,i),{material:t,geometries:i,forEach:e=>{e(t),i.forEach(e)}}}createDrapedResources(){const e=new K.U(this.materialParameters,"lineVisualElement");return{material:e,geometries:this.createRenderGeometriesDraped(e)}}createRenderGeometriesDraped(e){const t=this.geometry;if((0,n.Wi)(t))return[];const i=function(e,t){const i="polygon"===e.type?1:0,r="polygon"===e.type?e.rings:e.paths,{position:a,outlines:s}=le(r,!1,i),n=(0,k.CM)(a,e.spatialReference,0,a,t,0,a.length/3);for(let e=2;e<a.length;e+=3)a[e]=-2;return{lines:n?fi(s,a):[],projectionSuccess:n}}(t,this.view.basemapTerrain.spatialReference),r=[];for(const{position:t}of i.lines){const i={attributeData:{position:t},removeDuplicateStartEnd:this.isClosed?1:0},a=new ae(mi(i));a.material=e;const s=(0,Z.cS)(Di);(0,Z.G1)(s,t),(0,U.s)(a.center,.5*(s[0]+s[3]),.5*(s[1]+s[4]),0),a.bsRadius=.5*Math.sqrt((s[3]-s[0])*(s[3]-s[0])+(s[4]-s[1])*(s[4]-s[1])),r.push(a)}return r}calculateMapBounds(e){if((0,n.Wi)(this.resources.resources))return!1;const t=this.view.renderCoordsHelper;for(const i of this.resources.resources.geometries){const r=i.data.getAttribute("position"),a=r.data,s=new Float64Array(a.length);(0,k.CM)(r.data,t.spatialReference,0,s,this.view.spatialReference,0,a.length/3),(0,Z.G1)(e,s)}return!0}createRenderGeometries(){const e=this.geometry;if((0,n.Wi)(e))return[];const t=function(e,t,i,r){const a="polygon"===e.type?1:0,s="polygon"===e.type?e.rings:e.paths,{position:n,outlines:o}=le(s,e.hasZ,a),l=new Float64Array(n.length),h=(0,de.rR)(n,e.spatialReference,0,l,0,n,0,n.length/3,t,i,r),c=null!=h;return{lines:c?fi(o,n,l):[],projectionSuccess:c,sampledElevation:h}}(e,this.view.elevationProvider,this.view.renderCoordsHelper,Y.o.fromElevationInfo(this.elevationInfo)),i=[],r=[];for(const{position:e,mapPosition:a}of t.lines){const t=mi({attributeData:{position:e,mapPosition:a},removeDuplicateStartEnd:this.isClosed?1:0});i.push(new X.Z(t,"geometryOutlineVisualElement")),r.push(e)}return this._laserline.pathVerticalPlane=r,i}}const Di=(0,Z.Ue)(),Oi=(0,j.c)(),Ti=(0,j.c)();var Pi=i(39746),Ai=i(74218);(0,j.c)();var Ii=i(71702),Li=i(20147),Gi=i(12587);class Vi extends mt.A{initializeProgram(e){const t=Vi.shader.get(),i=this.configuration,r=t.build({output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:i.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,screenSizeEnabled:i.screenSizeEnabled,shadingEnabled:i.shadingEnabled,OITEnabled:0===i.transparencyPassType});return new vt.Z(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),ji)}bindPass(e,t,i){const{screenSizeEnabled:r,shadingEnabled:a}=this.configuration,{color:s,shadingTint:n,shadingDirection:o}=t;wt.G.bindProjectionMatrix(this.program,i.camera.projectionMatrix),this.program.setUniform4fv("color",s),a&&(this.program.setUniform4fv("shadedColor",this.blendColor(Ui,n,s)),this.program.setUniform3fv("shadingDirection",o),this.program.setUniformMatrix4fv("viewNormal",i.camera.viewInverseTransposeMatrix)),r&&Li.A.bindPassUniforms(this.program,t,i)}blendColor(e,t,i){const r=1-t[3],a=t[3]+i[3]*r;return 0===a?(e[3]=a,e):(e[0]=(t[0]*t[3]+i[0]*i[3]*r)/a,e[1]=(t[1]*t[3]+i[1]*i[3]*r)/a,e[2]=(t[2]*t[3]+i[2]*i[3]*r)/a,e[3]=i[3],e)}bindDraw(e){wt.G.bindView(this.program,e),wt.G.bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),Mt.p.bindUniformsWithOrigin(this.program,this.configuration,e)}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e;return(0,yt.sm)({blending:0!==t.output&&7!==t.output||!t.transparent?null:i?St.wu:(0,St.$L)(e),culling:(a=t.cullFace,0!==a&&{face:1===a?1028:1029,mode:2305}),depthTest:{func:r?513:t.shadingEnabled?515:513},depthWrite:i?t.writeDepth&&yt.LZ:(0,St.Vc)(e),colorWrite:yt.BK,polygonOffset:i||r?null:St.E0});var a}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}Vi.shader=new gt.J(Gi.S,(()=>i.e(5316).then(i.bind(i,35316))));class zi extends ft.m{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.sliceHighlightDisabled=!1,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.transparencyPassType=3}}(0,a._)([(0,ft.o)({count:8})],zi.prototype,"output",void 0),(0,a._)([(0,ft.o)({count:3})],zi.prototype,"cullFace",void 0),(0,a._)([(0,ft.o)()],zi.prototype,"slicePlaneEnabled",void 0),(0,a._)([(0,ft.o)()],zi.prototype,"sliceHighlightDisabled",void 0),(0,a._)([(0,ft.o)()],zi.prototype,"transparent",void 0),(0,a._)([(0,ft.o)()],zi.prototype,"writeDepth",void 0),(0,a._)([(0,ft.o)()],zi.prototype,"screenSizeEnabled",void 0),(0,a._)([(0,ft.o)()],zi.prototype,"shadingEnabled",void 0),(0,a._)([(0,ft.o)({count:4})],zi.prototype,"transparencyPassType",void 0);const Hi="position",Wi="normal",Fi="offset",ji={position:0,normal:1,offset:2},Ui=(0,w.a)();var ki=i(12608),Ni=i(80905),Zi=i(30090),Bi=i(13405);class qi extends ot.F5{constructor(e,t){super(t,e,Xi),this.supportsEdges=!0,this.techniqueConfig=new zi,this._vertexAttributeLocations=ji}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.screenSizeEnabled=this.params.screenSizeEnabled,this.techniqueConfig.shadingEnabled=this.params.shadingEnabled,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,r,a,s,n){if(this.params.screenSizeEnabled){const i=e.getAttribute(Fi),o={applyToVertex:(e,t,a,s)=>{const n=(0,U.s)(Ki,i.data[3*s+0],i.data[3*s+1],i.data[3*s+2]),o=(0,U.s)(Qi,e,t,a);return(0,U.a)(n,n,this.params.screenSize*r.camera.computeRenderPixelSizeAt(n)),(0,U.b)(o,o,n),[o[0],o[1],o[2]]},applyToAabb:e=>{const t=(0,Z.be)(e,Ki);return(0,Z.bA)(e,this.params.screenSize*r.camera.computeRenderPixelSizeAt(t))}};(0,Zi.Bw)(e,t,r,a,s,o,n)}else(0,Zi.Bw)(e,t,r,a,s,void 0,n)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output?new Yi(e):void 0}createBufferWriter(){return new $i(this.params.screenSizeEnabled)}}class Yi extends pt.Z{constructor(e){super(e),this.updateParameters()}updateParameters(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(Vi,this.material.getTechniqueConfig(this.output,e),this.technique)}beginSlot(e){if(4===this.output)return 3===e;let t=3;return this.technique.configuration.transparent&&(t=this.technique.configuration.writeDepth?5:8),e===t}ensureParameters(e){this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)}}const Xi={color:[1,1,1,1],shadingTint:[0,0,0,.25],shadingDirection:(0,U.n)((0,j.c)(),[.5,-.5,-.5]),transparent:!1,writeDepth:!0,slicePlaneEnabled:!1,cullFace:0,screenSizeEnabled:!1,screenSize:14,shadingEnabled:!0,...ot.zh};class $i{constructor(e){this.screenSizeEnabled=e;const t=(0,Ni.U$)().vec3f(Hi).vec3f(Wi);this.screenSizeEnabled&&t.vec3f(Fi),this.vertexBufferLayout=t}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices[Hi].length}write(e,t,i,r){if((0,Bi.NK)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r),this.screenSizeEnabled){if(!(Fi in t.vertexAttr))throw new Error(`${Fi} vertex attribute required for screenSizeEnabled ShadedColorMaterial`);{const a=t.vertexAttr[Fi],s=t.indices[Fi];(0,te.hu)(3===a.size);const n=i.getField(Fi,ki.ct);if(!n)throw new Error("unable to acquire view for "+Fi);(0,Bi.ho)(s,a.data,e.invTranspTransformation,n,r)}}}}const Ki=(0,j.c)(),Qi=(0,j.c)();class Ji extends Ii._{constructor(e){super(e),this.view=null,this._renderOccluded=4,this._vertices=null,this._spatialReference=null,this._color=F.colorToVec4(F.reshapeManipulators.vertex.color),this._size=F.reshapeManipulators.vertex.size,this._outlineColor=F.colorToVec4(F.reshapeManipulators.vertex.outlineColor),this._outlineSize=F.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial(),this.updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){(0,N.g)(e,this._color)||((0,N.c)(this._color,e),this.updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this.updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){(0,N.g)(e,this._outlineColor)||((0,N.c)(this._outlineColor,e),this.updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this.updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSize:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSize:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}updateMaterial(){this.attached&&this.vertexMaterial.setParameterValues(this.vertexMaterialParameters)}updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameterValues(this.vertexOutlineMaterialParameters)}createRenderGeometries(){const e=this.vertices;if((0,n.Wi)(e)||0===e.length)return[];const t=function(e,t,i,r,a){const s=new Float64Array(3*e.length),n=new Float64Array(s.length);e.forEach(((e,t)=>{s[3*t+0]=e[0],s[3*t+1]=e[1],s[3*t+2]=e.length>2?e[2]:0}));const o=(0,de.rR)(s,t,0,n,0,s,0,s.length/3,i,r,a),l=null!=o;return{numVertices:e.length,position:s,mapPosition:n,projectionSuccess:l,sampledElevation:o}}(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Y.o.fromElevationInfo(this.elevationInfo)),i=[],r=t.numVertices,a=t.position;for(let e=0;e<r;++e){const t=(0,U.s)(er,a[3*e+0],a[3*e+1],a[3*e+2]),r=new X.Z(tr(.5,16,16,t),"VerticesVisualElement-vertex"),s=new X.Z(tr(.5,16,16,t),"VerticesVisualElement-vertexOutline");i.push({vertexGeometry:r,vertexOutlineGeometry:s})}return i}createGeometries(e){const t=this.createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:r}of t)e.addGeometry(i,this.vertexMaterial),e.addGeometry(r,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new qi({...this.vertexMaterialParameters,writeDepth:!0,cullFace:2,screenSizeEnabled:!0},"manipulator"),this.vertexOutlineMaterial=new qi({...this.vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:1,screenSizeEnabled:!0,shadingEnabled:!1},"manipulator-outline")}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalResource(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}const er=(0,j.c)();function tr(e,t,i,r){const a=Pi.Z.createSphereGeometry(e,t,i,{attributes:{position:Fi,uv:null}});return a.indices[Hi]=new Uint32Array(a.indexCount),a.vertexAttributes[Hi]={size:3,data:Float64Array.from(r),offsetIdx:0,strideIdx:3},a}let ir=class extends(c.Z.EventedMixin(m.m)){constructor(e){super(e),this.drawOperation=null,this._createGraphic=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._stagedVerticesVisualElement=null,this.hasZ=!0,this.defaultZ=0,this.elevationInfo=null,this.snapToScene=!1,this.snappingOptions=new f.g,this.mode=null,this.geometryType=null,this.type="draw-3d"}initialize(){const e=(0,n.Pt)(this.elevationInfo,{mode:this.hasZ?"absolute-height":"on-the-ground",offset:0});this._internalGraphicsLayer=new u.default({elevationInfo:e}),this.view.map.layers.add(this._internalGraphicsLayer),this.drawOperation=new r.w({view:this.view,manipulators:this.manipulators,geometryType:rr(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,snappingDrawSurface:new g.i(this.view,e,[this._internalGraphicsLayer]),hasM:!1,elevationInfo:e,snappingOptions:this.snappingOptions}),this.drawOperation.on("vertex-add",(e=>this.onVertexAdd(e))),this.drawOperation.on("vertex-remove",(e=>this.onVertexRemove(e))),this.drawOperation.on("vertex-update",(e=>this.onVertexUpdate(e))),this.drawOperation.on("cursor-update",(e=>this.onCursorUpdate(e))),this.drawOperation.on("complete",(e=>this.onComplete(e)))}destroy(){this.drawOperation.destroy(),this.drawOperation=null,this._destroyAllVisualisations(),this.view.map.remove(this._internalGraphicsLayer),this._set("view",null)}onInputEvent(e){this.drawOperation.onInputEvent(e)}_getCreateGeometry(e,t=!1){if(null==this.drawOperation)return null;const i=(0,n.pC)(e)?e:this.drawOperation.hasStagedVertex?this.drawOperation.numVertices-1:null,r=this.drawOperation.vertices;if(0===r.length)return null;const a=this.drawOperation.spatialReference,s=r,o=s.slice(),l=[];(0,n.pC)(i)&&(o.splice(i,1),l.push(s[i]));const h={regularVertices:null,stagedVertices:null,full:null,outline:null},c="3d"===this.view.type&&"global"===this.view.viewingMode;switch(this.geometryType){case"point":h.regularVertices=o,h.stagedVertices=l,h.full=this.drawOperation.coordinateHelper.createPointFromArray(r[0]);break;case"polyline":h.regularVertices=o,h.stagedVertices=l,s.length>0&&(h.full=(0,_.DF)([s],a,c));break;case"polygon":h.regularVertices=o,h.stagedVertices=l,s.length>0&&(h.full=(0,_.p)([s],a,c,!0));break;case"circle":if(s.length>0){const e=(0,_.Gn)(this.view,r[0]);if(1===s.length&&t){const t=s[0],i=e.makeMapPoint(t[0]+ar*this.view.resolution,t[1]);h.full=(0,_.y)([t,i],e,!0)}else 2===s.length&&(h.full=this.forceUniformSize?(0,_.y)(r,e,this.centered):(0,_.n_)(r,e,this.centered))}break;case"rectangle":if(s.length>0){const e=(0,_.Gn)(this.view,r[0]);if(1===s.length&&t){const t=s[0],i=e.makeMapPoint(t[0]+ar*this.view.resolution,t[1]);h.full=(0,_.yL)([t,i],e,!0)}else 2===s.length&&(h.full=this.forceUniformSize?(0,_.yL)(r,e,this.centered):(0,_.MC)(r,e,this.centered))}break;default:return null}switch(this.geometryType){case"point":break;case"polyline":s.length>1&&(h.outline=(0,_.DF)([s],a,c));break;case"polygon":s.length>1&&(h.outline=(0,_.p)([s],a,c));break;case"circle":case"rectangle":(0,n.pC)(h.full)&&"polygon"===h.full.type&&(h.outline=(0,_.p)(h.full.rings,a,c))}return h}_destroyAllVisualisations(){this._destroyCreateGraphic(),this._destroyOutlineVisualElement(),this._destroyVerticesVisualElement(),this._destroyStagedVerticesVisualElement()}_destroyCreateGraphic(){(0,n.pC)(this._createGraphic)&&(this._internalGraphicsLayer.remove(this._createGraphic),this._createGraphic.destroy(),this._createGraphic=null)}_destroyOutlineVisualElement(){(0,n.pC)(this._outlineVisualElement)&&(this._outlineVisualElement.destroy(),this._outlineVisualElement=null)}_destroyVerticesVisualElement(){(0,n.pC)(this._verticesVisualElement)&&(this._verticesVisualElement.destroy(),this._verticesVisualElement=null)}_destroyStagedVerticesVisualElement(){(0,n.pC)(this._stagedVerticesVisualElement)&&(this._stagedVerticesVisualElement.destroy(),this._stagedVerticesVisualElement=null)}_updateCreateGraphic(e=null){const t=this._getCreateGeometry(e);if((0,n.Wi)(t))return void this._destroyAllVisualisations();const i=this._internalGraphicsLayer.elevationInfo,r="on-the-ground"===(0,p.Zz)(this.hasZ,i);(0,n.pC)(t.outline)?(0,n.Wi)(this._outlineVisualElement)?(this._outlineVisualElement=new Ei({view:this.view,geometry:t.outline,elevationInfo:(0,n.Wg)(i),isDraped:r,attached:!1}),F.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),F.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0):this._outlineVisualElement.geometry=t.outline:this._destroyOutlineVisualElement(),(0,n.pC)(t.regularVertices)?(0,n.Wi)(this._verticesVisualElement)?(this._verticesVisualElement=new Ji({view:this.view,spatialReference:this.view.spatialReference,vertices:t.regularVertices,elevationInfo:(0,n.Wg)(this._internalGraphicsLayer.elevationInfo),renderOccluded:F.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0):this._verticesVisualElement.vertices=t.regularVertices:this._destroyVerticesVisualElement(),(0,n.pC)(t.stagedVertices)?(0,n.Wi)(this._stagedVerticesVisualElement)?(this._stagedVerticesVisualElement=new Ji({view:this.view,spatialReference:this.view.spatialReference,vertices:t.stagedVertices,elevationInfo:(0,n.Wg)(this._internalGraphicsLayer.elevationInfo),renderOccluded:F.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._stagedVerticesVisualElement.color=F.colorToVec4(F.reshapeManipulators.selected.color),this._stagedVerticesVisualElement.attached=!0):this._stagedVerticesVisualElement.vertices=t.stagedVertices:this._destroyStagedVerticesVisualElement(),(0,n.pC)(t.full)?(0,n.Wi)(this._createGraphic)?(this._createGraphic=new d.default({geometry:t.full,symbol:this.createGraphicSymbol}),this._internalGraphicsLayer.add(this._createGraphic),this.view.maskOccludee(this._createGraphic),this.notifyChange("createGraphic")):this._createGraphic.geometry=t.full:this._destroyCreateGraphic()}get createGraphic(){return this._createGraphic}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}set centered(e){this._set("centered",e),this._updateCreateGraphic()}set forceUniformSize(e){this._set("forceUniformSize",e),this._updateCreateGraphic()}reset(){}get canRedo(){return this.drawOperation.canRedo}redo(){this.drawOperation.redo()}get canUndo(){return this.drawOperation.canUndo}undo(){this.drawOperation.undo()}completeCreateOperation(){this.drawOperation.complete()}activate(){}deactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}getVertexCoords(){return this.drawOperation.vertices}onVertexAdd(e){this._updateCreateGraphic(),this.emit("vertex-add",e)}onVertexRemove(e){this._updateCreateGraphic(),this.emit("vertex-remove",e)}onVertexUpdate(e){this._updateCreateGraphic(),this.emit("vertex-update",e)}onCursorUpdate(e){this._updateCreateGraphic(1===e.vertices.length?e.vertices[0].vertexIndex:null),this.emit("cursor-update",e)}onComplete(e){this._updateCreateGraphic();let t=null;if(this.drawOperation.isCompleted){const e=this._getCreateGeometry(null,!0);(0,n.pC)(e)&&(t=new d.default({geometry:e.full,symbol:this.createGraphicSymbol}))}this.emit("complete",{graphic:t,...e})}};function rr(e){switch(e){case"point":case"polyline":case"polygon":return e;case"circle":case"rectangle":return"segment";default:return null}}(0,a._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],ir.prototype,"view",void 0),(0,a._)([(0,l.Cb)()],ir.prototype,"createGraphicSymbol",void 0),(0,a._)([(0,l.Cb)()],ir.prototype,"createGraphic",null),(0,a._)([(0,l.Cb)({value:!0})],ir.prototype,"enabled",null),(0,a._)([(0,l.Cb)({value:!0})],ir.prototype,"centered",null),(0,a._)([(0,l.Cb)({value:!0})],ir.prototype,"forceUniformSize",null),(0,a._)([(0,l.Cb)({constructOnly:!0})],ir.prototype,"hasZ",void 0),(0,a._)([(0,l.Cb)({nonNullable:!0})],ir.prototype,"defaultZ",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],ir.prototype,"elevationInfo",void 0),(0,a._)([(0,l.Cb)()],ir.prototype,"snapToScene",void 0),(0,a._)([(0,l.Cb)()],ir.prototype,"snappingOptions",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],ir.prototype,"mode",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],ir.prototype,"geometryType",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],ir.prototype,"type",void 0),ir=(0,a._)([(0,h.j)("esri.views.3d.interactive.editingTools.draw3D.DrawTool")],ir);const ar=48;var sr=i(5632),nr=i(83477),or=i(53640),lr=i(8344),hr=i(58722),cr=i(36144),dr=i(94588),ur=i(65575),pr=i(61106),gr=(i(36348),i(89333)),mr=i(30663),fr=i(98501),_r=i(19132);class vr{constructor(e){this.camera=new Ge,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=[],this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=(0,ee.a)(),this._worldFrame=null,this._renderLocation=(0,j.c)(),this._renderLocationDirty=!0,this._location=new pr.Z({x:0,y:0,z:0}),this._elevationAlignedLocation=new pr.Z,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.cursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=0,this._focused=!1,this.events=new c.Z.EventEmitter,this._screenLocation={screenPointArray:(0,Ce.s1)(),renderScreenPointArray:(0,Ce.J$)(),pixelSize:0},this._screenLocationDirty=!0,this._applyObjectTransform=null,this._engineResourcesAddedToStage=!1,this._engineResources=null,this._attached=!1,this._engineLayerId=null,this._materialIdReferences=null,this._location.spatialReference=e.view.spatialReference;for(const t in e)this[t]=e[t];this.view.state&&this.view.state.camera&&this.camera.copyFrom(this.view.state.camera)}destroy(){this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this.camera=null}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,1===this._noDisplayCount&&this._updateEngineObject(),{remove:(0,ur.IH)((()=>{this._noDisplayCount--,0===this._noDisplayCount&&this._updateEngineObject()}))}}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){yr(e)&&(this._screenLocationDirty=!0),(0,J.c)(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=(0,ee.a)()),function(e,t,i){switch(e.viewingMode){case"local":return(0,J.i)(i),!0;case"global":{const r=(0,gr.Iu)(e.renderCoordsHelper.spatialReference);(0,k.C1)(t,0,Er,0,r.radius),(0,k.tw)((0,ne.Vl)(Er[1]),(0,ne.Vl)(Er[0]),i)}}}(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){(0,hr.WG)(e,this._location),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){(0,hr.WG)(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y;const e=(0,n.pC)(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=this.location.spatialReference,this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,t){t?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:!0===e?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this.ensureScreenLocation(),this._screenLocation}ensureScreenLocation(){if(!this._screenLocationDirty)return;let e;if(this._screenLocation.pixelSize=this.camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1,yr(this._modelTransform)){const t=this._calculateModelTransformOffset(Ar);e=(0,U.b)(t,t,this.renderLocation)}else e=this.renderLocation;this.camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this.camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}intersectionDistance(e,t){if(!this.available)return null;const i=(0,Ce.md)(e,wr),r=this._getCollisionRadius(t),a=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if((0,Re.j)(this.screenLocation.screenPointArray,i)<r*r)return this.screenLocation.renderScreenPointArray[2]+a;break;case"line":{const e=this.collisionType.paths,t=this._getWorldToScreenObjectScale(),s=this._calculateObjectTransform(t,Cr),o=r*this.screenLocation.pixelSize,l=De.kx.fromScreen(this.camera,i,Mr);if((0,n.Wi)(l))return null;for(const t of e){if(0===t.length)continue;const e=(0,U.i)(Er,t[0],s);for(let i=1;i<t.length;i++){const r=(0,U.i)(Dr,t[i],s),n=De.KD.closestRayDistance2(De.KD.fromPoints(e,r,br),l);if(null!=n&&n<o*o){const t=(0,U.b)(lr.WM.get(),e,r);(0,U.a)(t,t,.5);const i=(0,Ce.So)(lr.WM.get());return this.camera.projectToRenderScreen(t,i),i[2]+a}(0,U.g)(e,r)}}break}case"disc":{var s;const e=this.collisionType.direction,t=null!=(s=this.collisionType.offset)?s:j.Z,o=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(o,Cr),h=r*this.screenLocation.pixelSize,c=De.kx.fromScreen(this.camera,i,Mr);if((0,n.Wi)(c))return null;const d=(0,fr.f)(xr,l),u=(0,U.t)(Tr,e,d),p=(0,U.i)(Pr,t,l);De.yC.fromPositionAndNormal(p,u,Rr);const g=Or;if(De.yC.intersectRay(Rr,c,g)&&(0,U.h)(g,p)<h*h)return this.screenLocation.renderScreenPointArray[2]+a;break}case"ribbon":{const{paths:e,direction:t}=this.collisionType,s=this._getWorldToScreenObjectScale(),o=this._calculateObjectTransform(s,Cr),l=r*this.camera.computeScreenPixelSizeAt(this.renderLocation),h=De.kx.fromScreen(this.camera,i,Mr);if((0,n.Wi)(h))return null;const c=(0,fr.f)(xr,o),d=(0,U.t)(Tr,t,c),u=this._calculateModelTransformPosition(Pr);De.yC.fromPositionAndNormal(u,d,Rr);const p=Or;if(!De.yC.intersectRay(Rr,h,p))break;for(const t of e){if(0===t.length)continue;const e=(0,U.i)(Er,t[0],o);for(let i=1;i<t.length;i++){const r=(0,U.i)(Dr,t[i],o),s=De.KD.distance2(De.KD.fromPoints(e,r,br),p);if(null!=s&&s<l*l){const t=(0,U.b)(lr.WM.get(),e,r);(0,U.a)(t,t,.5);const i=(0,Ce.So)(lr.WM.get());return this.camera.projectToRenderScreen(t,i),i[2]+a}(0,U.g)(e,r)}}break}default:(0,dr.Bg)(this.collisionType)}return null}attach(e={manipulator3D:{}}){if(!this.view._stage)return;const t=e.manipulator3D;if(this._engineLayerId=t.engineLayerId,(0,n.Wi)(this._engineLayerId)){const e=new it.Z("manipulator-3d",{isPickable:!1});this.view._stage.add(0,e),this.view._stage.addToViewContent([e.id]),this._engineLayerId=e.id,t.engineLayerId=e.id}t.engineLayerReferences=(t.engineLayerReferences||0)+1,this._materialIdReferences=t.materialIdReferences,(0,n.Wi)(this._materialIdReferences)&&(this._materialIdReferences=new Map,t.materialIdReferences=this._materialIdReferences),this.camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),(0,k.Up)(this._location.spatialReference,this.view.spatialReference)||(this.location=new pr.Z({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){const t=e.manipulator3D;t.engineLayerReferences--;const i=0===t.engineLayerReferences;i&&(t.engineLayerId=null),this._removeResourcesFromStage(i),this._engineResources=null,this._engineLayerId=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this.camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){(0,k.nF)(this.location,Ir,e.spatialReference),(0,Fe.Qn)(e.extent,Ir)&&(this.location=this._location)}_evaluateElevationAlignment(e=this.location){if((0,n.Wi)(this.elevationInfo))return!1;let t=null,i=0;const r=(0,n.Pt)(this.elevationInfo.offset,0);switch(this.elevationInfo.mode){case"on-the-ground":t=(0,_r.KO)(this.view.elevationProvider,e,"ground")||0;break;case"relative-to-ground":i=((0,_r.KO)(this.view.elevationProvider,e,"ground")||0)+r;break;case"relative-to-scene":i=((0,_r.KO)(this.view.elevationProvider,e,"scene")||0)+r;break;case"absolute-height":i=r}return(i!==this._elevation.offset||t!==this._elevation.override)&&(this._elevation.offset=i,this._elevation.override=t,!0)}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),t=Cr;if(!0===this.autoScaleRenderObjects){const i=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(i,t)}else this._calculateObjectTransform(e,t);const{objectsByState:i}=this._ensureEngineResources(),r=(this.focused?2:1)|(this.selected?8:4),a=this._noDisplayCount>0;for(const{stateMask:e,objects:s}of i){if(a){for(const e of s)e.setVisible(!1);continue}const i=!(0!=(15&e))||(r&e)==(15&e),n=!(0!=(65520&e))||(this.state&e)==(65520&e);if(i&&n)for(const e of s)e.setVisible(!0),e.objectTransformation=t;else for(const e of s)e.setVisible(!1)}}_ensureEngineResources(){if((0,n.Wi)(this._engineResources)){const e=this.view._stage.getContent(0,(0,n.Wg)(this._engineLayerId)),t=[],i=new Set;this.renderObjects.forEach((({material:e})=>{i.has(e)||(t.push(e),i.add(e))}));const r=(e,t)=>{const{geometry:i,material:r,transform:a}=t;Array.isArray(i)?i.forEach((t=>e.addGeometry(t,r,a))):e.addGeometry(i,r,a)},a=new Map;this.renderObjects.forEach((e=>{const t=new tt.Z({idHint:"manipulator",castShadow:!1});r(t,e);const i=e.stateMask||0,s=a.get(i)||[];s.push(t),a.set(i,s)}));const s=[];a.forEach(((e,t)=>{s.push({stateMask:t,objects:e})})),this._engineResources={objectsByState:s,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){if(this._engineResourcesAddedToStage||(0,n.Wi)(this._engineResources))return;const{objectsByState:e,layer:t,materials:i}=this._engineResources;i.forEach((e=>{const t=(0,n.Wg)(this._materialIdReferences),i=t.get(e.id)||0;0===i&&this.view._stage.add(3,e),t.set(e.id,i+1)})),e.forEach((({objects:e})=>{e.forEach((e=>{t.addObject(e),this.view._stage.add(1,e)}))})),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(e=!1){if(!this._engineResourcesAddedToStage||(0,n.Wi)(this._engineResources))return;const{objectsByState:t,layer:i,materials:r}=this._engineResources;t.forEach((({objects:e})=>{e.forEach((e=>{i.removeObject(e),this.view._stage.remove(1,e.id)}))})),r.forEach((e=>{const t=(0,n.Wg)(this._materialIdReferences),i=t.get(e.id);1===i?(this.view._stage.remove(3,e.id),t.delete(e.id)):t.set(e.id,i-1)})),e&&this.view._stage.remove(0,i.id),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*("touch"===e?this.touchMultiplier:1)}_getFocusedSize(e,t){return e*(t?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,Sr);return(0,U.s)(e,i[12],i[13],i[14])}_calculateModelTransformOffset(e){const t=this._calculateModelTransformPosition(e);return(0,U.f)(e,t,this.renderLocation)}_calculateObjectTransform(e,t){return(0,J.d)(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&(0,J.m)(t,t,this._worldFrame),(0,J.m)(t,t,this._modelTransform),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,(0,n.pC)(this._applyObjectTransform)&&this._applyObjectTransform(t),t}get test(){let e=!1;if((0,n.pC)(this._engineResources))for(const t in this._engineResources.objectsByState){const i=this._engineResources.objectsByState[t];for(const t of i.objects)if(t.isVisible){e=!0;break}if(e)break}return{areAnyResourcesVisible:e}}}function yr(e){return 0!==e[12]||0!==e[13]||0!==e[14]}const wr=(0,Ce.s1)(),br=De.KD.create(),Mr=De.kx.create(),xr=(0,mr.a)(),Sr=(0,ee.a)(),Cr=(0,ee.a)(),Rr=De.yC.create(),Er=(0,j.c)(),Dr=(0,j.c)(),Or=(0,j.c)(),Tr=(0,j.c)(),Pr=(0,j.c)(),Ar=(0,j.c)(),Ir=new pr.Z({x:0,y:0,z:0,spatialReference:null});function Lr(e,t=4){const i=(0,w.b)(e[0],e[1],e[2],e.length>3?e[3]:1),r=e[3]<1;return new qi({color:i,transparent:r,writeDepth:!0,cullFace:2,renderOccluded:t},"manipulator")}function Gr(e,t=4){const i=(0,w.b)(e[0],e[1],e[2],4===e.length?e[3]:1);return new cr.E({color:i,transparent:!0,writeDepth:!0,cullFace:1,renderOccluded:t},"manipulator-outline")}function Vr(e,t,i,r){const a=(0,U.f)(lr.WM.get(),e,i),s=function(e,t,i,r){const a=(0,U.n)(lr.WM.get(),e),s=(0,U.n)(lr.WM.get(),t),n=(0,U.c)(lr.WM.get(),a,s);return r[0]=a[0],r[1]=a[1],r[2]=a[2],r[3]=0,r[4]=s[0],r[5]=s[1],r[6]=s[2],r[7]=0,r[8]=n[0],r[9]=n[1],r[10]=n[2],r[11]=0,r[12]=i[0],r[13]=i[1],r[14]=i[2],r[15]=1,r}(a,(0,U.c)(lr.WM.get(),r,a),i,lr.MP.get());(0,J.a)(s,s);const n=(0,U.i)(lr.WM.get(),t,s);return Math.atan2(n[1],n[0])}function zr(e,t){const i=e.getViewForGraphic(t);return(0,n.pC)(i)&&"computeAttachmentOrigin"in i?i.computeAttachmentOrigin(t,e.spatialReference):null}function Hr(e,t,i){const r=zr(e,i);(0,n.pC)(r)?t.elevationAlignedLocation=r:function(e,t){if((0,n.Wi)(t))return;const i=(0,Ai.zE)(t);(0,n.Wi)(i)||(e.location=(0,hr.kB)(i))}(t,i.geometry)}var Wr=i(12217);function Fr(e,t=(0,p.RL)(e)){return"on-the-ground"!==t.mode&&!((0,n.Wi)(e.geometry)||!e.geometry.hasZ)}let jr=class extends c.Z.EventedAccessor{constructor(e){super(e),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};(0,a._)([(0,l.Cb)({constructOnly:!0})],jr.prototype,"graphic",void 0),(0,a._)([(0,l.Cb)()],jr.prototype,"tracking",void 0),(0,a._)([(0,l.Cb)()],jr.prototype,"displaying",void 0),(0,a._)([(0,l.Cb)()],jr.prototype,"isDraped",void 0),jr=(0,a._)([(0,h.j)("esri.views.3d.layers.graphics.GraphicState")],jr);var Ur=i(44263);class kr{constructor(){this.grabbingState=0,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=0,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator(((e,t)=>{if(0===t&&(this.zManipulator=e),e instanceof vr&&(e.selected&&(0===this.numSelected&&(this.firstSelected=e),this.numSelected++),(0,n.Wi)(this.firstGrabbedXY)&&e.grabbing&&1===t&&(this.firstGrabbedXY=e)),e.grabbing)switch(this.grabbingState|=1,t){case 0:this.grabbingState|=2;break;case 1:this.grabbingState|=4}}))}}function Nr(e){const{view:t,graphic:i}=e,r=new jr({graphic:i}),a=function(e,t){const{view:i,graphic:r}=e,a=new Ei({view:i,geometry:Zr(r)?r.geometry:null,elevationInfo:(0,p.RL)(r),attached:!1});F.visualElements.lineGraphics.shadowStyle.apply(a);const s=()=>{a.attached=t.displaying};F.visualElements.lineGraphics.outline.apply(a);const n=[t.watch("displaying",s),t.watch("isDraped",(e=>a.isDraped=e)),t.on("changed",(()=>a.geometry=Zr(r)?r.geometry:null)),(0,sr.ed)(a)];return s(),{visualElement:a,remove:()=>(0,sr.AL)(n).remove()}}(e,r),s=[a,function(e,t,i){const{graphic:r,view:a}=e,s=[],o=(0,p.RL)(r),l="on-the-ground"===o.mode||!o.offset&&"absolute-height"!==o.mode,h=new kr,c=new Ur.V({view:a,extensionType:F.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});F.visualElements.pointGraphics.shadowStyle.apply(c);const d=(0,ne.Vl)(F.visualElements.heightPlaneAngleCutoff),u=new Mi.W({view:a,attached:!1,angleCutoff:d});F.visualElements.heightPlane.apply(u);let g=1,m=1;const f=()=>{if(h.update(e),!i.displaying||l&&(i.isDraped||!Zr(r)||!r.geometry.hasZ))return t.laserlineEnabled=!1,c.attached=!1,void(u.attached=!1);t.laserlineEnabled=!0;{const e=4&h.grabbingState?F.visualElements.laserlineAlphaMultiplier:1;e!==g&&(g=e,F.visualElements.lineGraphics.shadowStyle.apply(t,e),F.visualElements.pointGraphics.shadowStyle.apply(c,e))}{const e=2&h.grabbingState?F.visualElements.laserlineAlphaMultiplier:1;e!==m&&(m=e,F.visualElements.heightPlane.apply(u,e))}!function(e,t){const i=1===t.numSelected?t.firstSelected:t.numSelected>1&&(0,n.pC)(t.firstGrabbedXY)?t.firstGrabbedXY:null;(0,n.pC)(i)?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1}(c,h),function(e,t,i,r){if(r.numSelected>0){(0,U.s)(Br,0,0,0);let t=0;e.forEachManipulator(((e,i)=>{1===i&&e.selected&&e instanceof vr&&((0,U.b)(Br,Br,e.renderLocation),t++)})),t>0?(i.heightManifoldTarget=(0,U.a)(Br,Br,1/t),i.attached=!0):i.attached=!1}else{const r=t.attachmentOrigin;(0,n.pC)(r)&&e.view.renderCoordsHelper.toRenderCoords(r,Br)?(i.heightManifoldTarget=Br,i.attached=!0):i.attached=!1}}(e,t,u,h)};F.visualElements.zVerticalLine.apply(c),s.push(i.on("changed",f),i.watch("displaying",f),t.events.on("attachment-origin-changed",f),(0,sr.ed)(c),(0,sr.ed)(u));const _=[],v=()=>{(0,sr.AL)(_).remove(),_.length=0,e.forEachManipulator((e=>_.push(e.events.on("grab-changed",f)))),e.forEachManipulator((e=>_.push(e.events.on("select-changed",f)))),f()};return v(),s.push(e.onManipulatorsChanged(v),(0,sr.iU)((()=>(0,sr.AL)(_)))),(0,sr.AL)(s)}(e,a.visualElement,r),t.maskOccludee(i),t.trackGraphicState(r)];return{visualElement:a.visualElement,remove:()=>(0,sr.AL)(s).remove()}}function Zr(e){return(0,n.pC)(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const Br=(0,j.c)();var qr=i(84845);function Yr(e){const{view:t,graphic:i}=e,r=new jr({graphic:i}),a=[],s=function(e,t,i){const{view:r,graphic:a}=e,s=new qr.L({view:r,geometry:Xr(a)?a.geometry:null,elevationInfo:(0,p.RL)(a),attached:!1});return function(e,t,i,r){(function(e,t,i,r){const{view:a,graphic:s}=e;let o=null;const l=()=>{(0,n.pC)(o)&&(o.remove(),o=null),i.isDraped&&Xr(s)&&(o=function(e,t,i){const r=e.elevationProvider.spatialReference;(0,k.KC)(t,$r,r);const a=$r[0],s=$r[1];return e.elevationProvider.on("elevation-change",(e=>{(0,Fe.jE)(e.extent,a,s)&&i()}))}(a,s.geometry,(()=>{t.geometry=s.geometry}))),t.geometry=Xr(s)?s.geometry:null};r.push(i.on("changed",l),(0,sr.iU)((()=>o))),l()})(e,t,i,r),F.visualElements.pointGraphics.outline.apply(t),r.push((0,me.init)(i,"displaying",(()=>t.attached=i.displaying)))}(e,s,t,i),i.push((0,sr.ed)(s)),s}(e,r,a);return function(e,t,i,r){const{view:a,graphic:s}=e,n=new Ur.V({view:a,extensionType:F.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});F.visualElements.zVerticalLine.apply(n);const o=new Mi.W({view:a,intersectsLineInfinite:!0,attached:!1});F.visualElements.pointGraphics.shadowStyle.apply(o);const l=(0,ne.Vl)(F.visualElements.heightPlaneAngleCutoff),h=new Mi.W({view:a,attached:!1,angleCutoff:l});F.visualElements.heightPlane.apply(h);const c=(0,p.RL)(e.graphic),d=Y.o.fromElevationInfo(c),u="on-the-ground"===c.mode||!c.offset&&"absolute-height"!==c.mode,g=new kr;let m=1,f=1;const _=()=>{g.update(e);const i=u&&(t.isDraped||!Xr(s)||!s.geometry.hasZ);let l=!0;if(!i&&Xr(s)){const e=s.geometry,t=(0,de.w7)(s.geometry,a.elevationProvider,d,a.renderCoordsHelper);(0,U.s)($r,e.x,e.y,t),(0,k.SH)($r,e.spatialReference,$r,a.renderCoordsHelper.spatialReference),n.setStartEndFromWorldDownAtLocation($r),o.intersectsWorldUpAtLocation=$r}else l=!1;{const e=2&g.grabbingState?F.visualElements.laserlineAlphaMultiplier:1;e!==m&&(m=e,F.visualElements.heightPlane.apply(h,e))}{const e=(0,Z.cS)(Kr);!i&&t.displaying&&r.calculateMapBounds(e)&&(0,k.SH)((0,Z.KE)(e,$r),a.spatialReference,$r,a.renderCoordsHelper.spatialReference)?(h.heightManifoldTarget=$r,h.attached=!0):h.attached=!1}{const e=4&g.grabbingState?F.visualElements.laserlineAlphaMultiplier:1;e!==f&&(f=e,F.visualElements.pointGraphics.shadowStyle.apply(o,e))}const c=l&&t.displaying&&!i;o.attached=c,n.attached=c};i.push(t.watch(["displaying","isDraped"],_),t.on("changed",_)),e.forEachManipulator((e=>{i.push(e.events.on("grab-changed",_))})),i.push((0,sr.ed)(o)),i.push((0,sr.ed)(n)),i.push((0,sr.ed)(h)),_()}(e,r,a,s),a.push(t.trackGraphicState(r)),{visualElement:s,remove(){(0,sr.AL)(a).remove()}}}function Xr(e){return(0,n.pC)(e.geometry)&&"point"===e.geometry.type}const $r=(0,j.c)(),Kr=(0,Z.Ue)();function Qr(e){switch((0,n.Wg)(e.graphic.geometry).type){case"point":return Yr(e);case"polygon":case"polyline":return Nr(e);default:return null}}const Jr=[1,.5,0],ea=70,ta=Math.ceil(70/3*2),ia=160,ra=5*Math.PI/12,aa=1*Math.PI/3;var sa=i(70642),na=i(60418);function oa(e,t,i){const r=t[0],a=t[1],s=t[2],n=t[3],o=i[0],l=i[1],h=i[2],c=i[3];return e[0]=r*o+s*l,e[1]=a*o+n*l,e[2]=r*h+s*c,e[3]=a*h+n*c,e}function la(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e}function ha(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}let ca=oa,da=ha;Object.freeze({__proto__:null,copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},set:function(e,t,i,r,a){return e[0]=t,e[1]=i,e[2]=r,e[3]=a,e},transpose:function(e,t){if(e===t){const i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},invert:function(e,t){const i=t[0],r=t[1],a=t[2],s=t[3];let n=i*s-a*r;return n?(n=1/n,e[0]=s*n,e[1]=-r*n,e[2]=-a*n,e[3]=i*n,e):null},adjoint:function(e,t){const i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e},determinant:function(e){return e[0]*e[3]-e[2]*e[1]},multiply:oa,rotate:function(e,t,i){const r=t[0],a=t[1],s=t[2],n=t[3],o=Math.sin(i),l=Math.cos(i);return e[0]=r*l+s*o,e[1]=a*l+n*o,e[2]=r*-o+s*l,e[3]=a*-o+n*l,e},scale:function(e,t,i){const r=t[0],a=t[1],s=t[2],n=t[3],o=i[0],l=i[1];return e[0]=r*o,e[1]=a*o,e[2]=s*l,e[3]=n*l,e},fromRotation:la,fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},str:function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},frob:function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2))},LDU:function(e,t,i,r){return e[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-e[2]*i[1],[e,t,i]},add:function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},subtract:ha,exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},equals:function(e,t){const i=e[0],r=e[1],a=e[2],s=e[3],n=t[0],o=t[1],l=t[2],h=t[3];return Math.abs(i-n)<=na.E*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(r-o)<=na.E*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(a-l)<=na.E*Math.max(1,Math.abs(a),Math.abs(l))&&Math.abs(s-h)<=na.E*Math.max(1,Math.abs(s),Math.abs(h))},multiplyScalar:function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e},multiplyScalarAndAdd:function(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e},mul:ca,sub:da});function ua(){return[1,0,0,1]}Object.freeze({__proto__:null,create:ua,clone:function(e){return[e[0],e[1],e[2],e[3]]},fromValues:function(e,t,i,r){return[e,t,i,r]},createView:function(e,t){return new Float64Array(e,t,4)}});function pa(e,t,i){const r=e.graphic,a=(e,i)=>t({action:e,graphic:r,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY});return i(((e,t,i)=>{t.next((e=>("start"===e.action&&a("start",e),e))).next((0,or.a9)(r)).next((e=>{switch(e.action){case"start":case"update":(e.translationX||e.translationY||e.translationZ)&&a("update",e);break;case"end":a("end",e)}return e})),i.next((0,or.bD)(r)).next((()=>{a("end",{screenDeltaX:0,screenDeltaY:0})}))}))}function ga(e){if((0,n.Wi)(e)||"polyline"!==e.type&&"polygon"!==e.type)return 0;const t=(0,sa.convexHull)(e),i=t&&t.rings&&t.rings[0];if(!i)return 0;!function(e){let t=0,i=0;for(const r of e)t+=r[0],i+=r[1];t/=e.length,i/=e.length;for(const r of e)r[0]-=t,r[1]-=i}(i);const r=[];for(let e=0;e<i.length-1;e++){const t=Math.atan2(i[e+1][1]-i[e][1],i[e+1][0]-i[e][0]),a=Q.c5.normalize(t)%(Math.PI/2);r.push(a)}const a=r.sort(((e,t)=>e-t));let s=null,o=0,l=Number.POSITIVE_INFINITY,h=0;for(const e of a){if(e===s)continue;s=e,la(ma,e),(0,Fe.cS)(fa);for(const e of i)(0,Re.o)(_a,e,ma),(0,Fe.Ho)(fa,_a);const t=(0,Fe.SO)(fa);((t>l?l/t:t/l)>=.99&&e<o||t<l)&&(o=e,l=t),h=Math.max(h,t)}return l/h>=.95?0:o}const ma=[1,0,0,1],fa=(0,Fe.Ue)(),_a=(0,_e.a)();class va{constructor(){this._available=!0}set location(e){this.forEachManipulator3D((t=>t.location=e))}set elevationAlignedLocation(e){this.forEachManipulator3D((t=>t.elevationAlignedLocation=e))}set elevationInfo(e){this.forEachManipulator3D((t=>t.elevationInfo=e))}get available(){return this._available}set available(e){this._available=e,this.forEachManipulator3D((t=>t.available=e))}get grabbing(){return this.someManipulator((e=>e.grabbing))}get dragging(){return this.someManipulator((e=>e.dragging))}hasManipulator(e){return this.someManipulator((t=>t===e))}someManipulator(e){let t=!1;return this.forEachManipulator((i=>{!t&&e(i)&&(t=!0)})),t}forEachManipulator3D(e){this.forEachManipulator(((t,i)=>{t instanceof vr&&e(t,i)}))}}function ya(e,t){const i=(0,j.c)(),r=(0,j.c)();let a=!1;return s=>{if("start"===s.action){const r=(0,Ce.md)(s.screenStart,(0,Ce.c$)(lr.qW.get())),o=De.kx.fromScreen(e.state.camera,r,Ca);(0,n.pC)(o)&&(a=De.yC.intersectRay(t,o,i))}if(!a)return null;const o=(0,Ce.md)(s.screenEnd,(0,Ce.c$)(lr.qW.get())),l=De.kx.fromScreen(e.state.camera,o,Ca);return(0,n.Wi)(l)?null:De.yC.intersectRay(t,l,r)?{...s,renderStart:i,renderEnd:r,plane:t,ray:l}:null}}function wa(e,t,i,r=null){return function(e,t,i,r=null){let a=null;return s=>{if("start"===s.action&&(a=e.sceneIntersectionHelper.intersectElevationFromScreen((0,Ce.s1)(s.screenStart.x,s.screenStart.y),t,i),(0,n.pC)(a)&&(0,n.pC)(r)&&!(0,k.nF)(a,a,r)))return null;if((0,n.Wi)(a))return null;const o=e.sceneIntersectionHelper.intersectElevationFromScreen((0,Ce.s1)(s.screenEnd.x,s.screenEnd.y),t,i);return(0,n.pC)(o)?(0,n.pC)(r)&&!(0,k.nF)(o,o,r)?null:{...s,mapStart:a,mapEnd:o}:null}}(e,i,(0,p.Ou)(t,e,i),r)}function ba(e,t,i,r=null){return wa(e,i,(0,p.RL)(t),r)}function Ma(e,t,i){let r=null;const a=new or.hM;return a.next(ya(e,function(e,t){const i=xa,r=Sa,a=De.yC.create();e.renderCoordsHelper.worldUpAtPosition(t,i);const s=(0,U.c)(a,i,(0,U.f)(r,t,e.state.camera.eye));return(0,U.c)(s,s,i),De.yC.fromPositionAndNormal(t,s,a)}(e,t))).next(function(e,t){const i=(0,j.c)(),r=(0,U.l)(t);e.renderCoordsHelper.worldUpAtPosition(t,i);const a=(0,j.c)(),s=(0,j.c)(),n=a=>((0,U.f)(a,a,t),De.xr.projectPoint(i,a,a),"global"===e.viewingMode&&(0,U.l)(a)*(0,ne.Xx)((0,U.d)(i,a))<.001-r&&(0,U.f)(a,(0,U.a)(a,i,.001),t),(0,U.b)(a,a,t),a);return e=>(e.renderStart=n((0,U.g)(a,e.renderStart)),e.renderEnd=n((0,U.g)(s,e.renderEnd)),e)}(e,t)).next(function(e,t){const i=e.renderCoordsHelper;return e=>{const r=i.fromRenderCoords(e.renderStart,new pr.Z,t),a=i.fromRenderCoords(e.renderEnd,new pr.Z,t);return(0,n.pC)(r)&&(0,n.pC)(a)?{...e,mapStart:r,mapEnd:a}:null}}(e,i)).next((e=>{e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,r=e})),e=>(r=null,a.execute(e),r)}const xa=(0,j.c)(),Sa=(0,j.c)(),Ca=De.kx.create();class Ra extends va{constructor(e){super(),this._handles=new ge.Z,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this.createMaterial(),this._transparentMaterial=this.createMaterial(.5),this._angle=0,this._scale=1,this._radius=ea,this._updateAfterDrag=!1,this.events=new c.Z,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._handles.removeAll(),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){this._arrowManipulatorInfos.map((({manipulator:t})=>e(t,1)))}createGraphicDragPipeline(e,t){const i=e.graphic,r=(0,p.RL)(i),a=(0,n.Wg)(i.geometry).spatialReference;return pa(e,t,(e=>this.createDragPipeline(e,r,a)))}createDragPipeline(e,t,i){return(0,sr.AL)(this._arrowManipulatorInfos.map((({manipulator:r},a)=>(0,or.Xd)(r,((r,s,n,o,l)=>{const h=s.next((e=>({...e,manipulatorType:1}))).next((0,or.kY)(this._view,r.elevationAlignedLocation)).next(wa(this._view,r.elevationAlignedLocation,t,i)).next((0,or.M2)(r.location,this.angle+(a+1)*Math.PI*.5)).next((0,or.zh)());e(r,h,n,o,l)})))))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:t},i){const r=this._radius/ea,a=54*r,s=Math.sqrt(a*a*3/4),n=Pi.Z.createExtrudedTriangle(s,a/2,a/2,.02);Pi.Z.transformInPlace(n,(0,J.w)(lr.MP.get(),(0,U.s)(lr.WM.get(),0,-s/3,0)));const o=new X.Z(n,"move-xy-axis-arrow");e.renderObjects=[{geometry:o,material:this._opaqueMaterial,stateMask:2},{geometry:o,material:this._transparentMaterial,stateMask:1}],e.radius=s/3*2*1.2;const l=(0,J.i)(lr.MP.get());(0,J.x)(l,i*Math.PI/2);const h=(0,J.i)(lr.MP.get());(0,J.w)(h,(0,U.s)(lr.WM.get(),0,100*r,0)),(0,J.m)(t,l,h)}_createManipulators(){for(let e=0;e<4;e++){const t=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(t)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,t=(0,J.i)(lr.MP.get());(0,J.r)(t,t,e,(0,j.f)(0,0,1));const i=(0,J.p)(lr.MP.get(),(0,U.s)(lr.WM.get(),this.displayScale,this.displayScale,this.displayScale)),r=(0,J.i)(lr.MP.get());(0,J.m)(r,i,t);for(const e of this._arrowManipulatorInfos){const t=(0,J.m)(lr.MP.get(),r,e.transform);e.manipulator.modelTransform=t}}_createArrowManipulator(e){const t=new vr({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:(0,j.f)(0,0,1)}}),i={manipulator:t,transform:(0,ee.a)()};return this._updateArrowManipulator(i,e),this._handles.add(t.events.on("drag",(e=>{this._updateAfterDrag&&"end"===e.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),i}createMaterial(e=1){const t=v.default.toUnitRGBA(C.main);return t[3]*=e,new cr.E({color:t,transparent:1!==e,cullFace:2,renderOccluded:2},"graphic-transform")}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:e})=>e))}}}class Ea{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new or.hM,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&(0,n.pC)(this.lastDragEvent)){const t=this.lastDragEvent.mapEnd,i=this.snap(this.lastDragEvent.screenEnd);if((0,n.pC)(i)){const r={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:!0===e?i:t,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(r)}}this._enabled=e}snap(e){const t=(0,n.pC)(this.view)?this.view.toMap(e,{exclude:[]}):null;return(0,n.pC)(t)&&(0,n.pC)(this.view)&&(t.z=(0,p.Ou)(t,this.view,this.elevationInfo)),t}createDragEventPipelineStep(e,t){return this.view=e,this.elevationInfo=t,this.lastDragEvent=null,e=>{if(this.lastDragEvent="end"!==e.action?{...e}:null,this._enabled){const t=this.snap(e.screenEnd);return(0,n.pC)(t)?{action:e.action,mapStart:e.mapStart,mapEnd:t,screenStart:e.screenStart,screenEnd:e.screenEnd}:null}return{action:e.action,mapStart:e.mapStart,mapEnd:e.mapEnd,screenStart:e.screenStart,screenEnd:e.screenEnd}}}}class Da extends va{constructor(e){super(),this._handles=new ge.Z,this._snapToScene=new Ea,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=ea,this._view=e.view,this._tool=e.tool,null!=e.snapToScene&&(this.snapToScene=e.snapToScene),null!=e.radius&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,1)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,t){const i=e.graphic,r=(0,p.RL)(i),a=(0,n.Wg)(i.geometry).spatialReference;return pa(e,t,(e=>this.createDragPipeline(e,r,a)))}createDragPipeline(e,t,i){const r=this._view;return(0,or.Xd)(this._manipulator,((a,s,n,o,l)=>{const h=s.next((0,or.kY)(r,a.elevationAlignedLocation)).next(wa(r,a.elevationAlignedLocation,t,i)).next(this._snapToScene.createDragEventPipelineStep(r,t),this._snapToScene.next).next((e=>({...e,manipulatorType:1}))).next((0,or.zh)());e(a,h,n,o,l)}))}_updateManipulatorTransform(){const e=(0,J.p)(lr.MP.get(),(0,U.s)(lr.WM.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new vr({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:(0,j.f)(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=new X.Z(Pi.Z.createCylinderGeometry(.02,1,128,(0,j.f)(0,0,1),(0,j.f)(0,0,0)),"graphic-transform-disc"),t=(0,J.p)((0,ee.a)(),(0,j.f)(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:t,stateMask:2},{geometry:e,material:this._discMaterialTransparent,transform:t,stateMask:1}],this._manipulator.radius=this._radius/ea*80}_createMaterial(e=1){const t=v.default.toUnitRGBA(C.main);return t[3]*=e,new cr.E({color:t,transparent:1!==e,cullFace:2,renderOccluded:2},"move-xy-disc")}get test(){return{discManipulator:this._manipulator}}}class Oa extends va{constructor(e){super(),this._handles=new ge.Z,this._radius=ea,this.events=new c.Z,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this.createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()}))}forEachManipulator(e){e(this._manipulator,0)}createGraphicDragPipeline(e,t){const i=(0,n.Wg)(e.graphic.geometry).spatialReference;return pa(e,t,(e=>this.createDragPipeline(e,i)))}createDragPipeline(e,t){const i=this._view;return(0,or.Xd)(this._manipulator,((r,a,s,n,o)=>{const l=a.next((e=>({...e,manipulatorType:0}))).next(Ma(i,r.renderLocation,t)).next((0,or.zh)());e(r,l,s,n,o)}))}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this.updateManipulator())}updateManipulator(){const e=this._radius/ea,t=F.zManipulator.height*e,i=F.zManipulator.coneHeight*e,r=F.zManipulator.coneWidth*e,a=F.zManipulator.width*e,s=[(0,j.f)(0,0,0),(0,j.f)(0,0,t)],n=new X.Z(Pi.Z.createTubeGeometry(s,a/2,16,!1),"move-z"),o=Pi.Z.createConeGeometry(i,r/2,16,!1),l=new X.Z(o),h=[(0,j.f)(0,0,0),(0,j.f)(0,0,t+i)],c=(e=>{const i=(0,ee.a)();return(0,J.t)(i,i,[0,0,t]),(0,J.e)(i,i,Math.PI/2),i})(),d=(e,t)=>{const i=(0,y._j)(F.zManipulator.color,t);return[i.r/255,i.g/255,i.b/255,F.zManipulator.color.a*e]},u=Lr(d(1,.25),1),p=Lr(d(1,0),1),g=Lr(d(.7,0),F.zManipulator.renderOccluded),m=Lr(d(.85,0),F.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:l,transform:c,material:u,stateMask:1},{geometry:n,material:u,stateMask:1},{geometry:l,transform:c,material:p,stateMask:2},{geometry:n,material:p,stateMask:2},{geometry:l,transform:c,material:g,stateMask:1},{geometry:n,material:g,stateMask:1},{geometry:l,transform:c,material:m,stateMask:2},{geometry:n,material:m,stateMask:2}],this._manipulator.radius=a/2+2,this._manipulator.collisionType={type:"line",paths:[h]}}createManipulator(){const e=new vr({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=e=>{const t=this._view.state.camera,i=Ta;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const r=(0,U.w)(t.eye,i),a=t.computeRenderPixelSizeAtDist(r),s=(0,U.f)(Pa,i,t.eye);(0,U.n)(s,s);const n=Aa;this._view.renderCoordsHelper.worldUpAtPosition(Ta,n);const o=Math.abs((0,U.d)(s,n)),l=(0,U.c)(Pa,s,n),h=(0,U.c)(Pa,l,n),c=(0,ne.uZ)(o,.01,1),d=1-Math.sqrt(1-c*c)/c/t.fullWidth,u=this._radius/ea,p=F.zManipulator.width*u;(0,U.a)(h,(0,U.n)(h,h),(1/d-1)*r+a*p),e[12]-=Pa[0],e[13]-=Pa[1],e[14]-=Pa[2]},this._manipulator=e,this.updateManipulator()}}const Ta=(0,j.c)(),Pa=(0,j.c)(),Aa=(0,j.c)();class Ia extends va{constructor(e){super(),this._handles=new ge.Z,this._angleDeferred=null,this._interactive=!0;const{tool:t,view:i,snapToScene:r,radius:a}=e;this._view=i,this.xyManipulation=new Da({tool:t,view:i,snapToScene:r,radius:a}),this.xyAxisManipulation=new Ra({tool:t,view:i,radius:a}),this.zManipulation=new Oa({tool:t,view:i,radius:a}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this.autoHideXYAxis(),this.forEachManipulator((e=>{this._handles.add(e.events.on("grab-changed",(()=>this.updateManipulatorInteractivity())))}))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,t){return(0,sr.AL)([this.xyManipulation.createGraphicDragPipeline(e,t),this.xyAxisManipulation.createGraphicDragPipeline(e,t),this.zManipulation.createGraphicDragPipeline(e,t)])}createDragPipeline(e,t,i){return(0,sr.AL)([this.xyManipulation.createDragPipeline(e,t,i),this.xyAxisManipulation.createDragPipeline(e,t,i),this.zManipulation.createDragPipeline(e,i)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}set angleDeferred(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this.updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator((t=>e(t,1))),this.xyAxisManipulation.forEachManipulator((t=>e(t,1))),this.zManipulation.forEachManipulator((t=>e(t,0)))}get xyAxisVisible(){const e=this.xyManipulation.someManipulator((e=>e.focused))||this.xyAxisManipulation.someManipulator((e=>e.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||e}autoHideXYAxis(){const e=this.xyAxisManipulation,t=this.xyManipulation;if((0,s.Z)("esri-mobile"))return;const i=[];t.forEachManipulator((e=>i.push(e))),e.forEachManipulator((e=>i.push(e)));const r=()=>{const t=[];this.xyAxisVisible?(0,n.pC)(this._angleDeferred)&&(this.angle=this._angleDeferred()):e.forEachManipulator((e=>t.push(e.disableDisplay()))),this._handles.remove(La),this._handles.add(t,La)};for(const e of i)this._handles.add(e.events.on("focus-changed",r));this._view.inputManager&&this._handles.add(this._view.inputManager.watch("latestPointerType",r)),r()}updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator((t=>{t.interactive=!e&&this._interactive||t.grabbing}))}static radiusForSymbol(e){const t=(0,n.pC)(e)&&"point-3d"===e.type&&e.symbolLayers;return t&&t.length>0&&t.some((e=>"icon"===e.type))?ta:ea}}const La="disable-xy-axis-display";var Ga=i(65865);class Va extends va{constructor(e){super(),this._handles=new ge.Z,this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,1)}createGraphicDragPipeline(e){return pa(this._graphicState,e,(e=>this.createDragPipeline(e)))}createDragPipeline(e){const t=this._view,i=this._graphicState.graphic,r=(0,n.pC)(i.geometry)?i.geometry.spatialReference:null;return(0,or.Xd)(this._manipulator,((a,s,o,l,h)=>{const c=s.next(function(e,t,i,r){const a=t.toMap(e.screenStart,{include:[i]});return(0,n.pC)(a)?ba(t,i,a,r):null}(h,t,i,r)).next((0,or.AN)()).next((0,or.zh)());e(a,c,o,l,h)}))}_createManipulator(){const e=this._view,t=this._graphicState.graphic;this._manipulator=new Ga.L({graphic:t,view:e,selectable:!0,cursor:"move"})}}class za{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class Ha{constructor(e,t,i){this.dx=e,this.dy=t,this.allGraphics=i,this.type="graphic-move"}}class Wa{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let Fa=class extends(c.Z.EventedMixin(m.m)){constructor(e){super(e),this.graphics=new nr.Z,this.enableZ=!0,this.type="move-3d",this._toolHandles=new ge.Z,this._handles=new ge.Z}initialize(){this._toolHandles.add([this.graphics.on("change",(()=>this._refreshManipulators()))]),this._refreshManipulators()}destroy(){this._handles.destroy(),this._handles=null,this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)}reset(){}_refreshManipulators(){this._handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter((e=>0===(0,Wr.P)(e))).map((e=>new ja(e)));e.length&&(this.createManipulators(e),this.createVisualElements(e),this._handles.add(e.map((e=>this.view.trackGraphicState(e.state)))),this.updateMoveManipulation(e))}createManipulators(e){for(const t of e){const i=t.state;t.manipulationXY=new Va({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator((e=>this._handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:i.graphic}),e.stopPropagation()}))))),this._handles.add(t.manipulationXY.createDragPipeline(((t,i,r)=>this.buildDragEventPipeline(t,i,r,e))))}this.createMoveManipulation(e)}createMoveManipulation(e){const t=new Ia({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===e.length?Ia.radiusForSymbol(e[0].graphic.symbol):ea});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator((e=>{this._handles.add(e.events.on("immediate-click",(i=>{t.zManipulation.hasManipulator(e)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.getItemAt(0)}),i.stopPropagation()})))}));const i=()=>this.updateMoveManipulation(e);for(const t of e)this._handles.add([t.state.on("changed",i),t.state.watch("displaying",i)]);const r=e[e.length-1];this._handles.add(r.state.on("changed",(()=>this.updateMoveManipulationAngle(r)))),this._handles.add(t.createDragPipeline(((t,i,r)=>{this.buildDragEventPipeline(t,i,r,e)}),(0,p.RL)(r.graphic),(0,n.Wg)(r.graphic.geometry).spatialReference)),this.updateMoveManipulationAngle(r)}createVisualElements(e){for(const t of e){const i=t.graphic,r=Qr({view:this.view,graphic:i,forEachManipulator:e=>{t.manipulationXY.forEachManipulator(e),this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>(0,sr.kB)()});t.geometryRepresentation=r.visualElement,t.geometryRepresentation instanceof Ei&&this._handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",(()=>{t.state.isDraped||this.updateMoveManipulation(e)})),t.state.watch("isDraped",(()=>this.updateMoveManipulation(e)))]),this._handles.add(r)}}updateMoveManipulationAngle(e){this._moveManipulation.angleDeferred=()=>ga(e.graphic.geometry)}updateMoveManipulation(e){const t=(0,B.Tx)(0,0,0,this.view.spatialReference);let i=0,r=!1;const a=this._moveManipulation;for(const a of e){if(!a.state.displaying)continue;const e=a.state.graphic;this.enableZ&&Fr(e)&&(r=!0);const s=a.geometryRepresentation instanceof Ei&&!a.state.isDraped?a.geometryRepresentation.attachmentOrigin:zr(this.view,e);(0,n.pC)(s)&&(t.x+=s.x,t.y+=s.y,t.z+=s.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,a.location=t,a.xyManipulation.available=!0,a.xyAxisManipulation.available=!0,a.zManipulation.available=r):a.available=!1}buildDragEventPipeline(e,t,i,r){const a=[],s=[];let n=null,o=null;const l=()=>{for(const e of a)e.dragging=!1;a.length=0,s.length=0,n=null,o=null,this._moveManipulation.interactive=!0};t.next((t=>{if("start"===t.action){a.length=0,s.length=0;for(const t of r)t.dragging||!t.manipulationXY.hasManipulator(e)&&t.manipulationXY.grabbing||(a.push(t),s.push(t.graphic),t.dragging=!0);if(0!==s.length&&(this._moveManipulation.interactive=!1,n=(0,or.oq)(s),o=(0,or.QY)(s),this.emit("graphic-move-start",new za(s)),this.destroyed))return null}return 0!==s.length?t:null})).next((e=>n(e))).next((e=>{switch(e.action){case"start":case"update":if(e.translationX||e.translationY||e.translationZ){const t=this.view.toScreen(e.mapStart),i=this.view.toScreen(e.mapEnd),r=i.x-t.x,a=i.y-t.y;if(this.emit("graphic-move",new Ha(r,a,s)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new Wa(s)),this.destroyed)return null;l()}})),i.next((e=>o(e))).next((()=>{if(this.emit("graphic-move-stop",new Wa(s)),this.destroyed)return null;l()}))}};(0,a._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],Fa.prototype,"view",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],Fa.prototype,"graphics",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],Fa.prototype,"enableZ",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],Fa.prototype,"type",void 0),Fa=(0,a._)([(0,h.j)("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],Fa);class ja{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new jr({graphic:e})}get graphic(){return this.state.graphic}}var Ua=i(91700),ka=i(37554),Na=i(3521),Za=i(87008),Ba=i(69470);let qa=class extends c.Z.EventedAccessor{constructor(e){super(e),this._vertexManipulatorMaterial=Lr(F.colorToVec4(F.reshapeManipulators.vertex.color),F.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=Gr(F.colorToVec4(F.reshapeManipulators.vertex.outlineColor),F.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=Gr(F.colorToVec4(F.reshapeManipulators.vertex.hoverOutlineColor),F.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=Lr(F.colorToVec4(F.reshapeManipulators.edge.color),F.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=Gr(F.colorToVec4(F.reshapeManipulators.edge.outlineColor),F.reshapeManipulators.edge.renderOccluded),this._selectedManipulatorMaterial=Lr(F.colorToVec4(F.reshapeManipulators.selected.color),F.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=Gr(F.colorToVec4(F.reshapeManipulators.selected.outlineColor),F.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=Gr(F.colorToVec4(F.reshapeManipulators.selected.hoverOutlineColor),F.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._handles=new ge.Z,this._manipulatorHandles=new ge.Z,this._manipulatorInfos=[],this._reshapeHelper=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=0,this._outlineVisualElement=null,this.tool=null,this.outputGeometry=null,this._vertexLaserLineVisualElement=null,this.snappingEngine=new Ba.r(e.tool.snappingOptions)}initialize(){const e=new jr({graphic:this.graphic});this._graphicState=e,this._handles.add([e.watch("displaying",(e=>{for(const t of this._manipulatorInfos)t.manipulator.available=e})),this.view.trackGraphicState(e)])}destroy(){this._clear(),this._handles.destroy(),this.snappingEngine.destroy()}get inputGeometry(){return(0,n.pC)(this._reshapeHelper)?this._reshapeHelper.geometry:null}set inputGeometry(e){this._recreateManipulators(e)}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZ(){return this.tool.enableZ}get enableMoveGraphic(){return this.tool.enableMoveGraphic}removeSelectedVertices(){const e=this._manipulatorInfos.filter((e=>e.manipulator.selected&&"vertex"===e.handle.type));this._removeVertices(e)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_clear(){this._moveManipulation=(0,n.SC)(this._moveManipulation),this._graphicMoveManipulation=(0,n.SC)(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[],this._reshapeHelper=null,this._numGrabbing=0,this._numDragging=0}_recreateManipulators(e=this.inputGeometry){if(this._clear(),(0,n.Wi)(e))return;this._reshapeHelper=new Ja(ka.XE.fromGeometry(e,this.view.viewingMode),e.type);const t=(0,p.RL)(this.graphic);for(const e of this._reshapeHelper.data.components){for(const i of e.vertices)this._createPerVertexManipulator(i,t);for(const i of e.edges)this._createPerVertexManipulator(i,t)}this._createGraphicMoveManipulators(t)}_perGraphicManipulatorDragAction(e,t){if("end"===t.action)return;const i=[],r=this._manipulatorInfos.some((e=>"vertex"===e.handle.type&&e.manipulator.selected)),a=1===e&&r,s=(0,n.Wg)(this._reshapeHelper);for(const e of this._manipulatorInfos)"vertex"===e.handle.type&&(e.manipulator.grabbing||a&&!e.manipulator.selected||((0,n.Wg)(s).moveVertices([e.handle],t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ),i.push(e.handle.pos),this._updateManipulatorPosition(e)));if(0===i.length)return;let o=0;for(const e of this._manipulatorInfos)"vertex"===e.handle.type&&o++;if(this.outputGeometry=s.geometry,i.length===o){if(this._updateEventState(1),this.destroyed)return;if(this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic}),this.destroyed)return}else{if(this._updateEventState(2),this.destroyed)return;if(this.emit("reshape",{type:"reshape",mover:this.graphic}),this.destroyed)return}}isMultiVertexSelection(){let e=0;for(const t of this._manipulatorInfos)Xa(t)&&t.manipulator.selected&&e++;return e>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(2),this.destroyed)return;const t=e.mapDeltaX,i=e.mapDeltaY,r=e.mapDeltaZ;if(!t&&!i&&!r)return;const a=[];for(const t of this._manipulatorInfos)Xa(t)&&(t.manipulator.selected&&!t.manipulator.grabbing||t===e.info)&&a.push(t);const s=(0,n.Wg)(this._reshapeHelper);for(const e of a)s.moveVertices([e.handle],t,i,r);this.outputGeometry=s.geometry;for(const e of a)this._updateManipulatorPosition(e);this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case 0:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulators(e){this._graphicMoveManipulation=new Va({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic?this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((e,t,i)=>{t.next((e=>this._trackNumDragging(e))).next((e=>{this._perGraphicManipulatorDragAction(0,e)})),i.next(this._cancelDragOperation())}))):this._graphicMoveManipulation.forEachManipulator((e=>{e.grabbable=!1,e.cursor=null})),this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click"),e.stopPropagation()}))]))),this._moveManipulation=new Ia({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Fr(this.graphic),snapToScene:!1,radius:Ia.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((e=>{this._handles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(t=>{this._moveManipulation.zManipulation.hasManipulator(e)||this._manipulatorInfos.some((e=>e.manipulator.selected))||this.emit("immediate-click"),t.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const t=(0,n.Wg)(this.graphic.geometry).spatialReference;let i=null;this._handles.add([this._moveManipulation.createDragPipeline(((t,r,a,s)=>{r.next((e=>this._trackNumDragging(e))).next((t=>{if("start"===t.action){const r=this._manipulatorInfos.filter((e=>Xa(e)&&e.manipulator.selected));if(1===t.manipulatorType&&1===r.length){const t=r[0].handle;i=new Za.N((0,n.Wg)(this._reshapeHelper),this.view,e,s,t)}}return(0,n.pC)(i)&&(t.mapEnd=this.snappingEngine.snap(t.mapEnd,i)),"end"===t.action&&(this.snappingEngine.doneSnapping(),i=null),t})).next((0,or.AN)()).next((e=>{this._perGraphicManipulatorDragAction(1,e)})),a.next(this._cancelDragOperation())}),e,t),(0,me.init)(this._graphicState,"displaying",(()=>{this._updateMoveManipulationPosition()})),this._graphicState.on("changed",(()=>this._updateMoveManipulationPosition())),(0,me.init)(this._graphicState,"isDraped",(()=>{const e="align-move-manipulation";this._graphicState.isDraped?this._handles.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):this._handles.remove(e)}))]),this._updateMoveManipulationPosition();const r=Qr({view:this.view,graphic:this.graphic,forEachManipulator:e=>{if(!this.destroyed){(0,n.pC)(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(e);for(const t of this._manipulatorInfos)e(t.manipulator,1);this._moveManipulation.forEachManipulator(e)}},onManipulatorsChanged:e=>this.on("manipulators-changed",e)});this._outlineVisualElement=r.visualElement instanceof Ei?r.visualElement:null,(0,n.pC)(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(()=>this._updateMoveManipulationPosition()))]),this._manipulatorHandles.add(r)}_createPerVertexManipulator(e,t=(0,p.RL)(this.graphic)){if((0,n.Wi)(this._vertexManipulatorGeometry)||(0,n.Wi)(this._vertexManipulatorOutlineGeometry)){const e=F.reshapeManipulators.vertex,t=e.size/2,i=t+e.collisionPadding,r=t/i;this._vertexManipulatorGeometry=new X.Z(Pi.Z.createSphereGeometry(r,16,16),"reshape-manipulator");const a=(t+e.outlineSize)/i;this._vertexManipulatorOutlineGeometry=new X.Z(Pi.Z.createSphereGeometry(a,16,16),"reshape-manipulator-outline")}if((0,n.Wi)(this._edgeManipulatorGeometry)||(0,n.Wi)(this._edgeManipulatorOutlineGeometry)){const e=F.reshapeManipulators.edge,t=e.size/2,i=t+e.collisionPadding,r=t/i;this._edgeManipulatorGeometry=new X.Z(Pi.Z.createSphereGeometry(r,16,16),"reshape-manipulator");const a=(t+e.outlineSize)/i;this._edgeManipulatorOutlineGeometry=new X.Z(Pi.Z.createSphereGeometry(a,16,16),"reshape-manipulator-outline")}const i=new vr({view:this.view,renderObjects:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:4|Qa.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:5|Qa.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|Qa.Vertex},{geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:6|Qa.Edge},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|Qa.Edge},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:5|Qa.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:5|Qa.Edge},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:9},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:10}],elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(i,e,t);const r="edge"===e.type?{manipulator:i,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:i,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(r),this.manipulators.add(i),this._updateManipulatorPosition(r),"edge"===r.type){const e=this._getManipulatorInfoFromHandle(r.handle.left).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(r))),t=this._getManipulatorInfoFromHandle(r.handle.right).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(r)));r.locationUpdateHandle=(0,sr.AL)([e,t]),this._manipulatorHandles.add(r.locationUpdateHandle,i)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(i,!0),i);const a=(0,or.Xd)(i,((e,i,a,s)=>{i.next((e=>this._trackNumDragging(e))).next((e=>$a(r)?{...e,info:this._splitEdgeManipulator(r)}:{...e,info:r})).next((0,or.kY)(this.view,e.elevationAlignedLocation)).next(ba(this.view,this.graphic,e.elevationAlignedLocation,e.location.spatialReference)).next(this._snapDrag(t,s)).next((0,or.AN)()).next((e=>{this._perVertexManipulatorDragAction(e)})),a.next(this._cancelDragOperation())}));return this._manipulatorHandles.add(a,i),this._manipulatorHandles.add([i.events.on("immediate-click",(e=>this._manipulatorClickCallback(e,r))),i.events.on("select-changed",(()=>{r.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}))]),this.emit("manipulators-changed"),i}_snapDrag(e,t){let i=null;const r=(0,n.Wg)(this._reshapeHelper);return a=>{if("start"===a.action&&(this.isMultiVertexSelection()||(i={context:new Za.N(r,this.view,e,t,a.info.handle),originalPos:r.data.coordinateHelper.createDehydratedPoint(a.info.handle.pos)})),(0,n.pC)(i)){const e={...i.originalPos};e.x+=a.mapEnd.x-a.mapStart.x,e.y+=a.mapEnd.y-a.mapStart.y;const t=this.snappingEngine.snap(e,i.context);a.mapEnd.x=t.x+(a.mapStart.x-i.originalPos.x),a.mapEnd.y=t.y+(a.mapStart.y-i.originalPos.y)}return"end"===a.action&&(this.snappingEngine.doneSnapping(),i=null),a}}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_cancelDragOperation(){const e=(0,n.pC)(this._reshapeHelper)?this._reshapeHelper.geometry.clone():null;return()=>{switch(this._numDragging--,this.inputGeometry=e,this.outputGeometry=e,this.snappingEngine.doneSnapping(),this._reshapeEventState){case 0:break;case 1:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape",mover:this.graphic})}this.destroyed||this._updateEventState(0)}}_setTypeSpecificManipulatorSettings(e,t,i){switch(t.type){case"vertex":e.state=Qa.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=F.reshapeManipulators.vertex.size/2+F.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i;break;case"edge":e.state=Qa.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=F.reshapeManipulators.edge.size/2+F.reshapeManipulators.edge.collisionPadding,e.elevationInfo="on-the-ground"===i.mode?i:{mode:"absolute-height",offset:0}}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",(i=>{if("start"===i.action)t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(0),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing}))}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e)for(const t of this._manipulatorInfos)if(e===t.handle)return t;return null}_updateManipulatorPosition(e){if(!e)return;const t=(0,n.Wg)(this._reshapeHelper);if("vertex"===e.handle.type)e.manipulator.location=t.data.coordinateHelper.toPoint(e.handle.pos,Ka),e.manipulator.grabbing&&(0,n.pC)(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.handle.type){const i=this._getManipulatorInfoFromHandle(e.handle.left).manipulator,r=this._getManipulatorInfoFromHandle(e.handle.right).manipulator;if((0,n.pC)(e.manipulator.elevationInfo)&&"on-the-ground"===e.manipulator.elevationInfo.mode){const a=i.location,s=r.location,n=.5,o=a.x+n*(s.x-a.x),l=a.y+n*(s.y-a.y),h=a.hasZ&&s.hasZ?0:void 0;e.manipulator.location=(0,B.Tx)(o,l,h,t.geometry.spatialReference)}else{const a=i.elevationAlignedLocation,s=r.elevationAlignedLocation,n=.5,o=a.x+n*(s.x-a.x),l=a.y+n*(s.y-a.y),h=a.hasZ&&s.hasZ?a.z+n*(s.z-a.z):void 0;e.manipulator.elevationAlignedLocation=(0,B.Tx)(o,l,h,t.geometry.spatialReference)}}}_splitEdgeManipulator(e){const t=(0,n.Wg)(this._reshapeHelper),i=(0,n.Wg)(t.splitEdge(e.handle,.5).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const r=e;r.handle=i,r.type="vertex";const a=(0,p.RL)(this.graphic);this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,a),i.left&&this._createPerVertexManipulator(i.left),i.right&&this._createPerVertexManipulator(i.right),this.outputGeometry=t.geometry,this._updateManipulatorPosition(r),this._updateSelection(e.manipulator);const s=this._updateEventState(2),o=t.data.coordinateHelper.toArray(r.handle.pos),l=t.data.components.indexOf(i.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:o,componentIndex:l,vertexIndex:(0,n.Wg)(i.index)}],added:o}),s&&this._updateEventState(0),r}_updateMoveManipulationPosition(){const e=lr.WM.get();(0,U.s)(e,0,0,0);let t=0,i=!1,r=null,a=null;for(const s of this._manipulatorInfos)Xa(s)&&(s.manipulator.selected?(t++,(0,U.b)(e,e,s.manipulator.renderLocation),(0,n.Wi)(r)||s.selectedIndex>r.selectedIndex?(a=r,r=s):((0,n.Wi)(a)||s.selectedIndex>a.selectedIndex)&&(a=s)):i=!0);if(0!==t){const e=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZ&&Fr(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==t}else{const e=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZ&&Fr(this.graphic)}if(0!==t){let e=0;if((0,n.pC)(r)){const t=r.handle.pos,i=(0,n.pC)(a)?a.handle.pos:r.handle.left&&r.handle.left.left?r.handle.left.left.pos:null,s=!(0,n.pC)(a)&&r.handle.right&&r.handle.right.right?r.handle.right.right.pos:null;i&&s?this._moveManipulation.xyAxisManipulation.available=!1:i?e=Ya(i,t):s&&(e=Ya(t,s))}this._moveManipulation.angle=e,this._moveManipulation.radius=ta}else this._moveManipulation.angleDeferred=()=>ga((0,n.Wg)(this.graphic.geometry)),this._moveManipulation.radius=Ia.radiusForSymbol(this.graphic.symbol);0!==t&&i?((0,U.a)(e,e,1/t),Ka.spatialReference=(0,n.Wg)(this._reshapeHelper).geometry.spatialReference,Ka.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,Ka),this._moveManipulation.elevationAlignedLocation=Ka):(0,n.pC)(this._outlineVisualElement)&&!this._graphicState.isDraped&&(0,n.pC)(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:Hr(this.view,this._moveManipulation,this.graphic)}_removeVertices(e){const t=[],i=(0,n.Wg)(this._reshapeHelper);for(const r of e)if("vertex"===r.handle.type&&i.canRemoveVertex()){t.push(r.handle),this._removeManipulator(r),this._removeManipulator(this._getManipulatorInfoFromHandle(r.handle.left)),this._removeManipulator(this._getManipulatorInfoFromHandle(r.handle.right));const e=(0,n.Wg)(i.removeVertices([r.handle]).removedVertices[0].createdEdge);e&&this._createPerVertexManipulator(e)}if(t.length>0){const e=t.map((e=>{const t=i.data.components.indexOf(e.component);return{coordinates:i.data.coordinateHelper.toArray(e.pos),componentIndex:t,vertexIndex:(0,n.Wg)(e.index)}}));this.outputGeometry=i.geometry;const r=this._updateEventState(2);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:e.map((e=>e.coordinates)),vertices:e}),this.destroyed)return;if(r&&(this._updateEventState(0),this.destroyed))return;this._updateMoveManipulationPosition()}}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.handle.type&&(t.manipulator.selected=!t.manipulator.selected),"vertex"===t.handle.type&&2===e.button&&this._removeVertices([t]),$a(t)&&0===e.button&&this._splitEdgeManipulator(t),e.stopPropagation()}};function Ya(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function Xa(e){return"vertex"===e.handle.type}function $a(e){return"edge"===e.handle.type}(0,a._)([(0,l.Cb)({constructOnly:!0})],qa.prototype,"tool",void 0),(0,a._)([(0,l.Cb)()],qa.prototype,"inputGeometry",null),(0,a._)([(0,l.Cb)()],qa.prototype,"outputGeometry",void 0),qa=(0,a._)([(0,h.j)("esri.views.3d.interactive.editingTools.graphicReshape3D.ReshapeOperation")],qa);const Ka=(0,B.Tx)(0,0,null,null);var Qa;!function(e){e.Vertex=16,e.Edge=32}(Qa||(Qa={}));class Ja extends Na.hE{constructor(e,t){super(e,t),this.type=t,this._geometry=null}get geometry(){if(this._dirty){switch(this.type){case"polyline":this._geometry=this.data.toPolyline();break;case"polygon":this._geometry=this.data.toPolygon()}this._dirty=!1}return this._geometry}}let es=class extends(c.Z.EventedMixin(m.m)){constructor(e){super(e),this._handles=new ge.Z,this._reshapeOperation=null,this._internalGeometryUpdate=!1,this.enableZ=!0,this.enableMoveGraphic=!0,this.type="reshape-3d",this.snappingOptions=new f.g}destroy(){this._handles.removeAll(),this._reshapeOperation&&(this._reshapeOperation.destroy(),this._reshapeOperation=null),this._set("view",null),this._set("graphic",null)}get selectionManagementDisabled(){return!0}_updateGeometry(){const e=this.graphic.geometry;0!==(0,Ua.P)(this.graphic)||!(0,n.pC)(e)||"polygon"!==e.type&&"polyline"!==e.type?this._reshapeOperation.inputGeometry=null:this._reshapeOperation.inputGeometry=e.clone()}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),0!==(0,Ua.P)(this.graphic))return;const e=this.watch("graphic.geometry",(()=>{!1===this._internalGeometryUpdate&&this._updateGeometry()}),!0);this._handles.add(e,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_onReshapeGeometryChanged(){(0,n.Wi)(this.graphic)||(this._internalGeometryUpdate=!0,this.graphic.geometry=this._reshapeOperation.outputGeometry.clone(),this._internalGeometryUpdate=!1)}initialize(){this._reshapeOperation=new qa({tool:this}),this._handles.add([this._reshapeOperation.on("reshape",(e=>{"reshape"===e.type&&this._onReshapeGeometryChanged(),this.emit("reshape",e)})),this._reshapeOperation.on("move",(e=>{"move"===e.type&&this._onReshapeGeometryChanged(),this.emit("move",e)})),this._reshapeOperation.on("vertex-add",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",e)})),this._reshapeOperation.on("vertex-remove",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",e)})),this._reshapeOperation.on("immediate-click",(()=>this.emit("immediate-click"))),(0,me.init)(this,"graphic",(()=>{this._updateGraphic()}),!0)])}beforeUndo(){this._reshapeOperation.snappingEngine.doneSnapping()}onInputEvent(e){"key-down"!==e.type||"Delete"!==e.key&&"Backspace"!==e.key||this._reshapeOperation.removeSelectedVertices()}reset(){}};(0,a._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],es.prototype,"view",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],es.prototype,"graphic",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],es.prototype,"enableZ",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],es.prototype,"enableMoveGraphic",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],es.prototype,"type",void 0),(0,a._)([(0,l.Cb)()],es.prototype,"snappingOptions",void 0),es=(0,a._)([(0,h.j)("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],es);var ts,is=i(74386);!function(e){e.ScaleIn=32,e.ScaleOut=64,e.RotateLeft=128,e.RotateRight=256,e.Unlocked=1024,e.DelayedFocused=2048,e.TouchInput=32768}(ts||(ts={}));class rs{constructor(e){this.mode=null,this._handles=new ge.Z,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new c.Z,this.getFocused=()=>this.ringManipulator.focused,this.getScale=()=>(0,n.pC)(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this._scaleRotateDragData.scale:1,this.tool=e.tool,this.mode=e.mode,this.createManipulator(),this.updateDragState(),this.updateManipulatorTransform()}destroy(){(0,n.pC)(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles.removeAll(),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null}startAnimation(e){this.cancelActiveAnimation(),e.start();const t=(0,is.A)({update:({deltaTime:t})=>{e.update(t)&&this.cancelActiveAnimation()}});this._activeAnimation={...e,frameTask:t}}cancelActiveAnimation(){(0,n.pC)(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation.destroy(),this._activeAnimation=null)}forEachManipulator(e){e(this.ringManipulator,2)}createManipulator(){this.ringManipulator=this.createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);const e=this.ringManipulator,t=this.tool.graphicState.graphic,i=(0,or.Xd)(e,((e,i,r)=>{this._scaleRotateDragData=null;const a=function(e,t){const i=e.allLayerViews.find((e=>e.layer===t.layer));if((0,n.Wi)(t.symbol))return null;const r=t.symbol;return{symbolLayers:r.symbolLayers.map((e=>{let t=null,a=null;return"object"===e.type&&(t=e.heading),a=i.getSymbolLayerSize(r,e),{heading:t,size:a}})).toArray()}}(this.tool.view,t);if((0,n.Wi)(a))return this.updateDragState(),null;const s={mode:"none",origin:(0,j.b)(e.renderLocation),angle:0,startAngle:this.tool.symbolRotationAngle,angleDir:0,scale:1,scaleDir:0,startSymbolData:a};this._scaleRotateDragData=s,this.updateDragState();const o=lr.WM.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(e.renderLocation,o),i.next(ya(this.tool.view,De.yC.fromPositionAndNormal(e.renderLocation,o))).next((e=>{const i=De.yC.normal(e.plane),r=Vr(e.renderStart,e.renderEnd,s.origin,i),a=Q.Q4.shortestSignedDiff(s.angle,r);s.angleDir=(0,ne.uZ)(s.angleDir+a,-.3,.3),s.angle=r;const o=function(e,t){const i=(0,U.f)(lr.WM.get(),t.renderStart,e.origin),r=(0,U.f)(lr.WM.get(),t.renderEnd,e.origin),a=(0,U.l)(i),s=(0,U.l)(r);return 0===a?0:s/a}(s,e),l=o-s.scale;if(s.scaleDir=(0,ne.uZ)(s.scaleDir+l,-.2,.2),s.scale=o,this.onScaleChanged(),"none"===s.mode){const i=this.mode||function(e,t,i,r){const{renderStart:a,renderEnd:s}=e,n=as(a,r,lr.WM.get()),o=as(s,r,lr.WM.get());if((0,U.h)(n,o)<100)return null;const l=(0,U.f)(lr.WM.get(),a,i),h=(0,U.c)(lr.WM.get(),l,t),c=a,d=(0,U.b)(lr.WM.get(),c,h),u=as(i,r,lr.WM.get()),p=n,g=as(d,r,lr.WM.get()),m=(0,U.f)(lr.WM.get(),g,p),f=(0,U.f)(lr.WM.get(),n,u),_=De.kx.wrap(p,m),v=De.kx.wrap(u,f);return De.kx.distance2(_,o)<De.kx.distance2(v,o)?"rotate":"scale"}(e,e.plane,s.origin,this.tool.view.state.camera);if((0,n.pC)(i)){switch(i){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:t,angle:s.angle});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:t,scale:s.scale})}s.mode=i}}if(this.updateDragState(),(0,n.pC)(t.symbol)){const e=t.symbol.clone();let i=0,r=1;switch(s.mode){default:case"none":break;case"scale":r=s.scale;break;case"rotate":i=s.angle}this.applySymbolData(e,s.startSymbolData,i,r),t.symbol=e,this.updateManipulatorTransform()}switch(e.action){case"start":case"update":switch(s.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:t,angle:s.angle});break;case"scale":this.tool.emit("graphic-scale",{graphic:t,scale:s.scale})}break;case"end":switch(s.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:s.angle});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,scale:s.scale});break;default:case"none":}}"end"===e.action&&(this.startAnimation(ss(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null,this.updateDragState())})),r.next((0,or.nh)(t)).next((()=>{if((0,n.pC)(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:this._scaleRotateDragData.startAngle});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,scale:1})}this.startAnimation(ss(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null}}))}));this._handles.add(i),this._handles.add([this.ringManipulator.events.on("focus-changed",(e=>{"focus"===e.action?this.startAnimation(function(e,t){let i=0,r=null;const a=()=>!1;return{start:()=>{r=e.getFocused,e.getFocused=a,i=0,t()},update:e=>(i+=e,!r()||i>200?1:0),destroy:()=>{e.getFocused=r,t()}}}(this,(()=>this.updateDelayedFocusedState()))):this.updateDelayedFocusedState()})),this.ringManipulator.events.on("immediate-click",(e=>{e.stopPropagation()})),(0,me.init)(this.tool.graphicState,"displaying",(e=>this.ringManipulator.available=e)),this.tool.graphicState.on("changed",(()=>Hr(this.tool.view,this.ringManipulator,t)))]),Hr(this.tool.view,this.ringManipulator,t)}onScaleChanged(){this.events.emit("scale-changed"),this.updateManipulatorTransform()}updateDelayedFocusedState(){this.ringManipulator.updateStateEnabled(ts.DelayedFocused,this.getFocused())}updateDragState(){if(this.ringManipulator.updateStateEnabled(ts.Unlocked,!((0,n.pC)(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),(0,n.pC)(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(ts.ScaleIn|ts.ScaleOut,!1),this.ringManipulator.updateStateEnabled(ts.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(ts.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(ts.RotateLeft|ts.RotateRight,!1),this.ringManipulator.updateStateEnabled(ts.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(ts.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(ts.ScaleIn|ts.ScaleOut|ts.RotateLeft|ts.RotateRight,!1)}updateManipulatorTransform(){const e=(0,J.i)(lr.MP.get()),t=this.tool.symbolRotationAngle;(0,J.r)(e,e,t,(0,j.f)(0,0,1));const i=this.getScale(),r=(0,J.p)(lr.MP.get(),(0,U.s)(lr.WM.get(),i,i,i)),a=(0,J.i)(lr.MP.get());(0,J.m)(a,r,e),this.ringManipulator.modelTransform=a}createRingManipulator(){const e=(e,t,i)=>{const r=[],a=Math.ceil(128*(t-e)/(2*Math.PI));for(let s=0;s<a+1;s++){const n=e+s*(t-e)/a;r.push((0,j.f)(i*Math.cos(n),i*Math.sin(n),0))}return r},t=t=>e(0,2*Math.PI,t),i=(e,t)=>new X.Z(Pi.Z.createPathExtrusionGeometry((e=>[[-e/2,0],[e/2,0],[e/2,.25],[-e/2,.25]])(t),e,[],[],!1),"graphic-transform-ring"),r=t(ia),a=i(r,24),s={left:[],right:[]},n=[];for(let t=0;t<2;t++){const r=t*Math.PI-Math.PI/4,a=Math.PI/2-ra,o=r+a,l=r+Math.PI/2-a,h=e(o,l,190),c=i(h,9);n.push(h),n.push(e(o,l,201)),s.left.push(c),s.right.push(c);for(let e=0;e<2;e++){const t=0===e,i=(0,ee.a)();if(t){(0,J.s)(i,i,[1,-1,1]),(0,J.r)(i,i,-o,[0,0,1]);const e=Math.round(.2*(h.length-1));i[12]=h[e][0],i[13]=h[e][1],i[14]=h[e][2]}else{(0,J.r)(i,i,l,[0,0,1]);const e=Math.round(.8*(h.length-1));i[12]=h[e][0],i[13]=h[e][1],i[14]=h[e][2]}const r=Pi.Z.createExtrudedTriangle(60,0,23,.5);Pi.Z.transformInPlace(r,i);const a=new X.Z(r,"graphic-transform-ring-rotate");(t?s.left:s.right).push(a)}}const o=[];for(let t=0;t<2;t++){const r=t*Math.PI-Math.PI/4,a=Math.PI/2-aa,s=r+a,n=r+Math.PI/2-a,l=e(s,n,213);o.push(i(l,9))}const l=t(190),h=t(213),c=i(l,9),d=i(h,9),u=t(130),g=t(107),m=i(u,9),f=i(g,9),_=this.createMaterial(),v=this.createMaterial(.66),y=this.createMaterial(.5),w=this.createMaterial(.33);let b=[{geometry:a,material:_,stateMask:ts.DelayedFocused},{geometry:a,material:y,stateMask:0}];this.mode&&"scale"!==this.mode||(b=b.concat([{geometry:o,material:_,stateMask:ts.DelayedFocused|ts.Unlocked},{geometry:c,material:v,stateMask:ts.DelayedFocused|ts.ScaleIn},{geometry:d,material:w,stateMask:ts.DelayedFocused|ts.ScaleIn},{geometry:m,material:v,stateMask:ts.DelayedFocused|ts.ScaleOut},{geometry:f,material:w,stateMask:ts.DelayedFocused|ts.ScaleOut}])),this.mode&&"rotate"!==this.mode||(b=b.concat([{geometry:s.right,material:_,stateMask:ts.DelayedFocused|ts.Unlocked},{geometry:s.left,material:_,stateMask:ts.DelayedFocused|ts.RotateLeft},{geometry:s.right,material:_,stateMask:ts.DelayedFocused|ts.RotateRight}]));const M=[r,...n];return new vr({view:this.tool.view,renderObjects:b,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:(0,p.RL)(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:M,direction:(0,j.f)(0,0,1)}})}createMaterial(e=1){const t=[...Jr,e];return new cr.E({color:t,transparent:1!==e,cullFace:2,renderOccluded:2},"graphic-transform")}applySymbolData(e,t,i,r){e.symbolLayers.forEach(((e,a)=>{const{heading:s,size:o}=t.symbolLayers[a];"object"===e.type&&(e.heading=((0,n.pC)(s)?s:0)-(0,na.a)(i),(0,n.pC)(o)&&"width"in o&&(o.width=this.enforceNonZeroSize(o.width),o.height=this.enforceNonZeroSize(o.height),o.depth=this.enforceNonZeroSize(o.depth),e.width=o.width*r,e.depth=o.depth*r,e.height=o.height*r))}))}enforceNonZeroSize(e){return e||this.tool.view.state.camera.computeRenderPixelSizeAt(this.ringManipulator.renderLocation)}get test(){return{ringManipulator:this.ringManipulator}}}function as(e,t,i){const r=t.projectToRenderScreen(e,(0,Ce.So)(ns)),a=t.renderToScreen(r,os);return(0,U.s)(i,a[0],a[1],0)}function ss(e,t){let i=null,r=1;const a=()=>r;return{start:()=>{r=e.getScale(),i=e.getScale,e.getScale=a,t()},update:e=>(r+=((r+1)/2-r)*Math.min(3*e,1),t(),Math.abs(r-1)<.01?1:0),destroy:()=>{e.getScale=i,t()}}}const ns=(0,j.c)(),os=(0,Ce.s1)();let ls=class extends(c.Z.EventedMixin(m.m)){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.type="transform-3d",this.handles=new ge.Z,this.scaleRotate=null}initialize(){if(this.graphicState=new jr({graphic:this.graphic}),this.moveManipulation=new Ia({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Fr(this.graphic),radius:Ia.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>e.stopPropagation()))))),this.moveManipulation.elevationInfo=(0,p.RL)(this.graphic),this.moveManipulation.createGraphicDragPipeline(this.graphicState,(e=>{const{action:t,graphic:i,dxScreen:r,dyScreen:a}=e,s={graphic:i,dxScreen:r,dyScreen:a};switch(t){case"start":this.emit("graphic-translate-start",s);break;case"update":this.emit("graphic-translate",s);break;case"end":this.emit("graphic-translate-stop",s)}})),this.moveManipulation.angle=this.symbolRotationAngle,this.enableScaling||this.enableRotation){const e=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new rs({tool:this,mode:e}),this.handles.add(this.scaleRotate.events.on("scale-changed",(()=>this.onScaleChanged())))}this.handles.add([Qr({view:this.view,graphic:this.graphic,forEachManipulator:e=>this.forEachManipulator(e),onManipulatorsChanged:()=>(0,sr.kB)()}),this.graphic.watch("symbol",(()=>this.updateMoveAngle())),this.graphicState.on("changed",(()=>this.onGeometryChanged())),this.hideManipulatorsForGraphicState(),this.view.watch("scale",(()=>this.updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this.onGeometryChanged()}forEachManipulator(e){this.moveManipulation.forEachManipulator(e),(0,n.pC)(this.scaleRotate)&&this.scaleRotate.forEachManipulator(e)}hideManipulatorsForGraphicState(){return this.graphicState.watch("displaying",(e=>{this.forEachManipulator((t=>t.available=e)),this.moveManipulation.zManipulation.available=e&&this.enableZ&&Fr(this.graphic)}))}destroy(){this.handles.destroy(),this.moveManipulation.destroy(),(0,n.pC)(this.scaleRotate)&&(this.scaleRotate.destroy(),this.scaleRotate=null),this._set("view",null),this._set("graphic",null)}set snapToScene(e){this.moveManipulation&&(this.moveManipulation.snapToScene=e),this._set("snapToScene",e)}get symbolRotationAngle(){const e=this.graphic.symbol;if(e){const t=e.symbolLayers.find((e=>"object"===e.type)),i=t&&t.heading||0;return(0,na.t)(-i)}return 0}reset(){}onDetach(){(0,n.pC)(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onHide(){(0,n.pC)(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onScaleChanged(){if((0,n.Wi)(this.scaleRotate))return;const e=this.scaleRotate.getScale();this.moveManipulation.displayScale=e}updateMoveAngle(){"local"===this.view.viewingMode||this.view.scale<1e6?this.moveManipulation.angle=this.symbolRotationAngle:this.moveManipulation.angle=0}onGeometryChanged(){Hr(this.view,this.moveManipulation,this.graphic)}get test(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,ringManipulator:(0,n.pC)(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}};(0,a._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],ls.prototype,"view",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],ls.prototype,"graphic",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],ls.prototype,"enableZ",void 0),(0,a._)([(0,l.Cb)()],ls.prototype,"enableRotation",void 0),(0,a._)([(0,l.Cb)()],ls.prototype,"enableScaling",void 0),(0,a._)([(0,l.Cb)({value:!1})],ls.prototype,"snapToScene",null),(0,a._)([(0,l.Cb)({readOnly:!0})],ls.prototype,"type",void 0),ls=(0,a._)([(0,h.j)("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],ls)},20147:(e,t,i)=>{"use strict";i.d(t,{A:()=>r});var r,a=i(85461);!function(e){e.builder=function(e,t){e.vertex.uniforms.add("camPos","vec3").add("perScreenPixelRatio","float").add("screenSize","float"),e.vertex.code.add(a.H`
    float computeRenderPixelSizeAt( vec3 pWorld ){
      vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
      float viewDirectionDistance = abs(dot(viewForward, pWorld - camPos));
      return viewDirectionDistance*perScreenPixelRatio;
    }

    vec3 screenSizeScaling(vec3 position, vec3 anchor){
      return position * screenSize * computeRenderPixelSizeAt(anchor) + anchor;
    }
  `)},e.bindPassUniforms=function(e,t,i){e.setUniform1f("perScreenPixelRatio",i.camera.perScreenPixelRatio),e.setUniform1f("screenSize",t.screenSize)}}(r||(r={}))},11913:(e,t,i)=>{"use strict";i.d(t,{E:()=>s,K:()=>a});var r=i(85461);function a(e){e.fragment.code.add(r.H`
    float normals2FoamIntensity(vec3 n, float waveStrength){
      float normalizationFactor =  max(0.015, waveStrength);
      return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
    }
  `)}function s(e){e.fragment.code.add(r.H`
    vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
      return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
    }
  `)}},83917:(e,t,i)=>{"use strict";i.d(t,{n:()=>a});var r=i(85461);function a(e,t){1===t.viewingMode?e.vertex.code.add(r.H`
      vec3 getLocalUp(in vec3 pos, in vec3 origin) {
          return normalize(pos + origin);
      }
    `):e.vertex.code.add(r.H`
      vec3 getLocalUp(in vec3 pos, in vec3 origin) {
          return vec3(0.0, 0.0, 1.0); // WARNING: up-axis dependent code
      }
    `),1===t.viewingMode?e.vertex.code.add(r.H`
        mat3 getTBNMatrix(in vec3 n) {
            vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
            vec3 b = normalize(cross(n, t));
            return mat3(t, b, n);
        }
    `):e.vertex.code.add(r.H`
        mat3 getTBNMatrix(in vec3 n) {
            vec3 t = vec3(1.0, 0.0, 0.0);
            vec3 b = normalize(cross(n, t));
            return mat3(t, b, n);
        }
    `)}},75619:(e,t,i)=>{"use strict";i.d(t,{P:()=>n});var r=i(85461),a=i(4071);function s(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMat","mat4"),e.fragment.uniforms.add("rpProjectionMat","mat4"),e.fragment.code.add(r.H`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy*0.5 + 0.5;
  }
  `)}function n(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("ssrViewMat","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.include(a.S),e.include(s),e.fragment.code.add(r.H`
  const int maxSteps = ${t.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}!function(e){e.bindUniforms=function(e,t,i){e.setUniform1i("lastFrameColorMap",i.lastFrameColorTextureID),t.bindTexture(i.lastFrameColorTexture,i.lastFrameColorTextureID),e.setUniformMatrix4fv("reprojectionMat",i.reprojectionMat),e.setUniformMatrix4fv("rpProjectionMat",i.camera.projectionMatrix)}}(s||(s={})),function(e){e.bindUniforms=function(e,t,i){i.ssrEnabled&&(e.setUniform1i("depthMapView",i.linearDepthTextureID),t.bindTexture(i.linearDepthTexture,i.linearDepthTextureID),e.setUniform2fv("nearFar",i.camera.nearFar),e.setUniformMatrix4fv("ssrViewMat",i.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/i.camera.height),s.bindUniforms(e,t,i))}}(n||(n={}))},53584:(e,t,i)=>{"use strict";i.d(t,{B:()=>l});var r=i(85461),a=i(75619),s=i(11913);function n(e){e.fragment.code.add(r.H`
    const float GAMMA = 2.2;
    const float INV_GAMMA = 0.4545454545;

    vec4 delinearizeGamma(vec4 color) {
      return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
    }

    vec3 linearizeGamma(vec3 color) {
      return pow(color, vec3(GAMMA));
    }
  `)}var o=i(87023);function l(e,t){e.include(o.T,t),e.include(n),e.include(s.E),t.ssrEnabled&&e.include(a.P,t),e.fragment.code.add(r.H`
    const vec3 fresnelSky =  vec3(0.02, 1.0, 15.0); // f0, f0max, exp
    const vec2 fresnelMaterial =  vec2(0.02, 0.1); // f0, f0max for specular term
    const float roughness = 0.015;
    const float foamIntensityExternal = 1.7;
    const float ssrIntensity = 0.65;
    const float ssrHeightFadeStart = 300000.0;
    const float ssrHeightFadeEnd = 500000.0;
    const float waterDiffusion = 0.775;
    const float waterSeeColorMod = 0.8;
    const float correctionViewingPowerFactor = 0.4;

    const vec3 skyZenitColor = vec3(0.52, 0.68, 0.90);
    const vec3 skyColor = vec3(0.67, 0.79, 0.9);

    PBRShadingWater shadingInfo;

    /*
    *   This function is an approximation for the sky gradient reflected
    *   the water surface and describes a combination of two fresnel terms.
    *   @parameter: cosTheta = is the result of max(dot(n,v), 0.0)
    *   @parameter: horizon = the dominant color of the sky horizon
    *   @parameter: cosTheta = the dominant color of the sky zenit
    */
    vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
      float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
      return mix(zenit, horizon, exponent);
    }

    /*
    *   This function determines the water color per pixel.
    *   @parameter: n = normal facing away from the surface
    *   @parameter: v = view direction facing away from the surface.
    *   @parameter: l = light direction facing away from the surface
    *   @parameter: lightIntensity = light intensity, currently between 0...PI
    *   @parameter: localUp = a normal for the general direction of the surface
    *   @parameter: shadow = the amount of shadow at this pixel (0 = no shadow)
    */
    vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {

      float reflectionHit = 0.;
      vec3 seaWaterColor = linearizeGamma(color);
      // using half vector to determine the specular light
      vec3 h = normalize(l + v);
      shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
      shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
      shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
      shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
      shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
      shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);

      // angle between vertex normal and view direction
      float upDotV = max(dot(localUp,v), 0.0);
      // reflected sky color: the reflected sky color consists of two main colors, the
      // reflected color at the horizon and the reflected color of the zenit.
      // the reflected sky color is then an approximation based on the fresnel term.
      vec3 skyHorizon = linearizeGamma(skyColor);
      vec3 skyZenit = linearizeGamma(skyZenitColor);
      vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );

      // we use the upDotL to smoothen out the
      // reflected color of the water
      float upDotL = max(dot(localUp,l),0.0);

      // The approximated sky color is adjusted according to the sun position.
      // This is done as approximation for e.g. night views.
      float daytimeMod = 0.1 + upDotL * 0.9;
      skyColor *= daytimeMod;

      // If a water surface is in shadow we just use a slight darkening of the
      // water surface expressed with this shadowModifier.
      float shadowModifier = clamp(shadow, 0.8, 1.0);

      // The reflected sky color consists of the fresnel reflection multiplied with the approximated sky color.
      // The shadow is influencing the frensel term to keep the shadow impression for really near views. As long
      // as reflection are absent there is a need to have a slight shadow for depth perception.
      vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
      vec3 reflSky = fresnelModifier * skyColor * shadowModifier;

      // The reflected sea color is the input water color combined with the reflected sky color.
      // The reflected sky color is modified by the incoming light.
      vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;

      vec3 specular = vec3(0.0);
      // This prevents the specular light to be rendered when:
      // - sun is behind a polygon (e.g. sundown for elevated polygons where nDotL might be still ok)
      // - viewer is under water (for this localUp is better than n)
      if(upDotV > 0.0 && upDotL > 0.0) {
        // calculate the cook torrance BRDF but with simplified occlusion
        vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);

        // Normalize light intensity to be between 0...1. Shadow cancels out specular light here
        vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;

        specular = shadingInfo.NdotL * incidentLight * specularSun;
      }

      vec3 foam = vec3(0.0);
      if(upDotV > 0.0) {
        foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
      }
      `),t.ssrEnabled?e.fragment.code.add(r.H`
      // Convert the world position to view position
      vec4 viewPosition = vec4(positionView.xyz, 1.0);
      vec3 viewDir = normalize(viewPosition.xyz);
      vec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);
      vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
      vec4 viewUp = ssrViewMat *vec4(localUp, 0.0);

      // at steeper viewing angles we use more of a vertex normal (in this case up) then the wave normal
      // this removes some artifacts of normal mapping
      float correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);
      vec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);

      vec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));

      // perform screen space reflection to detect hit
      vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
      vec3 reflectedColor = vec3(0.0);

      // if there is a hit with ssr find reflected color from the reprojeted frame
      if (hitCoordinate.z > 0.0)
      {
        vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);

        // fade out if there if the hit is near end of Y axis
        vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
        float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
        reflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;

        reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;
      }
      float seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);
      // combining reflected sky, reflected sea, specular highlight and SSR reflections.
      return tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);
    }
  `):e.fragment.code.add(r.H`
      // combining reflected sky, reflected sea, specular highlight and SSR reflections.
      return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);
    }
  `)}},91123:(e,t,i)=>{"use strict";i.d(t,{M:()=>s});var r=i(85461),a=i(11913);function s(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(a.K),e.fragment.code.add(r.H`
      const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);

      vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
        return 2.0 * texture2D(_tex, _uv).rg - 1.0;
      }

      float sampleNoiseTexture(vec2 _uv) {
        return texture2D(texWavePerturbation, _uv).b;
      }

      vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
        return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
      }

      float computeProgress(vec2 uv, float time) {
        return fract(time);
      }

      float computeWeight(vec2 uv, float time) {
        float progress = computeProgress(uv, time);
        return 1.0 - abs(1.0 - 2.0 * progress);
      }

      vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
        float flowStrength = waveParams[2];
        float flowOffset = waveParams[3];

        vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;

        float progress = computeProgress(uv, time + phaseOffset);
        float weight = computeWeight(uv, time + phaseOffset);

        vec2 result = uv;
        result -= flowVector * (progress + flowOffset);
        result += phaseOffset;
        result += (time - progress) * FLOW_JUMP;

        return vec3(result, weight);
      }

      const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
      const float TIME_NOISE_STRENGTH = 7.77;

      vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
        float waveStrength = waveParams[0];

        // overall directional shift in uv's for directional wave movement for
        // now we do a hard coded scale for wave speed such that a unit length
        // direction is not too fast.
        vec2 waveMovement = time * -_waveDir;

        float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;

        // compute two perturbed uvs and blend weights
        // then sample the wave normals at the two positions and blend
        vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
        vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);

        vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
        vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;

        // logic to flatten the wave pattern
        // scale xy components of the normal, then adjust z (up) component
        vec3 mixNormal = normalize(normal_A + normal_B);
        mixNormal.xy *= waveStrength;
        mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));

        return mixNormal;
      }

      vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
        float waveTextureRepeat = waveParams[1];
        vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
        float foam  = normals2FoamIntensity(normal, waveParams[0]);
        return vec4(normal, foam);
      }
    `)}!function(e){e.bindUniforms=function(e,t){e.setUniform1i("texWaveNormal",0),e.setUniform1i("texWavePerturbation",1),e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}}(s||(s={}))},65865:(e,t,i)=>{"use strict";i.d(t,{L:()=>w});var r=i(56140),a=(i(95830),i(59472)),s=i(36544),n=(i(68055),i(79881)),o=i(87566),l=(i(10923),i(57002),i(86035),i(79152)),h=i(35470),c=i(96071),d=i(77625),u=i(17387),p=i(28449),g=i(79710),m=i(5684),f=i(14286),_=i(46970),v=i(37694);const y=s.Z.getLogger("esri.views.interactive.GraphicManipulator");let w=class extends l.default{constructor(e){super(e),this.layer=null,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.dragging=!1,this.cursor=null,this.events=new h.Z.EventEmitter,this._circleCollisionCache=null,this._graphicSymbolChangedHandle=null,this._originalSymbol=null}set graphic(e){"mesh"!==(0,a.U2)(e.geometry,"type")?(this._circleCollisionCache=null,this._originalSymbol=e.symbol,this._set("graphic",e),this.attachSymbolChanged()):y.error("Mesh geometries are not supported")}get elevationInfo(){const e="elevationInfo"in this.graphic.layer&&this.graphic.layer.elevationInfo,t=(0,_.vu)(this.graphic),i=e?e.offset:0;return new g.Z({mode:t,offset:i})}set focusedSymbol(e){e!==this._get("focusedSymbol")&&(this._set("focusedSymbol",e),this._updateGraphicSymbol(),this._circleCollisionCache=null)}grabbableForEvent(){return!0}set grabbing(e){e!==this._get("grabbing")&&(this._set("grabbing",e),this._updateGraphicSymbol())}set hovering(e){e!==this._get("hovering")&&(this._set("hovering",e),this._updateGraphicSymbol())}set selected(e){e!==this._get("selected")&&(this._set("selected",e),this._updateGraphicSymbol(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get _focused(){return this._get("hovering")||this._get("grabbing")}destroy(){this.detachSymbolChanged(),this._resetGraphicSymbol(),this._set("view",null)}intersectionDistance(e){const t=this._get("graphic");if(!1===t.visible)return null;const i=this._get("focusedSymbol"),r=(0,a.pC)(i)?i:t.symbol,s=t.geometry;return(0,a.Wi)(s)?null:"2d"===this.view.type?this._intersectDistance2D(this.view,e,s,r):this._intersectDistance3D(this.view,e,t)}attach(){this.attachSymbolChanged(),(0,a.pC)(this.layer)&&this.layer.add(this.graphic)}detach(){this.detachSymbolChanged(),this._resetGraphicSymbol(),(0,a.pC)(this.layer)&&this.layer.remove(this.graphic)}attachSymbolChanged(){this.detachSymbolChanged(),this._graphicSymbolChangedHandle=this.graphic.watch("symbol",(e=>{(0,a.pC)(e)&&e!==this.focusedSymbol&&e!==this._originalSymbol&&(this._originalSymbol=e,this._focused&&(0,a.pC)(this.focusedSymbol)&&(this.graphic.symbol=this.focusedSymbol))}),!0)}detachSymbolChanged(){(0,a.pC)(this._graphicSymbolChangedHandle)&&(this._graphicSymbolChangedHandle.remove(),this._graphicSymbolChangedHandle=null)}_updateGraphicSymbol(){this.graphic.symbol=this._focused&&(0,a.pC)(this.focusedSymbol)?this.focusedSymbol:this._originalSymbol}_resetGraphicSymbol(){this.graphic.symbol=this._originalSymbol}_intersectDistance2D(e,t,i,r){if(r=r||(0,m.js)(i),(0,a.Wi)(r))return null;let s=this._circleCollisionCache;if("point"!==i.type||"simple-marker"!==r.type)return(0,v.D)(t,i,e)?1:null;if((0,a.Wi)(s)||!s.originalPoint.equals(i)){const t=i,a=e.spatialReference;if((0,p.Up)(t.spatialReference,a)){const e=(0,p.iV)(t,a);s={originalPoint:t.clone(),mapPoint:e,radiusPx:(0,c.F2)(r.size)},this._circleCollisionCache=s}}if((0,a.pC)(s)){const i=(0,c.md)(t,M),a=e.toScreen(s.mapPoint),n=s.radiusPx,o=a.x+(0,c.F2)(r.xoffset),l=a.y-(0,c.F2)(r.yoffset);return(0,f.j)(i,[o,l])<n*n?1:null}return null}_intersectDistance3D(e,t,i){const r=e.toMap(t,{include:[i]});return r&&(0,p.KC)(r,b,e.renderSpatialReference)?(0,u.k)(b,e.state.camera.eye):null}};(0,r._)([(0,n.Cb)({constructOnly:!0,nonNullable:!0})],w.prototype,"graphic",null),(0,r._)([(0,n.Cb)({readOnly:!0,dependsOn:["graphic"]})],w.prototype,"elevationInfo",null),(0,r._)([(0,n.Cb)({constructOnly:!0,nonNullable:!0})],w.prototype,"view",void 0),(0,r._)([(0,n.Cb)({value:null})],w.prototype,"focusedSymbol",null),(0,r._)([(0,n.Cb)({constructOnly:!0})],w.prototype,"layer",void 0),(0,r._)([(0,n.Cb)()],w.prototype,"interactive",void 0),(0,r._)([(0,n.Cb)()],w.prototype,"selectable",void 0),(0,r._)([(0,n.Cb)()],w.prototype,"grabbable",void 0),(0,r._)([(0,n.Cb)({value:!1})],w.prototype,"grabbing",null),(0,r._)([(0,n.Cb)()],w.prototype,"dragging",void 0),(0,r._)([(0,n.Cb)()],w.prototype,"hovering",null),(0,r._)([(0,n.Cb)({value:!1})],w.prototype,"selected",null),(0,r._)([(0,n.Cb)()],w.prototype,"cursor",void 0),w=(0,r._)([(0,o.j)("esri.views.interactive.GraphicManipulator")],w);const b=(0,d.c)(),M=(0,c.s1)()},37694:(e,t,i)=>{"use strict";i.d(t,{K:()=>o,D:()=>l});var r=i(59472),a=i(52937),s=(i(36348),i(93533)),n=i(83873);function o(e,t,i,n=new a.Z){let o;if("2d"===i.type)o=t*i.resolution;else if("3d"===i.type){const a=i.overlayPixelSizeInMapUnits(e),n=i.basemapSpatialReference;o=(0,r.pC)(n)&&!n.equals(i.spatialReference)?(0,s.c9)(n)/(0,s.c9)(i.spatialReference):t*a}const l=e.x-o,h=e.y-o,c=e.x+o,d=e.y+o,{spatialReference:u}=i;return n.xmin=Math.min(l,c),n.ymin=Math.min(h,d),n.xmax=Math.max(l,c),n.ymax=Math.max(h,d),n.spatialReference=u,n}function l(e,t,i){const a=i.toMap(e);return!(0,r.Wi)(a)&&o(a,(0,n.k)(),i,h).intersects(t)}const h=new a.Z}}]);
//# sourceMappingURL=9227.js.map